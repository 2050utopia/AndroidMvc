<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Android Mvc Framework by kejunxia</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Android Mvc Framework</h1>
      <h2 class="project-tagline">Android, Design Pattern, MVC, MVVM, Unit Test, Single Activity, EventBus, Android MVC Framework</h2>
      <a href="https://github.com/kejunxia/AndroidMvc" class="btn">View on GitHub</a>
      <a href="https://github.com/kejunxia/AndroidMvc/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/kejunxia/AndroidMvc/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="androidmvc-framework" class="anchor" href="#androidmvc-framework" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>AndroidMvc Framework</h1>

<p>Android Mvc framework helps Android developers implement Android projects simpler and cleaner with MVC/MVP/MVVM patterns and make them testable.</p>

<h2>
<a id="features" class="anchor" href="#features" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Features</h2>

<ul>
<li>
<a href="#-Implement-MVC/MVP/MVVM-pattern">Easy to implement MVC/MVP/MVVM pattern</a> for Android development</li>
<li>
<a href="#Life-cycles">Enhanced Android life cycles</a> - e.g. when view needs to refresh when being brought back to foreground but not on rotation, onResume() is not specific to differentiate the two scenarios. Android mvc framework provides more granular life cycles</li>
<li>
<a href="#FragmentController-Life-cycles">All fragment life cycles are mapped into FragmentController</a> thus more business logic can be moved into controllers including the ones in life cycles. Apps are more testable on JVM!</li>
<li>Easy navigation between pages. Navigation is done in controllers instead of views so navigation can be unit tested on JVM</li>
<li>Easy unit test on JVM since controllers don't depend on any Android APIs</li>
<li>Run async tasks in controllers and easy mocking of http requests</li>
<li>Built in event bus. Event bus also automatically guarantees post event view events on the UI thread</li>
<li>Automatically save and restore instance state. You don't have to touch onSaveInstance and onCreate(savedInstanceState) with countless key-value pairs, it's all managed by the framework.</li>
<li><a href="https://github.com/kejunxia/AndroidMvc/tree/master/library/poke">Dependency injection with Poke to make mock easy</a></li>
<li>Well tested - non-Android components are tested as the test coverage status <a href="https://coveralls.io/r/kejunxia/AndroidMvc"><img src="https://coveralls.io/repos/kejunxia/AndroidMvc/badge.svg" alt="Coverage Status"></a>. For Android dependent module "android-mvc", it's tested by real emulator with <a href="https://github.com/kejunxia/AndroidMvc/tree/master/library/android-mvc-test">this UI test module</a>. <strong>It's also tested with "Don't Keep Activities" turned on in dev options</strong> to guarantee your app doesn't crash due to loss of instance state after it's killed by OS in the background!</li>
</ul>

<h2>
<a id="implement-mvcmvpmvvm-pattern" class="anchor" href="#implement-mvcmvpmvvm-pattern" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Implement MVC/MVP/MVVM pattern</h2>

<p>As we know MVP and MVVM patterns are just simply derivatives of MVC pattern. All of them are targeting the same goal - Separation. </p>

<p>Separating Views and Controllers allows moving more business logic away from views into controllers. This makes code cleaner and, more importantly, it makes code more testable since most logical components are not depending on specific views. In the sense of Android, it means more fuctions can be written without depending on Android API therefore not have to be tested on emulators.</p>

<p>Since MVC, MVP and MVVM are similar, in this framework we call both <strong>Prestener</strong> in MVP and <strong>ViewModel</strong> in MVVM just as traditionally <strong>Controller</strong>. </p>

<ul>
<li>
<p><strong>Controller</strong>: A controller is a delegate for business logic of a view. Thus controllers and views have <strong>one-to-one</strong> relationship. A controller provides methods to be invoked by the view to receive user's interactions such as click and long press. Once user's input is processed in controller, the state of view would be changed. And the controller needs to notify the view the change. When the controller needs to update view, it can be done differently in MVP and MVVM pattern</p>

<ul>
<li>In <strong>MVP</strong>: controller calls the method view.update() of the view it holds to update the entire view. If the needed, the view can define more granular methods to update just a part of the entire view. For example, view.showProgressBar() or view.hideProgressBar().</li>
<li>In <strong>MVVM</strong>: controller post an event to view. View uses methods onEvent([EventClassType] event) to mointore the posted event. In the mothods the view update the UI accordingly.</li>
</ul>
</li>
<li>
<p><strong>View</strong>: A view is an Android component that can be either Fragments, Services, Notification, Activity and etc. Every view has a controller to manage its business logic. As metioned, controllers and views have <strong>one-to-one</strong> relationship. Views should not process business logic but delegate all business processes to their corespondingcontrollers.</p>

<ul>
<li>Note that, AndroidMvc is use a single Activity to host multiple fragments. Navgation is at fragment level and in the same activity.</li>
</ul>
</li>
<li>
<strong>Model</strong>: A model represents the state of view and managed by controller. It can be accessed by controller.getModel(). The model should be reflected to Android UI in views and modified by controllers. <strong>The model will be automatically searialized and restored in onSaveInstanceState by the framework</strong>. So you don't need to use messy key-value pairs to save and restore view state.</li>
<li>
<strong>Managers</strong>: Managers are not necessary in MVC/MVP/MVVM model. However as metioned above, views and controllers are one-to-one mapped, when multiple views as well as their controllers share same data or logic managers are a good fit. Shared logic and data of controllers can be broken out into a manager. For example, managing logged in user is common feature of a lot apps. To have a UserManager is a perfect solution that can modify and read current users. The the manager can be used by LoginController and other controllers after login screen.</li>
<li>
<strong>Services</strong>: We are not taling about <a href="https://developer.android.com/guide/components/services.html">Android Services</a>. Services here are providing a layer between controller controllers and external data such as http apis, database, files, sharedPreferences and etc. Services can be injected into controllers as well as managers since managers can be thought as partial controllers.
Services abstract out data access logic so that they can be replaced by different implementations. e.g. Use database to replace sharedPreference when the data structure become complex and query is required. In addition, the controllers can use mocked data provided by mocked services for <strong>unit tests</strong>.</li>
</ul>

<p>See the diagram illustrating the relation between components above</p>

<p><img src="http://i.imgur.com/dfW8TLM.png" alt="AndroidMvc Layers"></p>

<h4>
<a id="sample-code-to-implement-mvp" class="anchor" href="#sample-code-to-implement-mvp" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Sample code to implement MVP</h4>

<ul>
<li>
<p>This sample shosw how a simple view just simply binds the model to the view</p>

<div class="highlight highlight-source-java"><pre><span class="pl-c">//Base view interface defined in AndroidMvc framework</span>
<span class="pl-k">public</span> <span class="pl-k">interface</span> <span class="pl-en">UiView</span> {
    <span class="pl-k">void</span> <span class="pl-en">update</span>();
}

<span class="pl-c">//Base controller defined in AndroidMvc framework</span>
<span class="pl-k">public</span> <span class="pl-k">abstract</span> <span class="pl-k">class</span> <span class="pl-en">Controller</span>&lt;MODEL, VIEW <span class="pl-k">extends</span> <span class="pl-e">UiView</span>&gt; extends <span class="pl-e">Bean&lt;<span class="pl-smi">MODEL</span>&gt;</span> {
    <span class="pl-k">protected</span> <span class="pl-c1">VIEW</span> view;
    <span class="pl-c1">....</span>
}

<span class="pl-c">//A concrete controller extending Controller</span>
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">SomeController</span> <span class="pl-k">extends</span> <span class="pl-e">Controller&lt;<span class="pl-smi">SomeController</span>.Model</span>, <span class="pl-e">UiView</span>&gt; {
    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-smi">Class</span> <span class="pl-en">modelType</span>() {
        <span class="pl-k">return</span> <span class="pl-smi">SomeController</span><span class="pl-k">.</span>class;
    }

    <span class="pl-c">//The model of the controller that represents the state of the view</span>
    <span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-k">class</span> <span class="pl-en">Model</span> {
        <span class="pl-smi">String</span> title;
        <span class="pl-k">public</span> <span class="pl-smi">String</span> <span class="pl-en">getTitle</span>() {
            <span class="pl-k">return</span> title;
        }
    }

    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">updateTitle</span>(<span class="pl-smi">String</span> <span class="pl-v">text</span>) {
        <span class="pl-c">//Model is updated</span>
        getModel()<span class="pl-k">.</span>title <span class="pl-k">=</span> text;
        <span class="pl-c">//Notify the view. The implementation of method update() in </span>
        <span class="pl-c">//concrete view, the view reads the model of the controller </span>
        <span class="pl-c">//and reflect the model to UI</span>
        view<span class="pl-k">.</span>update();
    }
}

<span class="pl-c">//View paired with the controller </span>
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">SomeView</span> <span class="pl-k">implements</span> <span class="pl-e">UiView</span> {
    <span class="pl-k">private</span> <span class="pl-smi">TextView</span> title;

    <span class="pl-k">@Inject</span>
    <span class="pl-k">private</span> <span class="pl-smi">SomeController</span> someController;

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">update</span>() {
        <span class="pl-c">//Read the controller's model and bind it to text</span>
        title<span class="pl-k">.</span>setText(someController<span class="pl-k">.</span>getModel()<span class="pl-k">.</span>getTitle());
    }
}</pre></div>
</li>
<li>
<p>This sample shosw how a more complicated view defines extract methods to update view partially. However, this can also be done only with binding model appoach. For example, define a flag in the model, when the flag changes the controller call view.update() which show loading UI according to the flag.</p>

<div class="highlight highlight-source-java"><pre><span class="pl-c">//Extend UiView to define granular methods to update view partially instead of binding</span>
<span class="pl-c">//entire model to the view</span>
<span class="pl-k">public</span> <span class="pl-k">interface</span> <span class="pl-en">AsyncView</span> <span class="pl-k">extends</span> <span class="pl-e">UiView</span> {
    <span class="pl-k">void</span> <span class="pl-en">showLoadingStatus</span>();
    <span class="pl-k">void</span> <span class="pl-en">hideLoadingStatus</span>();
}

<span class="pl-c">//A screen view that extends MvcFragment</span>
<span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-k">class</span> <span class="pl-en">LoginScreen</span> <span class="pl-k">extends</span> <span class="pl-e">MvcFragment&lt;<span class="pl-smi">LoginController</span>&gt;</span> <span class="pl-k">implements</span> <span class="pl-e">AsyncView</span>{
    <span class="pl-k">private</span> <span class="pl-smi">EditText</span> username;
    <span class="pl-k">private</span> <span class="pl-smi">EditText</span> password;
    <span class="pl-k">private</span> <span class="pl-smi">Button</span> button;

    <span class="pl-c">//Specify the class type of the paired controller</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">protected</span> <span class="pl-k">Class&lt;<span class="pl-smi">LoginController</span>&gt;</span> <span class="pl-en">getControllerClass</span>() {
        <span class="pl-k">return</span> <span class="pl-smi">LoginController</span><span class="pl-k">.</span>class;
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">protected</span> <span class="pl-k">int</span> <span class="pl-en">getLayoutResId</span>() {
        <span class="pl-k">return</span> <span class="pl-smi">R</span><span class="pl-k">.</span>id<span class="pl-k">.</span>screen_login;
    }

    <span class="pl-c">//Called when the view is ready. Similar to onViewCreated but this</span>
    <span class="pl-c">//callback guaranteed all injectable instances depended by this view are ready</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onViewReady</span>(<span class="pl-smi">View</span> <span class="pl-v">view</span>, <span class="pl-smi">Bundle</span> <span class="pl-v">savedInstanceState</span>, <span class="pl-smi">Reason</span> <span class="pl-v">reason</span>) {
        <span class="pl-v">super</span><span class="pl-k">.</span>onViewReady(view, savedInstanceState, reason);

        <span class="pl-c">//assign view by findViewById</span>
        <span class="pl-c">//...</span>
        button<span class="pl-k">.</span>setOnClickListener(<span class="pl-k">new</span> <span class="pl-smi">View</span>.<span class="pl-smi">OnClickListener</span>() {
            <span class="pl-k">@Override</span>
            <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onClick</span>(<span class="pl-smi">View</span> <span class="pl-v">view</span>) {
                controller<span class="pl-k">.</span>login(username<span class="pl-k">.</span>getText()<span class="pl-k">.</span>toString(),
                        password<span class="pl-k">.</span>getText()<span class="pl-k">.</span>toString());
            }
        });
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">showLoadingStatus</span>() {
        <span class="pl-c">//Show progress dialog or progress bar</span>
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">hideLoadingStatus</span>() {
        <span class="pl-c">//Hide progress dialog or progress bar</span>
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">update</span>() {
        <span class="pl-c">//Bind model here</span>
    }

}

<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">LoginController</span> <span class="pl-k">extends</span> <span class="pl-e">FragmentController&lt;<span class="pl-smi">Void</span>, <span class="pl-smi">AsyncView</span>&gt;</span> {
    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">Class&lt;<span class="pl-smi">Void</span>&gt;</span> <span class="pl-en">modelType</span>() {
        <span class="pl-k">return</span> <span class="pl-c1">null</span>;
    }

    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">login</span>(<span class="pl-smi">String</span> <span class="pl-v">username</span>, <span class="pl-smi">String</span> <span class="pl-v">password</span>) {
        runTask(<span class="pl-k">new</span> <span class="pl-k">Task&lt;<span class="pl-smi">Void</span>&gt;</span>() {
            <span class="pl-k">@Override</span>
            <span class="pl-k">public</span> <span class="pl-smi">Void</span> <span class="pl-en">execute</span>(<span class="pl-k">Monitor&lt;<span class="pl-smi">Void</span>&gt;</span> <span class="pl-v">monitor</span>) <span class="pl-k">throws</span> <span class="pl-smi">Exception</span> {
                <span class="pl-c">//Task.execute methods runs on non-UI thread, so we need to</span>
                <span class="pl-c">//post the view update logic back to UI thread</span>
                uiThreadRunner<span class="pl-k">.</span>post(<span class="pl-k">new</span> <span class="pl-smi">Runnable</span>() {
                    <span class="pl-k">@Override</span>
                    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">run</span>() {
                        view<span class="pl-k">.</span>showLoadingStatus();
                    }
                });

                <span class="pl-c">//Send a http request to login</span>
                <span class="pl-c">//...</span>
                <span class="pl-c">//Request returns successfully</span>

                <span class="pl-c">//Task.execute methods runs on non-UI thread, so we need to</span>
                <span class="pl-c">//post the view update logic back to UI thread</span>
                uiThreadRunner<span class="pl-k">.</span>post(<span class="pl-k">new</span> <span class="pl-smi">Runnable</span>() {
                    <span class="pl-k">@Override</span>
                    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">run</span>() {
                        view<span class="pl-k">.</span>hideLoadingStatus();
                    }
                });
                <span class="pl-k">return</span> <span class="pl-c1">null</span>;
            }
        }, <span class="pl-k">new</span> <span class="pl-smi">Task</span>.<span class="pl-k">Callback&lt;<span class="pl-smi">Void</span>&gt;</span>() {
            <span class="pl-k">@Override</span>
            <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onException</span>(<span class="pl-smi">Exception</span> <span class="pl-v">e</span>) <span class="pl-k">throws</span> <span class="pl-smi">Exception</span> {
                <span class="pl-c">//Call back is guaranteed to run on UI thread by the framework</span>
                <span class="pl-c">//No need to use uiThreadRunner to post action</span>
                view<span class="pl-k">.</span>hideLoadingStatus();
            }
        });
    }
}</pre></div>

<h4>
<a id="sample-code-to-implement-mvvm" class="anchor" href="#sample-code-to-implement-mvvm" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Sample code to implement MVVM</h4>
</li>
</ul>

<div class="highlight highlight-source-java"><pre><span class="pl-c">//A concrete controller as a ViewModel</span>
    <span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-k">class</span> <span class="pl-en">SomeController</span> <span class="pl-k">extends</span> <span class="pl-e">Controller&lt;<span class="pl-smi">SomeController</span>.Model</span>, <span class="pl-e">UiView</span>&gt; {
        <span class="pl-k">interface</span> <span class="pl-en">Event</span> {
            <span class="pl-k">class</span> <span class="pl-en">OnModelUpdated</span> {
            }

            <span class="pl-k">class</span> <span class="pl-en">OnTitleChanged</span> {
                <span class="pl-k">private</span> <span class="pl-k">final</span> <span class="pl-smi">String</span> title;

                <span class="pl-k">public</span> <span class="pl-en">OnTitleChanged</span>(<span class="pl-smi">String</span> <span class="pl-v">title</span>) {
                    <span class="pl-v">this</span><span class="pl-k">.</span>title <span class="pl-k">=</span> title;
                }

                <span class="pl-k">public</span> <span class="pl-smi">String</span> <span class="pl-en">getTitle</span>() {
                    <span class="pl-k">return</span> title;
                }
            }
        }

        <span class="pl-k">@Override</span>
        <span class="pl-k">public</span> <span class="pl-smi">Class</span> <span class="pl-en">modelType</span>() {
            <span class="pl-k">return</span> <span class="pl-smi">SomeController</span><span class="pl-k">.</span>class;
        }

        <span class="pl-c">//The model of the controller that represents the state of the view</span>
        <span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">Model</span> {
            <span class="pl-k">private</span> <span class="pl-smi">String</span> title;

            <span class="pl-c">//Update model properties will fire events</span>
            <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">setTitle</span>(<span class="pl-smi">String</span> <span class="pl-v">title</span>) {
                <span class="pl-v">this</span><span class="pl-k">.</span>title <span class="pl-k">=</span> title;

                <span class="pl-c">//Post an event</span>
                <span class="pl-c">//Note postEvent method guarantees the event will be posted to UI thread!!!</span>
                postEvent(<span class="pl-k">new</span> <span class="pl-smi">Event</span>.<span class="pl-smi">OnTitleChanged</span>(getModel()<span class="pl-k">.</span>getTitle()));
            }

            <span class="pl-k">public</span> <span class="pl-smi">String</span> <span class="pl-en">getTitle</span>() {
                <span class="pl-k">return</span> title;
            }
        }

        <span class="pl-c">//Expose to view to update title</span>
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">updateTitle</span>(<span class="pl-smi">String</span> <span class="pl-v">text</span>) {
            <span class="pl-c">//Model is updated</span>
            getModel()<span class="pl-k">.</span>setTitle(text);
        }

        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">rebindModel</span>() {
            <span class="pl-c">//...</span>
            <span class="pl-c">//code to update model</span>
            <span class="pl-c">//</span>

            postEvent(<span class="pl-k">new</span> <span class="pl-smi">Event</span>.<span class="pl-smi">OnModelUpdated</span>());
        }
    }

    <span class="pl-c">//View paired with the controller</span>
    <span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">SomeView</span> <span class="pl-k">extends</span> <span class="pl-e">View</span> {
        <span class="pl-k">private</span> <span class="pl-smi">TextView</span> title;

        <span class="pl-k">@Inject</span>
        <span class="pl-k">private</span> <span class="pl-smi">SomeController</span> controller;

        <span class="pl-k">@Inject</span>
        <span class="pl-k">@EventBusV</span> <span class="pl-c">//Event bus for subscribers as views</span>
        <span class="pl-k">private</span> <span class="pl-smi">EventBus</span> eventBus;

        <span class="pl-k">public</span> <span class="pl-en">SomeView</span>(<span class="pl-smi">Context</span> <span class="pl-v">context</span>) {
            <span class="pl-v">super</span>(context);

            <span class="pl-c">//Register this view to the event bus for views</span>
            <span class="pl-c">//Since here, when an even in type of SomeController.Event.OnTitleChanged</span>
            <span class="pl-c">//is posted, method onEvent(SomeController.Event.OnTitleChanged event)</span>
            <span class="pl-c">//will be called</span>
            eventBus<span class="pl-k">.</span>register(<span class="pl-v">this</span>);
        }

        <span class="pl-k">@Override</span>
        <span class="pl-k">protected</span> <span class="pl-k">void</span> <span class="pl-en">onAttachedToWindow</span>() {
            <span class="pl-v">super</span><span class="pl-k">.</span>onAttachedToWindow();

            <span class="pl-c">//Unregister the view from the event bus.</span>
            <span class="pl-c">//This is working but not ideal because the event bus will be unregistered until</span>
            <span class="pl-c">//the view is removed from the window not it's parent</span>
            <span class="pl-c">//You can consider viewGroup.setOnHierarchyChangeListener</span>

            <span class="pl-c">//but make sub view in fragments extending MvcFragment is recommended since </span>
            <span class="pl-c">//MvcFragment register and unregister event bus in onCreate and onDestroy </span>
            <span class="pl-c">//lifecycle call backs. </span>
            <span class="pl-c">// </span>
            <span class="pl-c">//This is just an example of using eventBus manually.</span>
            eventBus<span class="pl-k">.</span>unregister(<span class="pl-v">this</span>);
        }

        <span class="pl-c">//Monitor event SomeController.Event.OnTitleChanged</span>
        <span class="pl-c">//All event subscriber methods should be called onEvent with one argument of the</span>
        <span class="pl-c">//event's class type</span>
        <span class="pl-k">private</span> <span class="pl-k">void</span> <span class="pl-en">onEvent</span>(<span class="pl-smi">SomeController</span>.<span class="pl-smi">Event</span>.<span class="pl-smi">OnTitleChanged</span> <span class="pl-v">event</span>) {
            title<span class="pl-k">.</span>setText(event<span class="pl-k">.</span>getTitle());
        }

        <span class="pl-c">//Monitor event SomeController.Event.OnModelUpdated</span>
        <span class="pl-k">private</span> <span class="pl-k">void</span> <span class="pl-en">onEvent</span>(<span class="pl-smi">SomeController</span>.<span class="pl-smi">Event</span>.<span class="pl-smi">OnModelUpdated</span> <span class="pl-v">event</span>) {
            title<span class="pl-k">.</span>setText(controller<span class="pl-k">.</span>getModel()<span class="pl-k">.</span>getTitle());

            <span class="pl-c">//other views to bind to the controller/ViewModel's model</span>
            <span class="pl-c">//...</span>
        }
    }</pre></div>

<h2>
<a id="fragment-life-cycles" class="anchor" href="#fragment-life-cycles" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Fragment Life cycles</h2>

<p>Since AndroidMvc framwork is designed to implement apps with a single Activity in most cases. Fragments are playing an important role. In the framework, fragments can be used as a screen which is the what an activity does traditionally. Also it can be used as sub view as well.</p>

<p>Below are life cycle callback of MvcFragment provided by AndroidMvc framework</p>

<ul>
<li>
<strong>onCreateView</strong> is final and <strong>SEALED</strong>, use onViewReady described below</li>
<li>
<strong>onViewCreated</strong> is final and <strong>SEALED</strong>, use onViewReady described below</li>
<li>
<strong>onViewReady</strong>(View, Bundle, <strong>Reason</strong>) is called when the fragement is ready to bind Android widgets by findViewById and <strong>use controllers</strong>. The argument "Reason" indicates why the view is created or recreated. For example, view is created

<ul>
<li>first time</li>
<li>on restoration</li>
<li>rotation.</li>
</ul>
</li>
<li>
<strong>onReturnForeground</strong> called when the app is brought to the front after being pushed to background. It complements onResume since onResume doesn't differentiate foregrounding app, rotation, creation and etc.</li>
<li>
<strong>onPushToBackStack</strong> called when the fragment is about to be pushed to back stack typically on navigation. It complements onPause since onPause doesn't differentiate pushing to back stack, removing fragment, rotation and etc.</li>
<li>
<strong>onPoppedOutToFront</strong> called when the fragment is popping out from the fragment backstack to present as the top most fragment.</li>
<li>
<strong>onPopAway</strong> called when the fragment was the top most presenting fragment but will be popped away and replaced by the fragment will pop out under it.</li>
<li>
<strong>onPreNavigationTransaction(FragmentTransaction transaction, MvcFragment nextFragment)</strong> called before the fragment transaction is about to commit that will replace current fragment by the next. It's main providing the transaction being committed to configure transaction animation. e.g adding SharedElements</li>
<li>
<strong>onOrientationChanged</strong> called when orientation changed.</li>
</ul>

<h2>
<a id="fragmentcontroller-life-cycles" class="anchor" href="#fragmentcontroller-life-cycles" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>FragmentController Life cycles</h2>

<p>All fragment life cycles are mapped into <a href="https://github.com/kejunxia/AndroidMvc/blob/master/library/android-mvc-core/src/main/java/com/shipdream/lib/android/mvc/FragmentController.java">FragmentController</a>. So fragments are further liberated from handling business logic. For example, if you need to do some stuff in Framgent.onViewReady, you can do it in FragmentController.onViewReady.</p>

<p>Here are the life cycles</p>

<ul>
<li>
<strong>onCreate</strong> when the controller is injected into the corresponding fragment</li>
<li>
<strong>onViewReady(Reason)</strong> is called when the fragement is ready to show. The argument "Reason" indicates why the view is created or recreated. For example, view is created

<ul>
<li>first time</li>
<li>on restoration</li>
<li>rotation.</li>
</ul>
</li>
<li>
<strong>onResume</strong> callced when the fragment is calling its own onResume</li>
<li>
<strong>onPasue</strong> called when the fragment is calling its own onPuase</li>
<li>
<strong>onDestroy</strong> called when the controller is released from being used by the corresponding fragment and not referenced by anything it was injected to.</li>
<li>
<strong>onBackButtonPressed()</strong> called when the phycical back button is pressed</li>
<li>
<strong>onReturnForeground</strong> samed as the corresponding life cycle callback in fragment</li>
<li>
<strong>onPushToBackStack</strong> samed as the corresponding life cycle callback in fragment</li>
<li>
<strong>onPoppedOutToFront</strong> samed as the corresponding life cycle callback in fragment</li>
<li>
<strong>onPopAway</strong> samed as the corresponding life cycle callback in fragment</li>
<li>
<strong>onOrientationChanged</strong> called when orientation changed.</li>
</ul>

<hr>

<h2>
<a id="below-are-old-documents-for-androidmvc-below-230-they-will-be-updated" class="anchor" href="#below-are-old-documents-for-androidmvc-below-230-they-will-be-updated" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Below are old documents for AndroidMvc below 2.3.0. They will be updated.</h2>

<hr>

<h2>
<a id="using-androidmvc" class="anchor" href="#using-androidmvc" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Using AndroidMvc</h2>

<p>Let's take a simple app counting number as an example. The counter app has two navigation locations:
1. LocationA: presented by FragmentA</p>

<ul>
<li>One text view to display the current count in number. Updated by event OnCounterUpdated</li>
<li>Two buttons which increment and decrement count <strong>on click</strong>.</li>
<li>An nested fragment with a TextView to display count in English. Updated by event OnCounterUpdated too</li>
<li>An button to show advance view which results in navigating to LocationB</li>
<li>Shares the result of counting updated by LocationB

<ol>
<li>LocationB: presented by FragmentB</li>
</ol>
</li>
<li>One text view to display the current count in number. Updated by event OnCounterUpdated</li>
<li>Two buttons which increment and decrement count <strong>continuously on hold</strong>.</li>
<li>Shares the result of counting updated by LocationB</li>
</ul>

<p>Below is how to use AndroidMvc framework to implement and test the app including navigation. Note the code below doesn't show all code. To see more details check the sample project in the app - Simple under samples subfolder.</p>

<h5>
<a id="1-extend-mvcactivity-for-the-single-activity" class="anchor" href="#1-extend-mvcactivity-for-the-single-activity" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>1. Extend MvcActivity for the single Activity</h5>

<div class="highlight highlight-source-java"><pre><span class="pl-c">/**</span>
<span class="pl-c"> * Single activity for the app</span>
<span class="pl-c"> */</span>
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">MainActivity</span> <span class="pl-k">extends</span> <span class="pl-e">MvcActivity</span> {
    <span class="pl-c">/**</span>
<span class="pl-c">     * Define how to map navigation location id to full screen fragments</span>
<span class="pl-c">     * @param locationId The location id in string</span>
<span class="pl-c">     * @return The class of the fragment representing the navigation locations</span>
<span class="pl-c">     */</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">protected</span> <span class="pl-k">Class&lt;? extends <span class="pl-smi">MvcFragment</span>&gt;</span> <span class="pl-en">mapNavigationFragment</span>(<span class="pl-smi">String</span> <span class="pl-v">locationId</span>) {
        <span class="pl-k">switch</span> (locationId) {
            <span class="pl-k">case</span> <span class="pl-s"><span class="pl-pds">"</span>LocationA<span class="pl-pds">"</span></span><span class="pl-k">:</span>
                <span class="pl-k">return</span> <span class="pl-smi">FragmentA</span><span class="pl-k">.</span>class;
            <span class="pl-k">case</span> <span class="pl-s"><span class="pl-pds">"</span>LocationB<span class="pl-pds">"</span></span><span class="pl-k">:</span>
                <span class="pl-k">return</span> <span class="pl-smi">FragmentB</span><span class="pl-k">.</span>class;
            <span class="pl-k">default</span><span class="pl-k">:</span>
                <span class="pl-k">return</span> <span class="pl-c1">null</span>;
        }
    }

    <span class="pl-c">/**</span>
<span class="pl-c">     * Define the delegate fragment for the activity</span>
<span class="pl-c">     * @return</span>
<span class="pl-c">     */</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">protected</span> <span class="pl-k">Class&lt;? extends <span class="pl-smi">DelegateFragment</span>&gt;</span> <span class="pl-en">getDelegateFragmentClass</span>() {
        <span class="pl-k">return</span> <span class="pl-smi">ContainerFragment</span><span class="pl-k">.</span>class;
    }

    <span class="pl-c">/**</span>
<span class="pl-c">     * Container fragment extends DelegateFragment would be the root container fragments to swap</span>
<span class="pl-c">     * full screen fragments inside it on navigation.</span>
<span class="pl-c">     */</span>
    <span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-k">class</span> <span class="pl-en">ContainerFragment</span> <span class="pl-k">extends</span> <span class="pl-e">DelegateFragment</span> {
        <span class="pl-c">/**</span>
<span class="pl-c">         * What to do when app starts for the first time</span>
<span class="pl-c">         */</span>
        <span class="pl-k">@Override</span>
        <span class="pl-k">protected</span> <span class="pl-k">void</span> <span class="pl-en">onStartUp</span>() {
            <span class="pl-c">//startApp method of appController will navigate the app to the landing page</span>
            appController<span class="pl-k">.</span>startApp(<span class="pl-v">this</span>);
        }
    }
}</pre></div>

<h5>
<a id="2-create-fragmenta-to-present-locationa" class="anchor" href="#2-create-fragmenta-to-present-locationa" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2. Create FragmentA to present "LocationA"</h5>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">FragmentA</span> <span class="pl-k">extends</span> <span class="pl-e">MvcFragment</span> {
    <span class="pl-c">/**</span>
<span class="pl-c">     * @return Layout id used to inflate the view of this MvcFragment.</span>
<span class="pl-c">     */</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">protected</span> <span class="pl-k">int</span> <span class="pl-en">getLayoutResId</span>() {
        <span class="pl-k">return</span> <span class="pl-smi">R</span><span class="pl-k">.</span>layout<span class="pl-k">.</span>fragment_a;
    }
}</pre></div>

<h5>
<a id="3-create-a-controller-contract-and-the-model-its-managing" class="anchor" href="#3-create-a-controller-contract-and-the-model-its-managing" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>3. Create a controller contract and the model it's managing</h5>

<div class="highlight highlight-source-java"><pre><span class="pl-k">package</span> <span class="pl-smi">com.shipdream.lib.android.mvc.samples.simple.controller</span>;

<span class="pl-c">/**</span>
<span class="pl-c"> * Define controller contract and its events. And specify which model it manages by binding the</span>
<span class="pl-c"> * model type.</span>
<span class="pl-c"> */</span>
<span class="pl-k">public</span> <span class="pl-k">interface</span> <span class="pl-en">CounterController</span> <span class="pl-k">extends</span> <span class="pl-e">BaseController&lt;<span class="pl-smi">CounterModel</span>&gt;</span> {
    <span class="pl-c">/**</span>
<span class="pl-c">     * Increment count and will raise {@link EventC2V.OnCounterUpdated}</span>
<span class="pl-c">     * @param sender Who requests this action</span>
<span class="pl-c">     */</span>
    <span class="pl-k">void</span> <span class="pl-en">increment</span>(<span class="pl-smi">Object</span> <span class="pl-v">sender</span>);

    <span class="pl-c">/**</span>
<span class="pl-c">     * Decrement count and will raise {@link EventC2V.OnCounterUpdated}</span>
<span class="pl-c">     * @param sender Who requests this action</span>
<span class="pl-c">     */</span>
    <span class="pl-k">void</span> <span class="pl-en">decrement</span>(<span class="pl-smi">Object</span> <span class="pl-v">sender</span>);

    <span class="pl-c">/**</span>
<span class="pl-c">     * Method to convert number to english</span>
<span class="pl-c">     * @param number</span>
<span class="pl-c">     * @return</span>
<span class="pl-c">     */</span>
    <span class="pl-smi">String</span> <span class="pl-en">convertNumberToEnglish</span>(<span class="pl-k">int</span> <span class="pl-v">number</span>);

    <span class="pl-c">/**</span>
<span class="pl-c">     * Namespace the events for this controller by nested interface so that all its events would</span>
<span class="pl-c">     * be referenced as CounterController.EventC2V.BlaBlaEvent</span>
<span class="pl-c">     */</span>
    <span class="pl-k">interface</span> <span class="pl-en">EventC2V</span> {
        <span class="pl-c">/**</span>
<span class="pl-c">         * Event to notify views counter has been updated</span>
<span class="pl-c">         */</span>
        <span class="pl-k">class</span> <span class="pl-en">OnCounterUpdated</span> <span class="pl-k">extends</span> <span class="pl-e">BaseEventC2V</span> {
            <span class="pl-k">private</span> <span class="pl-k">final</span> <span class="pl-k">int</span> count;
            <span class="pl-k">private</span> <span class="pl-k">final</span> <span class="pl-smi">String</span> countInEnglish;
            <span class="pl-k">public</span> <span class="pl-en">OnCounterUpdated</span>(<span class="pl-smi">Object</span> <span class="pl-v">sender</span>, <span class="pl-k">int</span> <span class="pl-v">count</span>, <span class="pl-smi">String</span> <span class="pl-v">countInEnglish</span>) {
                <span class="pl-v">super</span>(sender);
                <span class="pl-v">this</span><span class="pl-k">.</span>count <span class="pl-k">=</span> count;
                <span class="pl-v">this</span><span class="pl-k">.</span>countInEnglish <span class="pl-k">=</span> countInEnglish;
            }

            <span class="pl-k">public</span> <span class="pl-k">int</span> <span class="pl-en">getCount</span>() {
                <span class="pl-k">return</span> count;
            }

            <span class="pl-k">public</span> <span class="pl-smi">String</span> <span class="pl-en">getCountInEnglish</span>() {
                <span class="pl-k">return</span> countInEnglish;
            }
        }
    }
}</pre></div>

<h5>
<a id="3-implement-the-controller" class="anchor" href="#3-implement-the-controller" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>3. Implement the controller</h5>

<p><strong>Note that, to allow AndroidMvc to find the default implementation of injectable object, the implementation class must be under the sub-package "internal" which resides in the same parent package as the interface and the name must be [InterfaceName]Impl.</strong> For this example, say CounterController is under package samples.simple.controller the  implementation must be named as CounterControllerImpl and placed under package samples.simple.controller.internal</p>

<div class="highlight highlight-source-java"><pre><span class="pl-c">/**</span>
<span class="pl-c"> * Note the structure of the package name. It is in a subpackage(internal) sharing the same parent</span>
<span class="pl-c"> * package as the controller interface CounterController</span>
<span class="pl-c"> */</span>
<span class="pl-k">package</span> <span class="pl-smi">com.shipdream.lib.android.mvc.samples.simple.controller.internal</span>;

<span class="pl-c">/**</span>
<span class="pl-c"> * Note the class name is [CounterController]Impl.</span>
<span class="pl-c"> */</span>
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">CounterControllerImpl</span> <span class="pl-k">extends</span> <span class="pl-e">BaseControllerImpl&lt;<span class="pl-smi">CounterModel</span>&gt;</span> <span class="pl-k">implements</span> <span class="pl-e">CounterController</span>{
    <span class="pl-c">/**</span>
<span class="pl-c">     * Just return the class type of the model managed by this controller</span>
<span class="pl-c">     * @return</span>
<span class="pl-c">     */</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">protected</span> <span class="pl-k">Class&lt;<span class="pl-smi">CounterModel</span>&gt;</span> <span class="pl-en">getModelClassType</span>() {
        <span class="pl-k">return</span> <span class="pl-smi">CounterModel</span><span class="pl-k">.</span>class;
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">increment</span>(<span class="pl-smi">Object</span> <span class="pl-v">sender</span>) {
        <span class="pl-k">int</span> count <span class="pl-k">=</span> getModel()<span class="pl-k">.</span>getCount();
        getModel()<span class="pl-k">.</span>setCount(<span class="pl-k">++</span>count);
        <span class="pl-c">//Post controller to view event to views</span>
        postC2VEvent(<span class="pl-k">new</span> <span class="pl-smi">EventC2V</span>.<span class="pl-smi">OnCounterUpdated</span>(sender, count, convertNumberToEnglish(count)));
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">decrement</span>(<span class="pl-smi">Object</span> <span class="pl-v">sender</span>) {
        <span class="pl-k">int</span> count <span class="pl-k">=</span> getModel()<span class="pl-k">.</span>getCount();
        getModel()<span class="pl-k">.</span>setCount(<span class="pl-k">--</span>count);
        <span class="pl-c">//Post controller to view event to views</span>
        postC2VEvent(<span class="pl-k">new</span> <span class="pl-smi">EventC2V</span>.<span class="pl-smi">OnCounterUpdated</span>(sender, count, convertNumberToEnglish(count)));
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-smi">String</span> <span class="pl-en">convertNumberToEnglish</span>(<span class="pl-k">int</span> <span class="pl-v">number</span>) {
        <span class="pl-k">if</span> (number <span class="pl-k">&lt;</span> <span class="pl-k">-</span><span class="pl-c1">3</span>) {
            <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>Less than negative three<span class="pl-pds">"</span></span>;
        } <span class="pl-k">else</span>  <span class="pl-k">if</span> (number <span class="pl-k">==</span> <span class="pl-k">-</span><span class="pl-c1">3</span>) {
            <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>Negative three<span class="pl-pds">"</span></span>;
        } <span class="pl-k">else</span>  <span class="pl-k">if</span> (number <span class="pl-k">==</span> <span class="pl-k">-</span><span class="pl-c1">2</span>) {
            <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>Negative two<span class="pl-pds">"</span></span>;
        } <span class="pl-k">else</span>  <span class="pl-k">if</span> (number <span class="pl-k">==</span> <span class="pl-k">-</span><span class="pl-c1">1</span>) {
            <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>Negative one<span class="pl-pds">"</span></span>;
        } <span class="pl-k">else</span> <span class="pl-k">if</span> (number <span class="pl-k">==</span> <span class="pl-c1">0</span>) {
            <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>Zero<span class="pl-pds">"</span></span>;
        } <span class="pl-k">else</span> <span class="pl-k">if</span> (number <span class="pl-k">==</span> <span class="pl-c1">1</span>) {
            <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>One<span class="pl-pds">"</span></span>;
        } <span class="pl-k">else</span> <span class="pl-k">if</span> (number <span class="pl-k">==</span> <span class="pl-c1">2</span>) {
            <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>Two<span class="pl-pds">"</span></span>;
        } <span class="pl-k">else</span> <span class="pl-k">if</span> (number <span class="pl-k">==</span> <span class="pl-c1">3</span>) {
            <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>Three<span class="pl-pds">"</span></span>;
        } <span class="pl-k">else</span> {
            <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>Greater than three<span class="pl-pds">"</span></span>;
        }
    }
}</pre></div>

<h5>
<a id="4-inject-controller-into-views-setup-views-and-handle-c2v-events-from-controllers" class="anchor" href="#4-inject-controller-into-views-setup-views-and-handle-c2v-events-from-controllers" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>4. Inject Controller into Views, setup views and handle C2V events from controllers</h5>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">FragmentA</span> <span class="pl-k">extends</span> <span class="pl-e">MvcFragment</span> {
    <span class="pl-k">@Inject</span>
    <span class="pl-k">private</span> <span class="pl-smi">CounterController</span> counterController;

    <span class="pl-k">private</span> <span class="pl-smi">TextView</span> display;
    <span class="pl-k">private</span> <span class="pl-smi">Button</span> increment;
    <span class="pl-k">private</span> <span class="pl-smi">Button</span> decrement;

    <span class="pl-c">/**</span>
<span class="pl-c">     * @return Layout id used to inflate the view of this MvcFragment.</span>
<span class="pl-c">     */</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">protected</span> <span class="pl-k">int</span> <span class="pl-en">getLayoutResId</span>() {
        <span class="pl-k">return</span> <span class="pl-smi">R</span><span class="pl-k">.</span>layout<span class="pl-k">.</span>fragment_a;
    }

    <span class="pl-c">/**</span>
<span class="pl-c">     * Lifecycle similar to onViewCreated by with more granular control with an extra argument to</span>
<span class="pl-c">     * indicate why this view is created: 1. first time created, or 2. rotated or 3. restored</span>
<span class="pl-c">     * @param view The root view of the fragment</span>
<span class="pl-c">     * @param savedInstanceState The savedInstanceState when the fragment is being recreated after</span>
<span class="pl-c">     *                           its enclosing activity is killed by OS, otherwise null including on</span>
<span class="pl-c">     *                           rotation</span>
<span class="pl-c">     * @param reason Indicates the {@link Reason} why the onViewReady is called.</span>
<span class="pl-c">     */</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onViewReady</span>(<span class="pl-smi">View</span> <span class="pl-v">view</span>, <span class="pl-smi">Bundle</span> <span class="pl-v">savedInstanceState</span>, <span class="pl-smi">Reason</span> <span class="pl-v">reason</span>) {
        <span class="pl-v">super</span><span class="pl-k">.</span>onViewReady(view, savedInstanceState, reason);

        display <span class="pl-k">=</span> (<span class="pl-smi">TextView</span>) view<span class="pl-k">.</span>findViewById(<span class="pl-smi">R</span><span class="pl-k">.</span>id<span class="pl-k">.</span>fragment_a_counterDisplay);
        increment <span class="pl-k">=</span> (<span class="pl-smi">Button</span>) view<span class="pl-k">.</span>findViewById(<span class="pl-smi">R</span><span class="pl-k">.</span>id<span class="pl-k">.</span>fragment_a_buttonIncrement);
        decrement <span class="pl-k">=</span> (<span class="pl-smi">Button</span>) view<span class="pl-k">.</span>findViewById(<span class="pl-smi">R</span><span class="pl-k">.</span>id<span class="pl-k">.</span>fragment_a_buttonDecrement);

        increment<span class="pl-k">.</span>setOnClickListener(<span class="pl-k">new</span> <span class="pl-smi">View</span>.<span class="pl-smi">OnClickListener</span>() {
            <span class="pl-k">@Override</span>
            <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onClick</span>(<span class="pl-smi">View</span> <span class="pl-v">v</span>) {
                counterController<span class="pl-k">.</span>increment(v);
            }
        });

        decrement<span class="pl-k">.</span>setOnClickListener(<span class="pl-k">new</span> <span class="pl-smi">View</span>.<span class="pl-smi">OnClickListener</span>() {
            <span class="pl-k">@Override</span>
            <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onClick</span>(<span class="pl-smi">View</span> <span class="pl-v">v</span>) {
                counterController<span class="pl-k">.</span>decrement(v);
            }
        });

        updateCountDisplay(counterController<span class="pl-k">.</span>getModel()<span class="pl-k">.</span>getCount());
    }

    <span class="pl-c">/**</span>
<span class="pl-c">     * Callback when the fragment is popped out by back navigation</span>
<span class="pl-c">     */</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">protected</span> <span class="pl-k">void</span> <span class="pl-en">onPoppedOutToFront</span>() {
        <span class="pl-v">super</span><span class="pl-k">.</span>onPoppedOutToFront();
        updateCountDisplay(counterController<span class="pl-k">.</span>getModel()<span class="pl-k">.</span>getCount());
    }

    <span class="pl-c">//Define event handler by method named as onEvent with single parameter of the event type</span>
    <span class="pl-c">//to respond event CounterController.EventC2V.OnCounterUpdated</span>
    <span class="pl-k">private</span> <span class="pl-k">void</span> <span class="pl-en">onEvent</span>(<span class="pl-smi">CounterController</span>.<span class="pl-smi">EventC2V</span>.<span class="pl-smi">OnCounterUpdated</span> <span class="pl-v">event</span>) {
        updateCountDisplay(event<span class="pl-k">.</span>getCount());
    }

    <span class="pl-c">/**</span>
<span class="pl-c">     * Update the text view of count number</span>
<span class="pl-c">     * @param count The number of count</span>
<span class="pl-c">     */</span>
    <span class="pl-k">private</span> <span class="pl-k">void</span> <span class="pl-en">updateCountDisplay</span>(<span class="pl-k">int</span> <span class="pl-v">count</span>) {
        display<span class="pl-k">.</span>setText(<span class="pl-smi">String</span><span class="pl-k">.</span>valueOf(count));
    }
}</pre></div>

<h5>
<a id="5-unit-tests-on-controllers" class="anchor" href="#5-unit-tests-on-controllers" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>5. Unit tests on controllers</h5>

<p>As discussed before, business logic should be decoupled from view(Android components) and abstracted to controllers, then we can pretty much test most logic just on controllers without dependencies of any Android components. Views just need to make sure data carried back from controllers are displayed correctly. Whether or not the data is processed correctly is completely controllers' responsibilities that is what is being tested here.</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">TestCounterController</span> {
    <span class="pl-c1">..</span><span class="pl-k">.</span>other dependencies are omitted here

    <span class="pl-k">private</span> <span class="pl-smi">CounterController</span> counterController;

    <span class="pl-k">@Before</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">setUp</span>() <span class="pl-k">throws</span> <span class="pl-smi">Exception</span> {
        <span class="pl-c1">..</span><span class="pl-k">.</span>other dependencies are omitted here

        <span class="pl-c">//create instance of CounterController</span>
        counterController <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">CounterControllerImpl</span>();
        counterController<span class="pl-k">.</span>init();
    }

    <span class="pl-k">@Test</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">increment_should_post_counter_update_event_with_incremented_value</span>() {
        <span class="pl-c">//1. Prepare</span>
        <span class="pl-c">//prepare event monitor</span>
        <span class="pl-k">class</span> <span class="pl-en">Monitor</span> {
            <span class="pl-k">void</span> <span class="pl-en">onEvent</span>(<span class="pl-smi">CounterController</span>.<span class="pl-smi">EventC2V</span>.<span class="pl-smi">OnCounterUpdated</span> <span class="pl-v">event</span>) {
            }
        }
        <span class="pl-smi">Monitor</span> monitor <span class="pl-k">=</span> mock(<span class="pl-smi">Monitor</span><span class="pl-k">.</span>class);
        eventBusC2V<span class="pl-k">.</span>register(monitor);

        <span class="pl-c">//mock controller model for count value</span>
        <span class="pl-k">int</span> value <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">Random</span>()<span class="pl-k">.</span>nextInt();
        <span class="pl-smi">CounterModel</span> counterModel <span class="pl-k">=</span> mock(<span class="pl-smi">CounterModel</span><span class="pl-k">.</span>class);
        when(counterModel<span class="pl-k">.</span>getCount())<span class="pl-k">.</span>thenReturn(value);
        <span class="pl-c">//Bind the mock model to the controller</span>
        counterController<span class="pl-k">.</span>bindModel(<span class="pl-v">this</span>, counterModel);

        <span class="pl-c">//2. Act</span>
        counterController<span class="pl-k">.</span>increment(<span class="pl-v">this</span>);

        <span class="pl-c">//3. Verify</span>
        <span class="pl-k">ArgumentCaptor&lt;<span class="pl-smi">CounterController</span>.</span><span class="pl-smi">EventC2V</span><span class="pl-k">.</span><span class="pl-smi">OnCounterUpdated</span><span class="pl-k">&gt;</span> updateEvent
                <span class="pl-k">=</span> <span class="pl-smi">ArgumentCaptor</span><span class="pl-k">.</span>forClass(<span class="pl-smi">CounterController</span><span class="pl-k">.</span><span class="pl-smi">EventC2V</span><span class="pl-k">.</span><span class="pl-smi">OnCounterUpdated</span><span class="pl-k">.</span>class);
        <span class="pl-c">//event should be fired once</span>
        verify(monitor, times(<span class="pl-c1">1</span>))<span class="pl-k">.</span>onEvent(updateEvent<span class="pl-k">.</span>capture());
        <span class="pl-c">//event should carry incremented value</span>
        <span class="pl-smi">Assert</span><span class="pl-k">.</span>assertEquals(value <span class="pl-k">+</span> <span class="pl-c1">1</span>, updateEvent<span class="pl-k">.</span>getValue()<span class="pl-k">.</span>getCount());
    }
}</pre></div>

<h5>
<a id="5-navigation" class="anchor" href="#5-navigation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>5. Navigation</h5>

<p>Instead creating, replacing or popping full screen fragments by FragmentManager of Android Activity, AndroidMvc provides NavigationManager to manage navigation. Therefore, navigation logic can be abstracted out from View layer. To make navigation easier to be tested, we can inject NavigationManager to CounterController and then test the model of NavigationManager to verify if navigation location is changed as expected.</p>

<h5>
<a id="51-add-two-methods-to-countercontroller-to-wrap-navigation-logic" class="anchor" href="#51-add-two-methods-to-countercontroller-to-wrap-navigation-logic" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>5.1. Add two methods to CounterController to wrap navigation logic</h5>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">interface</span> <span class="pl-en">CounterController</span> <span class="pl-k">extends</span> <span class="pl-e">BaseController&lt;<span class="pl-smi">CounterModel</span>&gt;</span> {
    <span class="pl-c1">...</span> other methods

    <span class="pl-c">/**</span>
<span class="pl-c">     * Navigate to LocationB by {@link NavigationManager}to show advance view that can update</span>
<span class="pl-c">     * count continuously by holding buttons.</span>
<span class="pl-c">     * @param sender</span>
<span class="pl-c">     */</span>
    <span class="pl-k">void</span> <span class="pl-en">goToAdvancedView</span>(<span class="pl-smi">Object</span> <span class="pl-v">sender</span>);

    <span class="pl-c">/**</span>
<span class="pl-c">     * Navigate back to LocationA by {@link NavigationManager}to show basic view from LocationB</span>
<span class="pl-c">     * @param sender</span>
<span class="pl-c">     */</span>
    <span class="pl-k">void</span> <span class="pl-en">goBackToBasicView</span>(<span class="pl-smi">Object</span> <span class="pl-v">sender</span>);

    <span class="pl-c1">...</span> other methods
}</pre></div>

<h5>
<a id="52-inject-navigationmanager-to-countercontrollerimpl-and-implement-navigation-methods" class="anchor" href="#52-inject-navigationmanager-to-countercontrollerimpl-and-implement-navigation-methods" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>5.2. Inject NavigationManager to CounterControllerImpl and implement navigation methods</h5>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">CounterControllerImpl</span> <span class="pl-k">extends</span> <span class="pl-e">BaseControllerImpl&lt;<span class="pl-smi">CounterModel</span>&gt;</span> <span class="pl-k">implements</span> <span class="pl-e">CounterController</span>{
    <span class="pl-c1">...</span> other methods

    <span class="pl-k">@Inject</span>
    <span class="pl-smi">NavigationManager</span> navigationManager;

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">goToAdvancedView</span>(<span class="pl-smi">Object</span> <span class="pl-v">sender</span>) {
        navigationManager<span class="pl-k">.</span>navigate(sender)<span class="pl-k">.</span>to(<span class="pl-s"><span class="pl-pds">"</span>LocationB<span class="pl-pds">"</span></span>);
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">goBackToBasicView</span>(<span class="pl-smi">Object</span> <span class="pl-v">sender</span>) {
        navigationManager<span class="pl-k">.</span>navigate(sender)<span class="pl-k">.</span>back();
    }

    <span class="pl-c1">...</span> other methods
}</pre></div>

<h5>
<a id="53-invoke-countercontroller-methods-wrapping-navigation-in-views" class="anchor" href="#53-invoke-countercontroller-methods-wrapping-navigation-in-views" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>5.3. Invoke CounterController methods wrapping navigation in views</h5>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">FragmentA</span> <span class="pl-k">extends</span> <span class="pl-e">MvcFragment</span> {
    <span class="pl-c1">...</span>

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onViewReady</span>(<span class="pl-smi">View</span> <span class="pl-v">view</span>, <span class="pl-smi">Bundle</span> <span class="pl-v">savedInstanceState</span>, <span class="pl-smi">Reason</span> <span class="pl-v">reason</span>) {
        <span class="pl-v">super</span><span class="pl-k">.</span>onViewReady(view, savedInstanceState, reason);

        <span class="pl-c1">...</span>

        buttonShowAdvancedView<span class="pl-k">.</span>setOnClickListener(<span class="pl-k">new</span> <span class="pl-smi">View</span>.<span class="pl-smi">OnClickListener</span>() {
            <span class="pl-k">@Override</span>
            <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onClick</span>(<span class="pl-smi">View</span> <span class="pl-v">v</span>) {
                <span class="pl-c">//Use counterController to manage navigation to make navigation testable</span>
                counterController<span class="pl-k">.</span>goToAdvancedView(v);
                <span class="pl-c">//Or we can use navigationManager directly though it's harder to unit test on</span>
                <span class="pl-c">//controller level.</span>
                <span class="pl-c">//example:</span>
                <span class="pl-c">//navigationManager.navigateTo(v, "LocationB");</span>
            }
        });

        <span class="pl-c1">...</span>
    }

    <span class="pl-c1">...</span>
}

<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">FragmentB</span> <span class="pl-k">extends</span> <span class="pl-e">MvcFragment</span> {
    <span class="pl-c1">...</span>

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">boolean</span> <span class="pl-en">onBackButtonPressed</span>() {
        <span class="pl-c">//Use counterController to manage navigation back make navigation testable</span>
        counterController<span class="pl-k">.</span>goBackToBasicView(<span class="pl-v">this</span>);
        <span class="pl-c">//Return true to not pass the back button pressed event to upper level handler.</span>
        <span class="pl-k">return</span> <span class="pl-c1">true</span>;
        <span class="pl-c">//Or we can let the fragment manage back navigation back automatically where we don't</span>
        <span class="pl-c">//override this method which will call NavigationManager.navigate(this).back()</span>
        <span class="pl-c">//automatically</span>
    }

    <span class="pl-c1">...</span>
}</pre></div>

<h5>
<a id="54-able-to-test-navigation-on-countercontroller" class="anchor" href="#54-able-to-test-navigation-on-countercontroller" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>5.4. Able to test navigation on CounterController</h5>

<div class="highlight highlight-source-java"><pre>    @<span class="pl-smi">Test</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> should_navigate_to_locationB_when_go_to_advance_view_and_back_to_locationA_after_go_to_basic_view() {
        <span class="pl-c">//Prepare</span>
        <span class="pl-smi">NavigationManager</span> navigationManager <span class="pl-k">=</span> ((<span class="pl-smi">CounterControllerImpl</span>) counterController)<span class="pl-k">.</span>navigationManager;
        <span class="pl-smi">NavigationManager</span><span class="pl-k">.</span><span class="pl-smi">Model</span> navModel <span class="pl-k">=</span> navigationManager<span class="pl-k">.</span>getModel();
        <span class="pl-c">//App has not navigated to anywhere, current location should be null</span>
        <span class="pl-smi">Assert</span><span class="pl-k">.</span>assertNull(navModel<span class="pl-k">.</span>getCurrentLocation());
        <span class="pl-c">//Simulate navigating to location A</span>
        navigationManager<span class="pl-k">.</span>navigateTo(<span class="pl-v">this</span>, <span class="pl-s"><span class="pl-pds">"</span>LocationA<span class="pl-pds">"</span></span>);
        <span class="pl-c">//Verify: location should be changed to LocationA</span>
        <span class="pl-smi">Assert</span><span class="pl-k">.</span>assertEquals(navModel<span class="pl-k">.</span>getCurrentLocation()<span class="pl-k">.</span>getLocationId(), <span class="pl-s"><span class="pl-pds">"</span>LocationA<span class="pl-pds">"</span></span>);

        <span class="pl-c">//Act: CounterController now goes to advanced view underlining logic is navigating to locationB</span>
        counterController<span class="pl-k">.</span>goToAdvancedView(<span class="pl-v">this</span>);

        <span class="pl-c">//Verify: Current location should be LocationB</span>
        <span class="pl-smi">Assert</span><span class="pl-k">.</span>assertEquals(navModel<span class="pl-k">.</span>getCurrentLocation()<span class="pl-k">.</span>getLocationId(), <span class="pl-s"><span class="pl-pds">"</span>LocationB<span class="pl-pds">"</span></span>);

        <span class="pl-c">//Act: CounterController now goes back to basic view underlining logic is navigating back to locationA</span>
        counterController<span class="pl-k">.</span>goBackToBasicView(<span class="pl-v">this</span>);

        <span class="pl-c">//Verify: Current location should be back to LocationA</span>
        <span class="pl-smi">Assert</span><span class="pl-k">.</span>assertEquals(navModel<span class="pl-k">.</span>getCurrentLocation()<span class="pl-k">.</span>getLocationId(), <span class="pl-s"><span class="pl-pds">"</span>LocationA<span class="pl-pds">"</span></span>);
    }</pre></div>

<h2>
<a id="other-features" class="anchor" href="#other-features" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Other features</h2>

<h4>
<a id="1-dependency-injection" class="anchor" href="#1-dependency-injection" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>1. Dependency Injection</h4>

<h5>
<a id="inject" class="anchor" href="#inject" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><a href="https://github.com/Inject" class="user-mention">@Inject</a>
</h5>

<p>The framework currently only support field injection. To inject an object, use <a href="https://github.com/Inject" class="user-mention">@Inject</a> to annotate fields and then inject the object with those fields by</p>

<div class="highlight highlight-source-java"><pre><span class="pl-smi">AndroidMvc</span><span class="pl-k">.</span>graph()<span class="pl-k">.</span>inject(<span class="pl-smi">ObjectToBeInjected</span>)</pre></div>

<p>All injected objects will be reference counted. This is because
the graph will automatically save and restore injected objects implementing StateManaged. For performance reasons the injected but not anymore referenced objects don't need to be saved and restored. So don't forget to call</p>

<div class="highlight highlight-source-java"><pre><span class="pl-smi">AndroidMvc</span><span class="pl-k">.</span>graph()<span class="pl-k">.</span>release(<span class="pl-smi">ObjectBeenInjected</span>)</pre></div>

<p>to dereference them. Fortunately, all MvcFragment will do the injection and releasing in their
Android lifecycle - onCreate and onDestroy. So we don't need to do this manually for fragments.</p>

<p>**But why do we release? Isn't Java managing garbage collection automatically?</p>

<p>Yes java does it. But since all controllers of AndroidMvc are singleton to assure the single source of truth, if there are used by multiple consumers, the shared instance of the controller will be held by a cache. And the model of the controller will be automatically saved and restored on demand of recreation and destroy of fragments. So if a controller is not used anymore, we can dereference the controller. Then AndroidMvc will stop managing its model.</p>

<p>In addition, instances of fragments in their back stack will be held by OS until they are killed. This holds up a lot memory if the back stack is deep. Since those fragments are not visible, there is no point to hold the data they are referencing any longer. To release reference of controllers will help AndroidMvc be aware which controllers are not used anymore, thereafter AndroidMvc can free up the memory holding their models. What about if those fragments want to resume by popping out from the back stack? As mentioned before, AndroidMvc will restore the state/model of the controllers the fragments reference which are saved when the fragments are pushed into the back stack.**</p>

<h4>
<a id="more-details-about-dependency-injection-with-poke-see-its-documentation-here" class="anchor" href="#more-details-about-dependency-injection-with-poke-see-its-documentation-here" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><a href="https://github.com/kejunxia/AndroidMvc/tree/master/library/poke">More details about dependency injection with Poke, see its documentation here</a>
</h4>

<h3>
<a id="2-unit-testing-on-asynchronous-actions-eg-http-requests" class="anchor" href="#2-unit-testing-on-asynchronous-actions-eg-http-requests" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2. Unit testing on asynchronous actions, e.g. Http requests</h3>

<p>Below is an example to consume a public weather API from <a href="http://openweathermap.org/api">OpenWeatherMap</a>. To be able to test controller without real http communication, the http request can be abstracted into a service interface. The service interface is injected into controllers. Then in real implementation of the service interface we send http request by http client while in controller testings we mock the service to provide mock data.</p>

<p>See more details in the sample project - Node</p>

<p><strong>Note that, BaseMvcControllerImpl provides protected methods to run actions asynchronously. The ExecutorService is injected into controllers. By default, AndroidMvc framework automatically injects with an implementation running tasks on non-main thread. Whereas in unit tests we can override the injection with an implementation runs the task on the same thread as the caller's so that the asynchronous actions can be tested easier.</strong></p>

<div class="highlight highlight-source-java"><pre><span class="pl-c">/**</span>
<span class="pl-c"> * Run async task on the default ExecutorService injected as a field of this class. Exceptions</span>
<span class="pl-c"> * occur during running the task will be handled by the given {@link AsyncExceptionHandler}.</span>
<span class="pl-c"> *</span>
<span class="pl-c"> * @param sender                who initiated this task</span>
<span class="pl-c"> * @param asyncTask             task to execute</span>
<span class="pl-c"> * @param asyncExceptionHandler error handler for the exception during running the task</span>
<span class="pl-c"> * @return the reference of {@link AsyncTask} that can be used to query its state and cancel it.</span>
<span class="pl-c"> */</span>
<span class="pl-k">protected</span> <span class="pl-smi">AsyncTask</span> runAsyncTask(<span class="pl-smi">Object</span> sender, <span class="pl-smi">AsyncTask</span> asyncTask, <span class="pl-smi">AsyncExceptionHandler</span> asyncExceptionHandler)</pre></div>

<h5>
<a id="1-define-http-service-interface" class="anchor" href="#1-define-http-service-interface" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>1. Define http service interface</h5>

<div class="highlight highlight-source-java"><pre><span class="pl-k">package</span> <span class="pl-smi">com.shipdream.lib.android.mvc.samples.note.service.http</span>;

<span class="pl-k">public</span> <span class="pl-k">interface</span> <span class="pl-en">WeatherService</span> {
    <span class="pl-c">/**</span>
<span class="pl-c">     * Get weathers of the cities with the given ids</span>
<span class="pl-c">     * @param ids Ids of the cities</span>
<span class="pl-c">     * @return The response</span>
<span class="pl-c">     */</span>
    <span class="pl-smi">WeatherListResponse</span> <span class="pl-en">getWeathers</span>(<span class="pl-k">List&lt;<span class="pl-smi">Integer</span>&gt;</span><span class="pl-v">ids</span>) <span class="pl-k">throws</span> <span class="pl-smi">IOException</span>;
}</pre></div>

<h5>
<a id="2-send-and-consume-real-http-service-in-implementation" class="anchor" href="#2-send-and-consume-real-http-service-in-implementation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2. Send and consume real http service in implementation</h5>

<div class="highlight highlight-source-java"><pre><span class="pl-c">/**</span>
<span class="pl-c"> * Note the package structure which is under internal subpackage sharing the same parent package as</span>
<span class="pl-c"> * WeatherService as above</span>
<span class="pl-c"> */</span>
<span class="pl-k">package</span> <span class="pl-smi">com.shipdream.lib.android.mvc.samples.note.service.http.internal</span>;

<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">WeatherServiceImpl</span> <span class="pl-k">implements</span> <span class="pl-e">WeatherService</span>{
    <span class="pl-k">private</span> <span class="pl-smi">HttpClient</span> httpClient;
    <span class="pl-k">private</span> <span class="pl-smi">Gson</span> gson;

    <span class="pl-k">public</span> <span class="pl-en">WeatherServiceImpl</span>() {
        httpClient <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">DefaultHttpClient</span>();
        gson <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">Gson</span>();
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-smi">WeatherListResponse</span> <span class="pl-en">getWeathers</span>(<span class="pl-k">List&lt;<span class="pl-smi">Integer</span>&gt;</span> <span class="pl-v">ids</span>) <span class="pl-k">throws</span> <span class="pl-smi">IOException</span> {
        <span class="pl-smi">String</span> idsStr <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>;
        <span class="pl-k">for</span> (<span class="pl-smi">Integer</span> id <span class="pl-k">:</span> ids) {
            <span class="pl-k">if</span> (<span class="pl-k">!</span>idsStr<span class="pl-k">.</span>isEmpty()) {
                idsStr <span class="pl-k">+=</span> <span class="pl-s"><span class="pl-pds">"</span>, <span class="pl-pds">"</span></span>;
            }
            idsStr <span class="pl-k">+=</span> <span class="pl-smi">String</span><span class="pl-k">.</span>valueOf(id);
        }
        <span class="pl-smi">String</span> url <span class="pl-k">=</span> <span class="pl-smi">String</span><span class="pl-k">.</span>format(<span class="pl-s"><span class="pl-pds">"</span>http://api.openweathermap.org/data/2.5/group?id=%s&amp;units=metric<span class="pl-pds">"</span></span>,
                <span class="pl-smi">URLEncoder</span><span class="pl-k">.</span>encode(idsStr, <span class="pl-s"><span class="pl-pds">"</span>UTF-8<span class="pl-pds">"</span></span>));
        <span class="pl-smi">HttpGet</span> get <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">HttpGet</span>(url);
        <span class="pl-smi">HttpResponse</span> resp <span class="pl-k">=</span> httpClient<span class="pl-k">.</span>execute(get);
        <span class="pl-smi">String</span> responseStr <span class="pl-k">=</span> <span class="pl-smi">EntityUtils</span><span class="pl-k">.</span>toString(resp<span class="pl-k">.</span>getEntity());
        <span class="pl-k">return</span> gson<span class="pl-k">.</span>fromJson(responseStr, <span class="pl-smi">WeatherListResponse</span><span class="pl-k">.</span>class);
    }
}</pre></div>

<h5>
<a id="3-inject-the-http-service-into-weathercontrollerimpl" class="anchor" href="#3-inject-the-http-service-into-weathercontrollerimpl" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>3. Inject the http service into WeatherControllerImpl</h5>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">WeatherControllerImpl</span> <span class="pl-k">extends</span> <span class="pl-e">BaseControllerImpl</span> &lt;<span class="pl-e">WeatherModel</span>&gt; <span class="pl-k">implements</span>
        <span class="pl-e">WeatherController</span>{
    <span class="pl-c1">....</span>

    <span class="pl-k">@Inject</span>
    <span class="pl-k">private</span> <span class="pl-smi">WeatherService</span> weatherService;

    <span class="pl-c">//consume the service and fetch weathers</span>
    <span class="pl-c">//...</span>
}</pre></div>

<h5>
<a id="4-in-controller-unit-test-override-injection-of-executorservice-with-implementation-running-actions-on-the-same-thread-as-the-callers" class="anchor" href="#4-in-controller-unit-test-override-injection-of-executorservice-with-implementation-running-actions-on-the-same-thread-as-the-callers" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>4. In controller unit test, override injection of ExecutorService with implementation running actions on the same thread as the caller's</h5>

<p>Code below is partial implementation, see sample Note in the project for more details.</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">TestWeatherController</span> <span class="pl-k">extends</span> <span class="pl-e">TestControllerBase&lt;<span class="pl-smi">WeatherController</span>&gt;</span> {
<span class="pl-k">@Override</span>
<span class="pl-k">protected</span> <span class="pl-k">void</span> <span class="pl-en">registerDependencies</span>(<span class="pl-smi">MvcGraph</span> <span class="pl-v">mvcGraph</span>) {
    <span class="pl-c1">...</span>

    <span class="pl-c">//Setup mock executor service mock that runs task on the same thread.</span>
    executorService <span class="pl-k">=</span> mock(<span class="pl-smi">ExecutorService</span><span class="pl-k">.</span>class);
    doAnswer(<span class="pl-k">new</span> <span class="pl-smi">Answer</span>() {
        <span class="pl-k">@Override</span>
        <span class="pl-k">public</span> <span class="pl-smi">Object</span> <span class="pl-en">answer</span>(<span class="pl-smi">InvocationOnMock</span> <span class="pl-v">invocation</span>) <span class="pl-k">throws</span> <span class="pl-smi">Throwable</span> {
            <span class="pl-smi">Runnable</span> runnable <span class="pl-k">=</span> (<span class="pl-smi">Runnable</span>) invocation<span class="pl-k">.</span>getArguments()[<span class="pl-c1">0</span>];
            runnable<span class="pl-k">.</span>run();
            <span class="pl-k">return</span> <span class="pl-c1">null</span>;
        }
    })<span class="pl-k">.</span>when(executorService)<span class="pl-k">.</span>submit(any(<span class="pl-smi">Runnable</span><span class="pl-k">.</span>class));

    <span class="pl-c">//Register the injecting component to mvcGraph to override the implementation being injected</span>
    <span class="pl-c">//to controllers</span>
    <span class="pl-smi">TestComp</span> testComp <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">TestComp</span>();
    testComp<span class="pl-k">.</span>testNoteController <span class="pl-k">=</span> <span class="pl-v">this</span>;
    mvcGraph<span class="pl-k">.</span>register(testComp);
}
}</pre></div>

<h5>
<a id="5-test-if-weathercontroller-sends-successful-event-with-good-http-response" class="anchor" href="#5-test-if-weathercontroller-sends-successful-event-with-good-http-response" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>5. Test if WeatherController sends successful event with good http response</h5>

<p>What to mock
1. Http Service to provide good response
2. Event monitor to subscribe to the successful event
So when WeatherController#updateAllCities(Object) is called, we can verify whether the mocked monitor receives the successful event.</p>

<div class="highlight highlight-source-java"><pre>@<span class="pl-smi">Test</span>
<span class="pl-k">public</span> <span class="pl-k">void</span> shouldRaiseSuccessEventForGoodUpdateWeathers() throws <span class="pl-smi">IOException</span> {
    <span class="pl-c">//---Arrange---</span>
    <span class="pl-c">//Define a subscriber class</span>
    <span class="pl-k">class</span> <span class="pl-en">Monitor</span> {
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onEvent</span>(<span class="pl-smi">WeatherController</span>.<span class="pl-smi">EventC2V</span>.<span class="pl-smi">OnWeathersUpdated</span> <span class="pl-v">event</span>) {
        }
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onEvent</span>(<span class="pl-smi">WeatherController</span>.<span class="pl-smi">EventC2V</span>.<span class="pl-smi">OnWeathersUpdateFailed</span> <span class="pl-v">event</span>) {
        }
    }
    <span class="pl-smi">Monitor</span> monitor <span class="pl-k">=</span> mock(<span class="pl-smi">Monitor</span><span class="pl-k">.</span>class);
    <span class="pl-c">//Subscribe to eventBus</span>
    eventBusC2V<span class="pl-k">.</span>register(monitor);

    <span class="pl-c">//Weather service mock prepares a good response</span>
    <span class="pl-smi">WeatherListResponse</span> responseMock <span class="pl-k">=</span> mock(<span class="pl-smi">WeatherListResponse</span><span class="pl-k">.</span>class);
    when(weatherServiceMock<span class="pl-k">.</span>getWeathers(any(<span class="pl-smi">List</span><span class="pl-k">.</span>class)))<span class="pl-k">.</span>thenReturn(responseMock);

    <span class="pl-c">//---Action---</span>
    controllerToTest<span class="pl-k">.</span>updateAllCities(<span class="pl-v">this</span>);

    <span class="pl-c">//---Verify---</span>
    <span class="pl-c">//Success event should be raised</span>
    <span class="pl-k">ArgumentCaptor&lt;<span class="pl-smi">WeatherController</span>.</span><span class="pl-smi">EventC2V</span><span class="pl-k">.</span><span class="pl-smi">OnWeathersUpdated</span><span class="pl-k">&gt;</span> eventSuccess
            <span class="pl-k">=</span> <span class="pl-smi">ArgumentCaptor</span><span class="pl-k">.</span>forClass(<span class="pl-smi">WeatherController</span><span class="pl-k">.</span><span class="pl-smi">EventC2V</span><span class="pl-k">.</span><span class="pl-smi">OnWeathersUpdated</span><span class="pl-k">.</span>class);
    verify(monitor, times(<span class="pl-c1">1</span>))<span class="pl-k">.</span>onEvent(eventSuccess<span class="pl-k">.</span>capture());
    <span class="pl-c">//Failed event should not be raised</span>
    <span class="pl-k">ArgumentCaptor&lt;<span class="pl-smi">WeatherController</span>.</span><span class="pl-smi">EventC2V</span><span class="pl-k">.</span><span class="pl-smi">OnWeathersUpdateFailed</span><span class="pl-k">&gt;</span> eventFailure
            <span class="pl-k">=</span> <span class="pl-smi">ArgumentCaptor</span><span class="pl-k">.</span>forClass(<span class="pl-smi">WeatherController</span><span class="pl-k">.</span><span class="pl-smi">EventC2V</span><span class="pl-k">.</span><span class="pl-smi">OnWeathersUpdateFailed</span><span class="pl-k">.</span>class);
    verify(monitor, times(<span class="pl-c1">0</span>))<span class="pl-k">.</span>onEvent(eventFailure<span class="pl-k">.</span>capture());
}</pre></div>

<h5>
<a id="6-test-if-weathercontroller-sends-failed-event-with-bad-http-response" class="anchor" href="#6-test-if-weathercontroller-sends-failed-event-with-bad-http-response" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>6. <strong>Test if WeatherController sends failed event with bad http response</strong>
</h5>

<p>What to mock
1. Http Service to provide bad response
2. Event monitor to subscribe to the failed event
So when WeatherController#updateAllCities(Object) is called, we can verify whether the mocked monitor receives the failed event.</p>

<div class="highlight highlight-source-java"><pre>@<span class="pl-smi">Test</span>
<span class="pl-k">public</span> <span class="pl-k">void</span> shouldRaiseFailEventForNetworkErrorToUpdateWeathers() throws <span class="pl-smi">IOException</span> {
    <span class="pl-c">//---Arrange---</span>
    <span class="pl-c">//Define a subscriber class</span>
    <span class="pl-k">class</span> <span class="pl-en">Monitor</span> {
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onEvent</span>(<span class="pl-smi">WeatherController</span>.<span class="pl-smi">EventC2V</span>.<span class="pl-smi">OnWeathersUpdated</span> <span class="pl-v">event</span>) {
        }
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onEvent</span>(<span class="pl-smi">WeatherController</span>.<span class="pl-smi">EventC2V</span>.<span class="pl-smi">OnWeathersUpdateFailed</span> <span class="pl-v">event</span>) {
        }
    }
    <span class="pl-smi">Monitor</span> monitor <span class="pl-k">=</span> mock(<span class="pl-smi">Monitor</span><span class="pl-k">.</span>class);
    <span class="pl-c">//Subscribe to eventBus</span>
    eventBusC2V<span class="pl-k">.</span>register(monitor);

    <span class="pl-c">//Weather service mock prepares a bad response</span>
    <span class="pl-c">//by throwing an exception when getting the weather data</span>
    when(weatherServiceMock<span class="pl-k">.</span>getWeathers(any(<span class="pl-smi">List</span><span class="pl-k">.</span>class)))<span class="pl-k">.</span>thenThrow(<span class="pl-k">new</span> <span class="pl-smi">IOException</span>());

    <span class="pl-c">//---Action---</span>
    controllerToTest<span class="pl-k">.</span>updateAllCities(<span class="pl-v">this</span>);

    <span class="pl-c">//---Verify---</span>
    <span class="pl-c">//Success event should not be raised</span>
    <span class="pl-k">ArgumentCaptor&lt;<span class="pl-smi">WeatherController</span>.</span><span class="pl-smi">EventC2V</span><span class="pl-k">.</span><span class="pl-smi">OnWeathersUpdated</span><span class="pl-k">&gt;</span> eventSuccess
            <span class="pl-k">=</span> <span class="pl-smi">ArgumentCaptor</span><span class="pl-k">.</span>forClass(<span class="pl-smi">WeatherController</span><span class="pl-k">.</span><span class="pl-smi">EventC2V</span><span class="pl-k">.</span><span class="pl-smi">OnWeathersUpdated</span><span class="pl-k">.</span>class);
    verify(monitor, times(<span class="pl-c1">0</span>))<span class="pl-k">.</span>onEvent(eventSuccess<span class="pl-k">.</span>capture());
    <span class="pl-c">//Failed event must be raised</span>
    <span class="pl-k">ArgumentCaptor&lt;<span class="pl-smi">WeatherController</span>.</span><span class="pl-smi">EventC2V</span><span class="pl-k">.</span><span class="pl-smi">OnWeathersUpdateFailed</span><span class="pl-k">&gt;</span> eventFailure
            <span class="pl-k">=</span> <span class="pl-smi">ArgumentCaptor</span><span class="pl-k">.</span>forClass(<span class="pl-smi">WeatherController</span><span class="pl-k">.</span><span class="pl-smi">EventC2V</span><span class="pl-k">.</span><span class="pl-smi">OnWeathersUpdateFailed</span><span class="pl-k">.</span>class);
    verify(monitor, times(<span class="pl-c1">1</span>))<span class="pl-k">.</span>onEvent(eventFailure<span class="pl-k">.</span>capture());
}</pre></div>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/kejunxia/AndroidMvc">Android Mvc Framework</a> is maintained by <a href="https://github.com/kejunxia">kejunxia</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

            <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-21820164-19");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
