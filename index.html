<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Android Mvc Framework : Android, Design Pattern, MVC, MVVM, Unit Test, EventBus, Android MVC Framework">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Android Mvc Framework</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/kejunxia/AndroidMvc">View on GitHub</a>

          <h1 id="project_title">Android Mvc Framework</h1>
          <h2 id="project_tagline">Android, Design Pattern, MVC, MVVM, Unit Test, EventBus, Android MVC Framework</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/kejunxia/AndroidMvc/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/kejunxia/AndroidMvc/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a id="androidmvc-framework" class="anchor" href="#androidmvc-framework" aria-hidden="true"><span class="octicon octicon-link"></span></a>AndroidMvc Framework</h1>

<h2>
<a id="introduction" class="anchor" href="#introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction</h2>

<p>First of all, let's look at some problems of the Android development below:</p>

<ul>
<li>
<strong>No enforced design pattern</strong>. That's why there are many questions online asking about how to implement MVC, MVVM, MVP and etc patterns to Android.</li>
<li>
<p><strong>Hard to do unit testing</strong> for Android since the tight coupling of Android components. For example most Android components are heavily depending on "android.Content.Context". Mocking Android components would lead to "Error java.lang.RuntimeException: Stub!".</p>

<p>Though there is a great Android test tool - Robolectric makes it much easier, it only shadows core parts of Android framework because there are too many components there. Another issue sometimes Android frameworks got some bugs and even worse only on specific versions of Android SDK or support library. In this case, pass of test with Roboletric doesn't necessarily guarantee the end to end behavior is correct. For an instance, this bug <a href="https://code.google.com/p/android/issues/detail?id=74222">Nested Fragment doesn't retain instance state as expected since support library v4.rev 20</a> is a serious issue Android team has not targeted for ages. With this bug, if we got a view in a nested fragment, Roboletric may think we can see this view with specific logic. But this view may not show up on real devices.</p>

<p>Furthermore, if the purpose is to test controller or business logic we don't have to use real or even shadowed Android functions. For example, if we are developing a calculator and we can wrap core math functions in a calculator controller. To test the calculator controller, should the controller care about if the view is Android, a mock, HTML or even iOS? No, the controller itself doesn't need to have anything related to Android. We just want to test if we give 1+1 to the controller as input does it return 2. See the samples below or in the github code to see how AndroidMvc abstract Android components out from controllers.</p>
</li>
<li><p><strong>Flawed lifecycle of Activity/Fragment</strong>. Take a news app as an example. Think about this scenario, when the app resumes from background and needs to call services to get latest content to refresh the page. Which lifecycle callback should the refresh logic sit in? onResume? OK, the page would be refreshed on each rotation as well which is definitely NOT what we want. This is just one example of many, you might have seen more conflicting scenarios with the lifecycle that we have to write dodgy code to work around.</p></li>
<li>
<strong>Tedious to manage app instance state</strong>. App is likely to crash when relaunch an activity that has been killed by OS. This doesn't have to happen if all state the activity is referencing is carefully saved and restored. But it is painful as it requires a lot of boilerplate code in onSaveInstanceState and onCreate and still easy to break if anything is missing.</li>
<li>
<strong>Not easy to share state during navigation.</strong> When navigate from one activity to another, if the app needs to share data the data has to be put into Bundle. If the data is not primitive, it needs to be serialised or parceled. Furthermore, this is not fun and mistake prone because it's all key-value pair based which loses the compile time strong type check.</li>
<li>
<strong>Large memory consumption with deep fragments back stack</strong> Android doesn't call onDestroy of fragments if they are pushed into back stack and will hold the memory they used. If we have a deep fragment back stack, it will be a huge waste of memory and the worst to cause out of memory crash! So when a fragment is pushed into back stack, the instances of its holding members could be released as long as it's saved by onSaveInstanceState and restored properly when the fragment is resuming after popped out from the back stack.</li>
</ul>

<p><strong>AndroidMvc framework comes to tackle the problems above and provides more</strong></p>

<h5>
<a id="androidmvc-features" class="anchor" href="#androidmvc-features" aria-hidden="true"><span class="octicon octicon-link"></span></a>AndroidMvc Features</h5>

<ul>
<li>Easy to apply MVC/MVVM pattern for Android development</li>
<li>Easy testing for controllers on JVM without Android dependency</li>
<li>Automatically save restore instance state</li>
<li>Improved Fragment lifecycle

<ul>
<li>
<strong>onViewReady(View view, Bundle savedInstanceState, Reason reason):</strong> Where reason differentiates the cause of creation of view: 1. <strong>FirstTimeCreate</strong>, 2. <strong>Rotated</strong>, 3. <strong>Restored</strong>
</li>
<li>
<strong>onReturnForeground():</strong> When app resume from background</li>
<li>
<strong>onOrientationChanged(int lastOrientation, int currentOrientation):</strong> When app rotated</li>
<li>
<strong>onPushingToBackStack():</strong> When current page is pushed into back stack and navigate to next page</li>
<li>
<strong>onPoppedOutToFront():</strong> When last page is becomes the top page on backwards navigation</li>
</ul>
</li>
<li>Manage navigation by NavigationController which is also testable</li>
<li>Event driven views</li>
<li><a href="https://github.com/kejunxia/AndroidMvc/tree/master/library/poke">Dependency injection to make mock easy</a></li>
<li>Optimized memory consumption. Since most data are abstracted out to models, fragments are much leaner. When fragments are pushed to back stack, AndroidMvc will release controllers the fragments hold. Therefore most of the memory used by the models of the controllers will be freed. When the fragments are popped out of the back stack, AndroidMvc will resume the models of their controllers automatically.</li>
<li>Well tested by jUnit and instrument test with Espresso.</li>
</ul>

<h2>
<a id="download" class="anchor" href="#download" aria-hidden="true"><span class="octicon octicon-link"></span></a>Download</h2>

<p>The library is currently release to jCenter and MavenCentral</p>

<p><strong>Maven:</strong></p>

<div class="highlight highlight-xml"><pre>&lt;<span class="pl-ent">dependency</span>&gt;
    &lt;<span class="pl-ent">groupId</span>&gt;com.shipdream&lt;/<span class="pl-ent">groupId</span>&gt;
    &lt;<span class="pl-ent">artifactId</span>&gt;android-mvc&lt;/<span class="pl-ent">artifactId</span>&gt;
    &lt;<span class="pl-ent">version</span>&gt;1.1.7&lt;/<span class="pl-ent">version</span>&gt;
&lt;/<span class="pl-ent">dependency</span>&gt;</pre></div>

<p><strong>Gradle:</strong></p>

<div class="highlight highlight-groovy"><pre>compile <span class="pl-s"><span class="pl-pds">"</span>com.shipdream:android-mvc:1.1.7<span class="pl-pds">"</span></span></pre></div>

<h2>
<a id="samples" class="anchor" href="#samples" aria-hidden="true"><span class="octicon octicon-link"></span></a>Samples</h2>

<ul>
<li>
<p><strong><a href="https://docs.google.com/uc?authuser=0&amp;id=0BwcZml9gnwoZRS1pYURMMVRzdHM&amp;export=download">Counter</a></strong> - A simple sample demonstrates how to use the framework including dependency injection, event bus, unit testing, navigation and etc.</p>

<p>See <a href="https://github.com/kejunxia/AndroidMvc/tree/master/samples/simple"><strong>Source code</strong> here</a> and download <a href="https://docs.google.com/uc?authuser=0&amp;id=0BwcZml9gnwoZRS1pYURMMVRzdHM&amp;export=download"><strong>Sample APK</strong> here</a></p>
</li>
<li>
<p><strong><a href="https://docs.google.com/uc?authuser=0&amp;id=0BwcZml9gnwoZOHcxZFI3Z0ZGUUk&amp;export=download">Note</a></strong> - A more complex sample to make notes and query weathers with slide menu and also demonstrates how consume network resources (<a href="http://openweathermap.org/api">public weather API</a>) and test the async task without depending on Android SDK on pure JVM.</p>

<p>See <a href="https://github.com/kejunxia/AndroidMvc/tree/master/samples/note"><strong>Source code</strong> here</a> and download <a href="https://docs.google.com/uc?authuser=0&amp;id=0BwcZml9gnwoZOHcxZFI3Z0ZGUUk&amp;export=download"><strong>Sample APK</strong> here</a></p>
</li>
</ul>

<h2>
<a id="overview" class="anchor" href="#overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Overview</h2>

<p><img src="https://github.com/kejunxia/AndroidMvc/blob/master/documents/imgs/Android-Mvc-Pattern.jpg?raw=true" alt="alt Android-Mvc-Pattern"></p>

<p>AndroidMvc is event driven. To isolate events between different layers, there are 3 event buses pre-setup in the framework:</p>

<ul>
<li>
<strong>EventBusC2V</strong> (Controllers to Views): One way event bus routing events from controllers to views. Events sent to views will be guaranteed to be run on Android UI thread by the framework.</li>
<li>
<strong>EventBusC2C</strong> (Controllers to Controllers): Routes events among controllers. Events will be received on the same thread who send them.</li>
<li>
<strong>EventBusV2V</strong> (Views to views): Routes events among views. Events will be received on the same thread who send them.</li>
</ul>

<h4>
<a id="view" class="anchor" href="#view" aria-hidden="true"><span class="octicon octicon-link"></span></a>View</h4>

<p>All views should be <strong>as lean as possible</strong> because their responsibilities are only to capture user interactions and display data. Then as long as controllers are unit tested properly it's less likely to make mistake on view layer. Therefore, business logic can be maximally abstracted away from views into controllers. As a result, more business logic can be unit tested against controllers directly.</p>

<p>At a high level, all components of Android framework could be considered as views including activities, fragments, widgets and even services and etc, because as mentioned above, responsibilities of all Android components are just to capture user interactions and present data to users.</p>

<p>An analogy is that we can think Android as a browser. HTML (&lt;!doctype html&gt;) is like an activity, iFrame or a Ajax driven div is like a fragment and a javascript timer running as a polling loop is like a Android service. So as we can see, like what a service oriented web app does, all business logic should not be put on the front end (html/css/javascript) but in controllers on backend such as servlet, php, nodejs, asp.net and etc.</p>

<h4>
<a id="controller" class="anchor" href="#controller" aria-hidden="true"><span class="octicon octicon-link"></span></a>Controller</h4>

<p>Controllers manage business logic including how to retrieve, calculate, format and wrap the data into event sending back to views. Controllers are defined in Java interfaces and injected into views via annotation <a href="https://github.com/Inject" class="user-mention">@Inject</a>. In this way, the controllers would be easy to mocked against the interface definition. Views subscribe to events defined by those controller interfaces. When views receive user interactions, they invoke methods against the injected controller interfaces. The underlining controller implementations will process the request by required business logic and send processed data back to views by events through <strong>EventBusC2V</strong> that views have subscribed on.</p>

<p>Note that, in this MVC design, all controllers are <strong>SINGLETON</strong> application wide so that the state of controllers are guaranteed from the same source of truth.</p>

<h4>
<a id="model" class="anchor" href="#model" aria-hidden="true"><span class="octicon octicon-link"></span></a>Model</h4>

<p>Models in AndroidMVC design encapsulate and represent the state of controllers. So each controller has only one model object to represent the state of the specific business logic. When the controllers are requested to process data, they will manage the model and box and format part of or entire model into an event subscribed by view and notify the views to update themselves by the data conveyed by the event. Alternatively, the views can also directly read the model from the controllers injected into them as long as their is no much formatting requirement. But make sure, views should NOT change the value of models directly which should be only done by controllers.</p>

<p>In addition, to reduce boiler plate code, AndroidMvc framework will automatically save and restore the instance state of the controller models. So we don't need to always manually write code manually to use saveInstanceState and restore them in onCreate.</p>

<h4>
<a id="events" class="anchor" href="#events" aria-hidden="true"><span class="octicon octicon-link"></span></a>Events</h4>

<p>With the builtin EventBus, events are defined as Java classes. It's also recommended to define them in controller interfaces to namespace them, so that we know what do the events do with more context. In addition, in a complex application with thousands of different events, the events won't be scattered everywhere. Events defined as Java classes instead of strings like Android messages has many benefits such as 1. extra data can be self-contained in them, 2. they are strong typed which avoids typo that can make debugging like a disaster, 3. strong typed events are also easier to track through inside IDEs (Android Studio, Eclipse and etc).</p>

<p>Once a event is defined, it can be broadcast to multiple views who subscribe to them. When events contain data, they can be thought as a partial <strong>ViewModel</strong> that will drive subscribed views to update themselves. So to some extent AndroidMvc could be thought as a variant of <strong>MVVM</strong> pattern as well.</p>

<p>To use it as a traditional <strong>MVVM</strong> or an Ajax like MVVM is totally depending on how the events are designed. For example, we can define only one event for a controller called EventC2V.OnModelUpdate and whenever the controller updates the model it raise this event. In this way, it's exactly the same as the traditional <strong>MVVM</strong> pattern. Also we can divide the update of model into more granular events, then it's like Ajax in web app and the earlier approach is like to refresh the whole page whenever there is a model update.</p>

<h2>
<a id="using-androidmvc" class="anchor" href="#using-androidmvc" aria-hidden="true"><span class="octicon octicon-link"></span></a>Using AndroidMvc</h2>

<p>Let's take a simple app counting number as an example. The counter app has two navigation locations:
1. LocationA: presented by FragmentA</p>

<ul>
<li>One text view to display the current count in number. Updated by event OnCounterUpdated</li>
<li>Two buttons which increment and decrement count <strong>on click</strong>.</li>
<li>An nested fragment with a TextView to display count in English. Updated by event OnCounterUpdated too</li>
<li>An button to show advance view which results in navigating to LocationB</li>
<li>Shares the result of counting updated by LocationB

<ol>
<li>LocationB: presented by FragmentB</li>
</ol>
</li>
<li>One text view to display the current count in number. Updated by event OnCounterUpdated</li>
<li>Two buttons which increment and decrement count <strong>continuously on hold</strong>.</li>
<li>Shares the result of counting updated by LocationB</li>
</ul>

<p>Below is how to use AndroidMvc framework to implement and test the app including navigation. Note the code below doesn't show all code. To see more details check the sample project in the app - Simple under samples subfolder.</p>

<h5>
<a id="1-extend-mvcactivity-for-the-single-activity" class="anchor" href="#1-extend-mvcactivity-for-the-single-activity" aria-hidden="true"><span class="octicon octicon-link"></span></a>1. Extend MvcActivity for the single Activity</h5>

<div class="highlight highlight-java"><pre><span class="pl-c">/**</span>
<span class="pl-c"> * Single activity for the app</span>
<span class="pl-c"> */</span>
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">MainActivity</span> <span class="pl-k">extends</span> <span class="pl-e">MvcActivity</span> {
    <span class="pl-c">/**</span>
<span class="pl-c">     * Define how to map navigation location id to full screen fragments</span>
<span class="pl-c">     * @param locationId The location id in string</span>
<span class="pl-c">     * @return The class of the fragment representing the navigation locations</span>
<span class="pl-c">     */</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">protected</span> <span class="pl-k">Class&lt;? extends <span class="pl-smi">MvcFragment</span>&gt;</span> <span class="pl-en">mapNavigationFragment</span>(<span class="pl-smi">String</span> <span class="pl-v">locationId</span>) {
        <span class="pl-k">switch</span> (locationId) {
            <span class="pl-k">case</span> <span class="pl-s"><span class="pl-pds">"</span>LocationA<span class="pl-pds">"</span></span><span class="pl-k">:</span>
                <span class="pl-k">return</span> <span class="pl-smi">FragmentA</span><span class="pl-k">.</span>class;
            <span class="pl-k">case</span> <span class="pl-s"><span class="pl-pds">"</span>LocationB<span class="pl-pds">"</span></span><span class="pl-k">:</span>
                <span class="pl-k">return</span> <span class="pl-smi">FragmentB</span><span class="pl-k">.</span>class;
            <span class="pl-k">default</span><span class="pl-k">:</span>
                <span class="pl-k">return</span> <span class="pl-c1">null</span>;
        }
    }

    <span class="pl-c">/**</span>
<span class="pl-c">     * Define the delegate fragment for the activity</span>
<span class="pl-c">     * @return</span>
<span class="pl-c">     */</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">protected</span> <span class="pl-k">Class&lt;? extends <span class="pl-smi">DelegateFragment</span>&gt;</span> <span class="pl-en">getDelegateFragmentClass</span>() {
        <span class="pl-k">return</span> <span class="pl-smi">ContainerFragment</span><span class="pl-k">.</span>class;
    }

    <span class="pl-c">/**</span>
<span class="pl-c">     * Container fragment extends DelegateFragment would be the root container fragments to swap</span>
<span class="pl-c">     * full screen fragments inside it on navigation.</span>
<span class="pl-c">     */</span>
    <span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-k">class</span> <span class="pl-en">ContainerFragment</span> <span class="pl-k">extends</span> <span class="pl-e">DelegateFragment</span> {
        <span class="pl-c">/**</span>
<span class="pl-c">         * What to do when app starts for the first time</span>
<span class="pl-c">         */</span>
        <span class="pl-k">@Override</span>
        <span class="pl-k">protected</span> <span class="pl-k">void</span> <span class="pl-en">onStartUp</span>() {
            <span class="pl-c">//Navigate to location a when app starts for the first time by navigation controller</span>
            <span class="pl-c">//here we navigate to LocationA which result in load FragmentA mapped by the</span>
            <span class="pl-c">//the method mapNavigationFragment above</span>
            getNavigationController()<span class="pl-k">.</span>navigateTo(<span class="pl-v">this</span>, <span class="pl-s"><span class="pl-pds">"</span>LocationA<span class="pl-pds">"</span></span>);
        }
    }
}</pre></div>

<h5>
<a id="2-create-fragmenta-to-present-locationa" class="anchor" href="#2-create-fragmenta-to-present-locationa" aria-hidden="true"><span class="octicon octicon-link"></span></a>2. Create FragmentA to present "LocationA"</h5>

<div class="highlight highlight-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">FragmentA</span> <span class="pl-k">extends</span> <span class="pl-e">MvcFragment</span> {
    <span class="pl-c">/**</span>
<span class="pl-c">     * @return Layout id used to inflate the view of this MvcFragment.</span>
<span class="pl-c">     */</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">protected</span> <span class="pl-k">int</span> <span class="pl-en">getLayoutResId</span>() {
        <span class="pl-k">return</span> <span class="pl-smi">R</span><span class="pl-k">.</span>layout<span class="pl-k">.</span>fragment_a;
    }
}</pre></div>

<h5>
<a id="3-create-a-controller-contract-and-the-model-its-managing" class="anchor" href="#3-create-a-controller-contract-and-the-model-its-managing" aria-hidden="true"><span class="octicon octicon-link"></span></a>3. Create a controller contract and the model it's managing</h5>

<div class="highlight highlight-java"><pre><span class="pl-k">package</span> <span class="pl-smi">com.shipdream.lib.android.mvc.samples.simple.controller</span>;

<span class="pl-c">/**</span>
<span class="pl-c"> * Define controller contract and its events. And specify which model it manages by binding the</span>
<span class="pl-c"> * model type.</span>
<span class="pl-c"> */</span>
<span class="pl-k">public</span> <span class="pl-k">interface</span> <span class="pl-en">CounterController</span> <span class="pl-k">extends</span> <span class="pl-e">BaseController&lt;<span class="pl-smi">CounterModel</span>&gt;</span> {
    <span class="pl-c">/**</span>
<span class="pl-c">     * Increment count and will raise {@link EventC2V.OnCounterUpdated}</span>
<span class="pl-c">     * @param sender Who requests this action</span>
<span class="pl-c">     */</span>
    <span class="pl-k">void</span> <span class="pl-en">increment</span>(<span class="pl-smi">Object</span> <span class="pl-v">sender</span>);

    <span class="pl-c">/**</span>
<span class="pl-c">     * Decrement count and will raise {@link EventC2V.OnCounterUpdated}</span>
<span class="pl-c">     * @param sender Who requests this action</span>
<span class="pl-c">     */</span>
    <span class="pl-k">void</span> <span class="pl-en">decrement</span>(<span class="pl-smi">Object</span> <span class="pl-v">sender</span>);

    <span class="pl-c">/**</span>
<span class="pl-c">     * Method to convert number to english</span>
<span class="pl-c">     * @param number</span>
<span class="pl-c">     * @return</span>
<span class="pl-c">     */</span>
    <span class="pl-smi">String</span> <span class="pl-en">convertNumberToEnglish</span>(<span class="pl-k">int</span> <span class="pl-v">number</span>);

    <span class="pl-c">/**</span>
<span class="pl-c">     * Namespace the events for this controller by nested interface so that all its events would</span>
<span class="pl-c">     * be referenced as CounterController.EventC2V.BlaBlaEvent</span>
<span class="pl-c">     */</span>
    <span class="pl-k">interface</span> <span class="pl-en">EventC2V</span> {
        <span class="pl-c">/**</span>
<span class="pl-c">         * Event to notify views counter has been updated</span>
<span class="pl-c">         */</span>
        <span class="pl-k">class</span> <span class="pl-en">OnCounterUpdated</span> <span class="pl-k">extends</span> <span class="pl-e">BaseEventC2V</span> {
            <span class="pl-k">private</span> <span class="pl-k">final</span> <span class="pl-k">int</span> count;
            <span class="pl-k">private</span> <span class="pl-k">final</span> <span class="pl-smi">String</span> countInEnglish;
            <span class="pl-k">public</span> <span class="pl-en">OnCounterUpdated</span>(<span class="pl-smi">Object</span> <span class="pl-v">sender</span>, <span class="pl-k">int</span> <span class="pl-v">count</span>, <span class="pl-smi">String</span> <span class="pl-v">countInEnglish</span>) {
                <span class="pl-v">super</span>(sender);
                <span class="pl-v">this</span><span class="pl-k">.</span>count <span class="pl-k">=</span> count;
                <span class="pl-v">this</span><span class="pl-k">.</span>countInEnglish <span class="pl-k">=</span> countInEnglish;
            }

            <span class="pl-k">public</span> <span class="pl-k">int</span> <span class="pl-en">getCount</span>() {
                <span class="pl-k">return</span> count;
            }

            <span class="pl-k">public</span> <span class="pl-smi">String</span> <span class="pl-en">getCountInEnglish</span>() {
                <span class="pl-k">return</span> countInEnglish;
            }
        }
    }
}</pre></div>

<h5>
<a id="3-implement-the-controller" class="anchor" href="#3-implement-the-controller" aria-hidden="true"><span class="octicon octicon-link"></span></a>3. Implement the controller</h5>

<p><strong>Note that, to allow AndroidMvc to find the default implementation of injectable object, the implementation class must be under the sub-package "internal" which resides in the same parent package as the interface and the name must be [InterfaceName]Impl.</strong> For this example, say CounterController is under package samples.simple.controller the  implementation must be named as CounterControllerImpl and placed under package samples.simple.controller.internal</p>

<div class="highlight highlight-java"><pre><span class="pl-c">/**</span>
<span class="pl-c"> * Note the structure of the package name. It is in a subpackage(internal) sharing the same parent</span>
<span class="pl-c"> * package as the controller interface CounterController</span>
<span class="pl-c"> */</span>
<span class="pl-k">package</span> <span class="pl-smi">com.shipdream.lib.android.mvc.samples.simple.controller.internal</span>;

<span class="pl-c">/**</span>
<span class="pl-c"> * Note the class name is [CounterController]Impl.</span>
<span class="pl-c"> */</span>
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">CounterControllerImpl</span> <span class="pl-k">extends</span> <span class="pl-e">BaseControllerImpl&lt;<span class="pl-smi">CounterModel</span>&gt;</span> <span class="pl-k">implements</span> <span class="pl-e">CounterController</span>{
    <span class="pl-c">/**</span>
<span class="pl-c">     * Just return the class type of the model managed by this controller</span>
<span class="pl-c">     * @return</span>
<span class="pl-c">     */</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">protected</span> <span class="pl-k">Class&lt;<span class="pl-smi">CounterModel</span>&gt;</span> <span class="pl-en">getModelClassType</span>() {
        <span class="pl-k">return</span> <span class="pl-smi">CounterModel</span><span class="pl-k">.</span>class;
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">increment</span>(<span class="pl-smi">Object</span> <span class="pl-v">sender</span>) {
        <span class="pl-k">int</span> count <span class="pl-k">=</span> getModel()<span class="pl-k">.</span>getCount();
        getModel()<span class="pl-k">.</span>setCount(<span class="pl-k">++</span>count);
        <span class="pl-c">//Post controller to view event to views</span>
        postC2VEvent(<span class="pl-k">new</span> <span class="pl-smi">EventC2V</span>.<span class="pl-smi">OnCounterUpdated</span>(sender, count, convertNumberToEnglish(count)));
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">decrement</span>(<span class="pl-smi">Object</span> <span class="pl-v">sender</span>) {
        <span class="pl-k">int</span> count <span class="pl-k">=</span> getModel()<span class="pl-k">.</span>getCount();
        getModel()<span class="pl-k">.</span>setCount(<span class="pl-k">--</span>count);
        <span class="pl-c">//Post controller to view event to views</span>
        postC2VEvent(<span class="pl-k">new</span> <span class="pl-smi">EventC2V</span>.<span class="pl-smi">OnCounterUpdated</span>(sender, count, convertNumberToEnglish(count)));
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-smi">String</span> <span class="pl-en">convertNumberToEnglish</span>(<span class="pl-k">int</span> <span class="pl-v">number</span>) {
        <span class="pl-k">if</span> (number <span class="pl-k">&lt;</span> <span class="pl-k">-</span><span class="pl-c1">3</span>) {
            <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>Less than negative three<span class="pl-pds">"</span></span>;
        } <span class="pl-k">else</span>  <span class="pl-k">if</span> (number <span class="pl-k">==</span> <span class="pl-k">-</span><span class="pl-c1">3</span>) {
            <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>Negative three<span class="pl-pds">"</span></span>;
        } <span class="pl-k">else</span>  <span class="pl-k">if</span> (number <span class="pl-k">==</span> <span class="pl-k">-</span><span class="pl-c1">2</span>) {
            <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>Negative two<span class="pl-pds">"</span></span>;
        } <span class="pl-k">else</span>  <span class="pl-k">if</span> (number <span class="pl-k">==</span> <span class="pl-k">-</span><span class="pl-c1">1</span>) {
            <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>Negative one<span class="pl-pds">"</span></span>;
        } <span class="pl-k">else</span> <span class="pl-k">if</span> (number <span class="pl-k">==</span> <span class="pl-c1">0</span>) {
            <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>Zero<span class="pl-pds">"</span></span>;
        } <span class="pl-k">else</span> <span class="pl-k">if</span> (number <span class="pl-k">==</span> <span class="pl-c1">1</span>) {
            <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>One<span class="pl-pds">"</span></span>;
        } <span class="pl-k">else</span> <span class="pl-k">if</span> (number <span class="pl-k">==</span> <span class="pl-c1">2</span>) {
            <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>Two<span class="pl-pds">"</span></span>;
        } <span class="pl-k">else</span> <span class="pl-k">if</span> (number <span class="pl-k">==</span> <span class="pl-c1">3</span>) {
            <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>Three<span class="pl-pds">"</span></span>;
        } <span class="pl-k">else</span> {
            <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>Greater than three<span class="pl-pds">"</span></span>;
        }
    }
}</pre></div>

<h5>
<a id="4-inject-controller-into-views-setup-views-and-handle-c2v-events-from-controllers" class="anchor" href="#4-inject-controller-into-views-setup-views-and-handle-c2v-events-from-controllers" aria-hidden="true"><span class="octicon octicon-link"></span></a>4. Inject Controller into Views, setup views and handle C2V events from controllers</h5>

<div class="highlight highlight-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">FragmentA</span> <span class="pl-k">extends</span> <span class="pl-e">MvcFragment</span> {
    <span class="pl-k">@Inject</span>
    <span class="pl-k">private</span> <span class="pl-smi">CounterController</span> counterController;

    <span class="pl-k">private</span> <span class="pl-smi">TextView</span> display;
    <span class="pl-k">private</span> <span class="pl-smi">Button</span> increment;
    <span class="pl-k">private</span> <span class="pl-smi">Button</span> decrement;

    <span class="pl-c">/**</span>
<span class="pl-c">     * @return Layout id used to inflate the view of this MvcFragment.</span>
<span class="pl-c">     */</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">protected</span> <span class="pl-k">int</span> <span class="pl-en">getLayoutResId</span>() {
        <span class="pl-k">return</span> <span class="pl-smi">R</span><span class="pl-k">.</span>layout<span class="pl-k">.</span>fragment_a;
    }

    <span class="pl-c">/**</span>
<span class="pl-c">     * Lifecycle similar to onViewCreated by with more granular control with an extra argument to</span>
<span class="pl-c">     * indicate why this view is created: 1. first time created, or 2. rotated or 3. restored</span>
<span class="pl-c">     * @param view The root view of the fragment</span>
<span class="pl-c">     * @param savedInstanceState The savedInstanceState when the fragment is being recreated after</span>
<span class="pl-c">     *                           its enclosing activity is killed by OS, otherwise null including on</span>
<span class="pl-c">     *                           rotation</span>
<span class="pl-c">     * @param reason Indicates the {@link Reason} why the onViewReady is called.</span>
<span class="pl-c">     */</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onViewReady</span>(<span class="pl-smi">View</span> <span class="pl-v">view</span>, <span class="pl-smi">Bundle</span> <span class="pl-v">savedInstanceState</span>, <span class="pl-smi">Reason</span> <span class="pl-v">reason</span>) {
        <span class="pl-v">super</span><span class="pl-k">.</span>onViewReady(view, savedInstanceState, reason);

        display <span class="pl-k">=</span> (<span class="pl-smi">TextView</span>) view<span class="pl-k">.</span>findViewById(<span class="pl-smi">R</span><span class="pl-k">.</span>id<span class="pl-k">.</span>fragment_a_counterDisplay);
        increment <span class="pl-k">=</span> (<span class="pl-smi">Button</span>) view<span class="pl-k">.</span>findViewById(<span class="pl-smi">R</span><span class="pl-k">.</span>id<span class="pl-k">.</span>fragment_a_buttonIncrement);
        decrement <span class="pl-k">=</span> (<span class="pl-smi">Button</span>) view<span class="pl-k">.</span>findViewById(<span class="pl-smi">R</span><span class="pl-k">.</span>id<span class="pl-k">.</span>fragment_a_buttonDecrement);

        increment<span class="pl-k">.</span>setOnClickListener(<span class="pl-k">new</span> <span class="pl-smi">View</span>.<span class="pl-smi">OnClickListener</span>() {
            <span class="pl-k">@Override</span>
            <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onClick</span>(<span class="pl-smi">View</span> <span class="pl-v">v</span>) {
                counterController<span class="pl-k">.</span>increment(v);
            }
        });

        decrement<span class="pl-k">.</span>setOnClickListener(<span class="pl-k">new</span> <span class="pl-smi">View</span>.<span class="pl-smi">OnClickListener</span>() {
            <span class="pl-k">@Override</span>
            <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onClick</span>(<span class="pl-smi">View</span> <span class="pl-v">v</span>) {
                counterController<span class="pl-k">.</span>decrement(v);
            }
        });

        updateCountDisplay(counterController<span class="pl-k">.</span>getModel()<span class="pl-k">.</span>getCount());
    }

    <span class="pl-c">/**</span>
<span class="pl-c">     * Callback when the fragment is popped out by back navigation</span>
<span class="pl-c">     */</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">protected</span> <span class="pl-k">void</span> <span class="pl-en">onPoppedOutToFront</span>() {
        <span class="pl-v">super</span><span class="pl-k">.</span>onPoppedOutToFront();
        updateCountDisplay(counterController<span class="pl-k">.</span>getModel()<span class="pl-k">.</span>getCount());
    }

    <span class="pl-c">//Define event handler by method named as onEvent with single parameter of the event type</span>
    <span class="pl-c">//to respond event CounterController.EventC2V.OnCounterUpdated</span>
    <span class="pl-k">private</span> <span class="pl-k">void</span> <span class="pl-en">onEvent</span>(<span class="pl-smi">CounterController</span>.<span class="pl-smi">EventC2V</span>.<span class="pl-smi">OnCounterUpdated</span> <span class="pl-v">event</span>) {
        updateCountDisplay(event<span class="pl-k">.</span>getCount());
    }

    <span class="pl-c">/**</span>
<span class="pl-c">     * Update the text view of count number</span>
<span class="pl-c">     * @param count The number of count</span>
<span class="pl-c">     */</span>
    <span class="pl-k">private</span> <span class="pl-k">void</span> <span class="pl-en">updateCountDisplay</span>(<span class="pl-k">int</span> <span class="pl-v">count</span>) {
        display<span class="pl-k">.</span>setText(<span class="pl-smi">String</span><span class="pl-k">.</span>valueOf(count));
    }
}</pre></div>

<h5>
<a id="5-unit-tests-on-controllers" class="anchor" href="#5-unit-tests-on-controllers" aria-hidden="true"><span class="octicon octicon-link"></span></a>5. Unit tests on controllers</h5>

<p>As discussed before, business logic should be decoupled from view(Android components) and abstracted to controllers, then we can pretty much test most logic just on controllers without dependencies of any Android components. Views just need to make sure data carried back from controllers are displayed correctly. Whether or not the data is processed correctly is completely controllers' responsibilities that is what is being tested here.</p>

<div class="highlight highlight-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">TestCounterController</span> {
    <span class="pl-c1">..</span><span class="pl-k">.</span>other dependencies are omitted here

    <span class="pl-k">private</span> <span class="pl-smi">CounterController</span> counterController;

    <span class="pl-k">@Before</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">setUp</span>() <span class="pl-k">throws</span> <span class="pl-smi">Exception</span> {
        <span class="pl-c1">..</span><span class="pl-k">.</span>other dependencies are omitted here

        <span class="pl-c">//create instance of CounterController</span>
        counterController <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">CounterControllerImpl</span>();
        counterController<span class="pl-k">.</span>init();
    }

    <span class="pl-k">@Test</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">increment_should_post_counter_update_event_with_incremented_value</span>() {
        <span class="pl-c">//1. Prepare</span>
        <span class="pl-c">//prepare event monitor</span>
        <span class="pl-k">class</span> <span class="pl-en">Monitor</span> {
            <span class="pl-k">void</span> <span class="pl-en">onEvent</span>(<span class="pl-smi">CounterController</span>.<span class="pl-smi">EventC2V</span>.<span class="pl-smi">OnCounterUpdated</span> <span class="pl-v">event</span>) {
            }
        }
        <span class="pl-smi">Monitor</span> monitor <span class="pl-k">=</span> mock(<span class="pl-smi">Monitor</span><span class="pl-k">.</span>class);
        eventBusC2V<span class="pl-k">.</span>register(monitor);

        <span class="pl-c">//mock controller model for count value</span>
        <span class="pl-k">int</span> value <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">Random</span>()<span class="pl-k">.</span>nextInt();
        <span class="pl-smi">CounterModel</span> counterModel <span class="pl-k">=</span> mock(<span class="pl-smi">CounterModel</span><span class="pl-k">.</span>class);
        when(counterModel<span class="pl-k">.</span>getCount())<span class="pl-k">.</span>thenReturn(value);
        <span class="pl-c">//Bind the mock model to the controller</span>
        counterController<span class="pl-k">.</span>bindModel(<span class="pl-v">this</span>, counterModel);

        <span class="pl-c">//2. Act</span>
        counterController<span class="pl-k">.</span>increment(<span class="pl-v">this</span>);

        <span class="pl-c">//3. Verify</span>
        <span class="pl-k">ArgumentCaptor&lt;<span class="pl-smi">CounterController</span>.</span><span class="pl-smi">EventC2V</span><span class="pl-k">.</span><span class="pl-smi">OnCounterUpdated</span><span class="pl-k">&gt;</span> updateEvent
                <span class="pl-k">=</span> <span class="pl-smi">ArgumentCaptor</span><span class="pl-k">.</span>forClass(<span class="pl-smi">CounterController</span><span class="pl-k">.</span><span class="pl-smi">EventC2V</span><span class="pl-k">.</span><span class="pl-smi">OnCounterUpdated</span><span class="pl-k">.</span>class);
        <span class="pl-c">//event should be fired once</span>
        verify(monitor, times(<span class="pl-c1">1</span>))<span class="pl-k">.</span>onEvent(updateEvent<span class="pl-k">.</span>capture());
        <span class="pl-c">//event should carry incremented value</span>
        <span class="pl-smi">Assert</span><span class="pl-k">.</span>assertEquals(value <span class="pl-k">+</span> <span class="pl-c1">1</span>, updateEvent<span class="pl-k">.</span>getValue()<span class="pl-k">.</span>getCount());
    }
}</pre></div>

<h5>
<a id="5-navigation" class="anchor" href="#5-navigation" aria-hidden="true"><span class="octicon octicon-link"></span></a>5. Navigation</h5>

<p>Instead creating, replacing or popping full screen fragments by FragmentManager of Android Activity, AndroidMvc provides NavigationController to manage navigation. Therefore, navigation logic can be abstracted out from View layer. To make navigation easier to be tested, we can inject NavigationController to CounterController and then test the model of NavigationController to verify if navigation location is changed as expected.</p>

<h5>
<a id="51-add-two-methods-to-countercontroller-to-wrap-navigation-logic" class="anchor" href="#51-add-two-methods-to-countercontroller-to-wrap-navigation-logic" aria-hidden="true"><span class="octicon octicon-link"></span></a>5.1. Add two methods to CounterController to wrap navigation logic</h5>

<div class="highlight highlight-java"><pre><span class="pl-k">public</span> <span class="pl-k">interface</span> <span class="pl-en">CounterController</span> <span class="pl-k">extends</span> <span class="pl-e">BaseController&lt;<span class="pl-smi">CounterModel</span>&gt;</span> {
    <span class="pl-c1">...</span> other methods

    <span class="pl-c">/**</span>
<span class="pl-c">     * Navigate to LocationB by {@link NavigationController}to show advance view that can update</span>
<span class="pl-c">     * count continuously by holding buttons.</span>
<span class="pl-c">     * @param sender</span>
<span class="pl-c">     */</span>
    <span class="pl-k">void</span> <span class="pl-en">goToAdvancedView</span>(<span class="pl-smi">Object</span> <span class="pl-v">sender</span>);

    <span class="pl-c">/**</span>
<span class="pl-c">     * Navigate back to LocationA by {@link NavigationController}to show basic view from LocationB</span>
<span class="pl-c">     * @param sender</span>
<span class="pl-c">     */</span>
    <span class="pl-k">void</span> <span class="pl-en">goBackToBasicView</span>(<span class="pl-smi">Object</span> <span class="pl-v">sender</span>);

    <span class="pl-c1">...</span> other methods
}</pre></div>

<h5>
<a id="52-inject-navigationcontroller-to-countercontrollerimpl-and-implement-navigation-methods" class="anchor" href="#52-inject-navigationcontroller-to-countercontrollerimpl-and-implement-navigation-methods" aria-hidden="true"><span class="octicon octicon-link"></span></a>5.2. Inject NavigationController to CounterControllerImpl and implement navigation methods</h5>

<div class="highlight highlight-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">CounterControllerImpl</span> <span class="pl-k">extends</span> <span class="pl-e">BaseControllerImpl&lt;<span class="pl-smi">CounterModel</span>&gt;</span> <span class="pl-k">implements</span> <span class="pl-e">CounterController</span>{
    <span class="pl-c1">...</span> other methods

    <span class="pl-k">@Inject</span>
    <span class="pl-smi">NavigationController</span> navigationController;

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">goToAdvancedView</span>(<span class="pl-smi">Object</span> <span class="pl-v">sender</span>) {
        navigationController<span class="pl-k">.</span>navigateTo(sender, <span class="pl-s"><span class="pl-pds">"</span>LocationB<span class="pl-pds">"</span></span>);
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">goBackToBasicView</span>(<span class="pl-smi">Object</span> <span class="pl-v">sender</span>) {
        navigationController<span class="pl-k">.</span>navigateBack(sender);
    }

    <span class="pl-c1">...</span> other methods
}</pre></div>

<h5>
<a id="53-invoke-countercontroller-methods-wrapping-navigation-in-views" class="anchor" href="#53-invoke-countercontroller-methods-wrapping-navigation-in-views" aria-hidden="true"><span class="octicon octicon-link"></span></a>5.3. Invoke CounterController methods wrapping navigation in views</h5>

<div class="highlight highlight-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">FragmentA</span> <span class="pl-k">extends</span> <span class="pl-e">MvcFragment</span> {
    <span class="pl-c1">...</span>

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onViewReady</span>(<span class="pl-smi">View</span> <span class="pl-v">view</span>, <span class="pl-smi">Bundle</span> <span class="pl-v">savedInstanceState</span>, <span class="pl-smi">Reason</span> <span class="pl-v">reason</span>) {
        <span class="pl-v">super</span><span class="pl-k">.</span>onViewReady(view, savedInstanceState, reason);

        <span class="pl-c1">...</span>

        buttonShowAdvancedView<span class="pl-k">.</span>setOnClickListener(<span class="pl-k">new</span> <span class="pl-smi">View</span>.<span class="pl-smi">OnClickListener</span>() {
            <span class="pl-k">@Override</span>
            <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onClick</span>(<span class="pl-smi">View</span> <span class="pl-v">v</span>) {
                <span class="pl-c">//Use counterController to manage navigation to make navigation testable</span>
                counterController<span class="pl-k">.</span>goToAdvancedView(v);
                <span class="pl-c">//Or we can use NavigationController directly though it's harder to unit test on</span>
                <span class="pl-c">//controller level.</span>
                <span class="pl-c">//example:</span>
                <span class="pl-c">//navigationController.navigateTo(v, "LocationB");</span>
            }
        });

        <span class="pl-c1">...</span>
    }

    <span class="pl-c1">...</span>
}

<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">FragmentB</span> <span class="pl-k">extends</span> <span class="pl-e">MvcFragment</span> {
    <span class="pl-c1">...</span>

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">boolean</span> <span class="pl-en">onBackButtonPressed</span>() {
        <span class="pl-c">//Use counterController to manage navigation back make navigation testable</span>
        counterController<span class="pl-k">.</span>goBackToBasicView(<span class="pl-v">this</span>);
        <span class="pl-c">//Return true to not pass the back button pressed event to upper level handler.</span>
        <span class="pl-k">return</span> <span class="pl-c1">true</span>;
        <span class="pl-c">//Or we can let the fragment manage back navigation back automatically where we don't</span>
        <span class="pl-c">//override this method which will call NavigationController.navigateBack(Object sender)</span>
        <span class="pl-c">//automatically</span>
    }

    <span class="pl-c1">...</span>
}</pre></div>

<h5>
<a id="54-able-to-test-navigation-on-countercontroller" class="anchor" href="#54-able-to-test-navigation-on-countercontroller" aria-hidden="true"><span class="octicon octicon-link"></span></a>5.4. Able to test navigation on CounterController</h5>

<div class="highlight highlight-java"><pre>    @<span class="pl-smi">Test</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> should_navigate_to_locationB_when_go_to_advance_view_and_back_to_locationA_after_go_to_basic_view() {
        <span class="pl-c">//Prepare</span>
        <span class="pl-smi">NavigationController</span> navigationController <span class="pl-k">=</span> ((<span class="pl-smi">CounterControllerImpl</span>) counterController)<span class="pl-k">.</span>navigationController;
        <span class="pl-smi">NavigationController</span><span class="pl-k">.</span><span class="pl-smi">Model</span> navModel <span class="pl-k">=</span> navigationController<span class="pl-k">.</span>getModel();
        <span class="pl-c">//App has not navigated to anywhere, current location should be null</span>
        <span class="pl-smi">Assert</span><span class="pl-k">.</span>assertNull(navModel<span class="pl-k">.</span>getCurrentLocation());
        <span class="pl-c">//Simulate navigating to location A</span>
        navigationController<span class="pl-k">.</span>navigateTo(<span class="pl-v">this</span>, <span class="pl-s"><span class="pl-pds">"</span>LocationA<span class="pl-pds">"</span></span>);
        <span class="pl-c">//Verify: location should be changed to LocationA</span>
        <span class="pl-smi">Assert</span><span class="pl-k">.</span>assertEquals(navModel<span class="pl-k">.</span>getCurrentLocation()<span class="pl-k">.</span>getLocationId(), <span class="pl-s"><span class="pl-pds">"</span>LocationA<span class="pl-pds">"</span></span>);

        <span class="pl-c">//Act: CounterController now goes to advanced view underlining logic is navigating to locationB</span>
        counterController<span class="pl-k">.</span>goToAdvancedView(<span class="pl-v">this</span>);

        <span class="pl-c">//Verify: Current location should be LocationB</span>
        <span class="pl-smi">Assert</span><span class="pl-k">.</span>assertEquals(navModel<span class="pl-k">.</span>getCurrentLocation()<span class="pl-k">.</span>getLocationId(), <span class="pl-s"><span class="pl-pds">"</span>LocationB<span class="pl-pds">"</span></span>);

        <span class="pl-c">//Act: CounterController now goes back to basic view underlining logic is navigating back to locationA</span>
        counterController<span class="pl-k">.</span>goBackToBasicView(<span class="pl-v">this</span>);

        <span class="pl-c">//Verify: Current location should be back to LocationA</span>
        <span class="pl-smi">Assert</span><span class="pl-k">.</span>assertEquals(navModel<span class="pl-k">.</span>getCurrentLocation()<span class="pl-k">.</span>getLocationId(), <span class="pl-s"><span class="pl-pds">"</span>LocationA<span class="pl-pds">"</span></span>);
    }</pre></div>

<h2>
<a id="other-features" class="anchor" href="#other-features" aria-hidden="true"><span class="octicon octicon-link"></span></a>Other features</h2>

<h4>
<a id="1-dependency-injection" class="anchor" href="#1-dependency-injection" aria-hidden="true"><span class="octicon octicon-link"></span></a>1. Dependency Injection</h4>

<h5>
<a id="inject" class="anchor" href="#inject" aria-hidden="true"><span class="octicon octicon-link"></span></a><a href="https://github.com/Inject" class="user-mention">@Inject</a>
</h5>

<p>The framework currently only support field injection. To inject an object, use <a href="https://github.com/Inject" class="user-mention">@Inject</a> to annotate fields and then inject the object with those fields by</p>

<div class="highlight highlight-java"><pre><span class="pl-smi">AndroidMvc</span><span class="pl-k">.</span>graph()<span class="pl-k">.</span>inject(<span class="pl-smi">ObjectToBeInjected</span>)</pre></div>

<p>All injected objects will be reference counted. This is because
the graph will automatically save and restore injected objects implementing StateManaged. For performance reasons the injected but not anymore referenced objects don't need to be saved and restored. So don't forget to call</p>

<div class="highlight highlight-java"><pre><span class="pl-smi">AndroidMvc</span><span class="pl-k">.</span>graph()<span class="pl-k">.</span>release(<span class="pl-smi">ObjectBeenInjected</span>)</pre></div>

<p>to dereference them. Fortunately, all MvcFragment will do the injection and releasing in their
Android lifecycle - onCreate and onDestroy. So we don't need to do this manually for fragments.</p>

<p>**But why do we release? Isn't Java managing garbage collection automatically?</p>

<p>Yes java does it. But since all controllers of AndroidMvc are singleton to assure the single source of truth, if there are used by multiple consumers, the shared instance of the controller will be held by a cache. And the model of the controller will be automatically saved and restored on demand of recreation and destroy of fragments. So if a controller is not used anymore, we can dereference the controller. Then AndroidMvc will stop managing its model.</p>

<p>In addition, instances of fragments in their back stack will be held by OS until they are killed. This holds up a lot memory if the back stack is deep. Since those fragments are not visible, there is no point to hold the data they are referencing any longer. To release reference of controllers will help AndroidMvc be aware which controllers are not used anymore, thereafter AndroidMvc can free up the memory holding their models. What about if those fragments want to resume by popping out from the back stack? As mentioned before, AndroidMvc will restore the state/model of the controllers the fragments reference which are saved when the fragments are pushed into the back stack.**</p>

<h4>
<a id="more-details-about-dependency-injection-with-poke-see-its-documentation-here" class="anchor" href="#more-details-about-dependency-injection-with-poke-see-its-documentation-here" aria-hidden="true"><span class="octicon octicon-link"></span></a><a href="https://github.com/kejunxia/AndroidMvc/tree/master/library/poke">More details about dependency injection with Poke, see its documentation here</a>
</h4>

<h3>
<a id="2-unit-testing-on-asynchronous-actions-eg-http-requests" class="anchor" href="#2-unit-testing-on-asynchronous-actions-eg-http-requests" aria-hidden="true"><span class="octicon octicon-link"></span></a>2. Unit testing on asynchronous actions, e.g. Http requests</h3>

<p>Below is an example to consume a public weather API from <a href="http://openweathermap.org/api">OpenWeatherMap</a>. To be able to test controller without real http communication, the http request can be abstracted into a service interface. The service interface is injected into controllers. Then in real implementation of the service interface we send http request by http client while in controller testings we mock the service to provide mock data.</p>

<p>See more details in the sample project - Node</p>

<p><strong>Note that, BaseMvcControllerImpl provides protected methods to run actions asynchronously. The ExecutorService is injected into controllers. By default, AndroidMvc framework automatically injects with an implementation running tasks on non-main thread. Whereas in unit tests we can override the injection with an implementation runs the task on the same thread as the caller's so that the asynchronous actions can be tested easier.</strong></p>

<div class="highlight highlight-java"><pre><span class="pl-c">/**</span>
<span class="pl-c"> * Run async task on the default ExecutorService injected as a field of this class. Exceptions</span>
<span class="pl-c"> * occur during running the task will be handled by the given {@link AsyncExceptionHandler}.</span>
<span class="pl-c"> *</span>
<span class="pl-c"> * @param sender                who initiated this task</span>
<span class="pl-c"> * @param asyncTask             task to execute</span>
<span class="pl-c"> * @param asyncExceptionHandler error handler for the exception during running the task</span>
<span class="pl-c"> * @return the reference of {@link AsyncTask} that can be used to query its state and cancel it.</span>
<span class="pl-c"> */</span>
<span class="pl-k">protected</span> <span class="pl-smi">AsyncTask</span> runAsyncTask(<span class="pl-smi">Object</span> sender, <span class="pl-smi">AsyncTask</span> asyncTask, <span class="pl-smi">AsyncExceptionHandler</span> asyncExceptionHandler)</pre></div>

<h5>
<a id="1-define-http-service-interface" class="anchor" href="#1-define-http-service-interface" aria-hidden="true"><span class="octicon octicon-link"></span></a>1. Define http service interface</h5>

<div class="highlight highlight-java"><pre><span class="pl-k">package</span> <span class="pl-smi">com.shipdream.lib.android.mvc.samples.note.service.http</span>;

<span class="pl-k">public</span> <span class="pl-k">interface</span> <span class="pl-en">WeatherService</span> {
    <span class="pl-c">/**</span>
<span class="pl-c">     * Get weathers of the cities with the given ids</span>
<span class="pl-c">     * @param ids Ids of the cities</span>
<span class="pl-c">     * @return The response</span>
<span class="pl-c">     */</span>
    <span class="pl-smi">WeatherListResponse</span> <span class="pl-en">getWeathers</span>(<span class="pl-k">List&lt;<span class="pl-smi">Integer</span>&gt;</span><span class="pl-v">ids</span>) <span class="pl-k">throws</span> <span class="pl-smi">IOException</span>;
}</pre></div>

<h5>
<a id="2-send-and-consume-real-http-service-in-implementation" class="anchor" href="#2-send-and-consume-real-http-service-in-implementation" aria-hidden="true"><span class="octicon octicon-link"></span></a>2. Send and consume real http service in implementation</h5>

<div class="highlight highlight-java"><pre><span class="pl-c">/**</span>
<span class="pl-c"> * Note the package structure which is under internal subpackage sharing the same parent package as</span>
<span class="pl-c"> * WeatherService as above</span>
<span class="pl-c"> */</span>
<span class="pl-k">package</span> <span class="pl-smi">com.shipdream.lib.android.mvc.samples.note.service.http.internal</span>;

<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">WeatherServiceImpl</span> <span class="pl-k">implements</span> <span class="pl-e">WeatherService</span>{
    <span class="pl-k">private</span> <span class="pl-smi">HttpClient</span> httpClient;
    <span class="pl-k">private</span> <span class="pl-smi">Gson</span> gson;

    <span class="pl-k">public</span> <span class="pl-en">WeatherServiceImpl</span>() {
        httpClient <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">DefaultHttpClient</span>();
        gson <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">Gson</span>();
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-smi">WeatherListResponse</span> <span class="pl-en">getWeathers</span>(<span class="pl-k">List&lt;<span class="pl-smi">Integer</span>&gt;</span> <span class="pl-v">ids</span>) <span class="pl-k">throws</span> <span class="pl-smi">IOException</span> {
        <span class="pl-smi">String</span> idsStr <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>;
        <span class="pl-k">for</span> (<span class="pl-smi">Integer</span> id <span class="pl-k">:</span> ids) {
            <span class="pl-k">if</span> (<span class="pl-k">!</span>idsStr<span class="pl-k">.</span>isEmpty()) {
                idsStr <span class="pl-k">+=</span> <span class="pl-s"><span class="pl-pds">"</span>, <span class="pl-pds">"</span></span>;
            }
            idsStr <span class="pl-k">+=</span> <span class="pl-smi">String</span><span class="pl-k">.</span>valueOf(id);
        }
        <span class="pl-smi">String</span> url <span class="pl-k">=</span> <span class="pl-smi">String</span><span class="pl-k">.</span>format(<span class="pl-s"><span class="pl-pds">"</span>http://api.openweathermap.org/data/2.5/group?id=%s&amp;units=metric<span class="pl-pds">"</span></span>,
                <span class="pl-smi">URLEncoder</span><span class="pl-k">.</span>encode(idsStr, <span class="pl-s"><span class="pl-pds">"</span>UTF-8<span class="pl-pds">"</span></span>));
        <span class="pl-smi">HttpGet</span> get <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">HttpGet</span>(url);
        <span class="pl-smi">HttpResponse</span> resp <span class="pl-k">=</span> httpClient<span class="pl-k">.</span>execute(get);
        <span class="pl-smi">String</span> responseStr <span class="pl-k">=</span> <span class="pl-smi">EntityUtils</span><span class="pl-k">.</span>toString(resp<span class="pl-k">.</span>getEntity());
        <span class="pl-k">return</span> gson<span class="pl-k">.</span>fromJson(responseStr, <span class="pl-smi">WeatherListResponse</span><span class="pl-k">.</span>class);
    }
}</pre></div>

<h5>
<a id="3-inject-the-http-service-into-weathercontrollerimpl" class="anchor" href="#3-inject-the-http-service-into-weathercontrollerimpl" aria-hidden="true"><span class="octicon octicon-link"></span></a>3. Inject the http service into WeatherControllerImpl</h5>

<div class="highlight highlight-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">WeatherControllerImpl</span> <span class="pl-k">extends</span> <span class="pl-e">BaseControllerImpl</span> &lt;<span class="pl-e">WeatherModel</span>&gt; <span class="pl-k">implements</span>
        <span class="pl-e">WeatherController</span>{
    <span class="pl-c1">....</span>

    <span class="pl-k">@Inject</span>
    <span class="pl-k">private</span> <span class="pl-smi">WeatherService</span> weatherService;

    <span class="pl-c">//consume the service and fetch weathers</span>
    <span class="pl-c">//...</span>
}</pre></div>

<h5>
<a id="4-in-controller-unit-test-override-injection-of-executorservice-with-implementation-running-actions-on-the-same-thread-as-the-callers" class="anchor" href="#4-in-controller-unit-test-override-injection-of-executorservice-with-implementation-running-actions-on-the-same-thread-as-the-callers" aria-hidden="true"><span class="octicon octicon-link"></span></a>4. In controller unit test, override injection of ExecutorService with implementation running actions on the same thread as the caller's</h5>

<p>Code below is partial implementation, see sample Note in the project for more details.</p>

<div class="highlight highlight-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">TestWeatherController</span> <span class="pl-k">extends</span> <span class="pl-e">TestControllerBase&lt;<span class="pl-smi">WeatherController</span>&gt;</span> {
<span class="pl-k">@Override</span>
<span class="pl-k">protected</span> <span class="pl-k">void</span> <span class="pl-en">registerDependencies</span>(<span class="pl-smi">MvcGraph</span> <span class="pl-v">mvcGraph</span>) {
    <span class="pl-c1">...</span>

    <span class="pl-c">//Setup mock executor service mock that runs task on the same thread.</span>
    executorService <span class="pl-k">=</span> mock(<span class="pl-smi">ExecutorService</span><span class="pl-k">.</span>class);
    doAnswer(<span class="pl-k">new</span> <span class="pl-smi">Answer</span>() {
        <span class="pl-k">@Override</span>
        <span class="pl-k">public</span> <span class="pl-smi">Object</span> <span class="pl-en">answer</span>(<span class="pl-smi">InvocationOnMock</span> <span class="pl-v">invocation</span>) <span class="pl-k">throws</span> <span class="pl-smi">Throwable</span> {
            <span class="pl-smi">Runnable</span> runnable <span class="pl-k">=</span> (<span class="pl-smi">Runnable</span>) invocation<span class="pl-k">.</span>getArguments()[<span class="pl-c1">0</span>];
            runnable<span class="pl-k">.</span>run();
            <span class="pl-k">return</span> <span class="pl-c1">null</span>;
        }
    })<span class="pl-k">.</span>when(executorService)<span class="pl-k">.</span>submit(any(<span class="pl-smi">Runnable</span><span class="pl-k">.</span>class));

    <span class="pl-c">//Register the injecting component to mvcGraph to override the implementation being injected</span>
    <span class="pl-c">//to controllers</span>
    <span class="pl-smi">TestComp</span> testComp <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">TestComp</span>();
    testComp<span class="pl-k">.</span>testNoteController <span class="pl-k">=</span> <span class="pl-v">this</span>;
    mvcGraph<span class="pl-k">.</span>register(testComp);
}
}</pre></div>

<h5>
<a id="5-test-if-weathercontroller-sends-successful-event-with-good-http-response" class="anchor" href="#5-test-if-weathercontroller-sends-successful-event-with-good-http-response" aria-hidden="true"><span class="octicon octicon-link"></span></a>5. Test if WeatherController sends successful event with good http response</h5>

<p>What to mock
1. Http Service to provide good response
2. Event monitor to subscribe to the successful event
So when WeatherController#updateAllCities(Object) is called, we can verify whether the mocked monitor receives the successful event.</p>

<div class="highlight highlight-java"><pre>@<span class="pl-smi">Test</span>
<span class="pl-k">public</span> <span class="pl-k">void</span> shouldRaiseSuccessEventForGoodUpdateWeathers() throws <span class="pl-smi">IOException</span> {
    <span class="pl-c">//---Arrange---</span>
    <span class="pl-c">//Define a subscriber class</span>
    <span class="pl-k">class</span> <span class="pl-en">Monitor</span> {
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onEvent</span>(<span class="pl-smi">WeatherController</span>.<span class="pl-smi">EventC2V</span>.<span class="pl-smi">OnWeathersUpdated</span> <span class="pl-v">event</span>) {
        }
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onEvent</span>(<span class="pl-smi">WeatherController</span>.<span class="pl-smi">EventC2V</span>.<span class="pl-smi">OnWeathersUpdateFailed</span> <span class="pl-v">event</span>) {
        }
    }
    <span class="pl-smi">Monitor</span> monitor <span class="pl-k">=</span> mock(<span class="pl-smi">Monitor</span><span class="pl-k">.</span>class);
    <span class="pl-c">//Subscribe to eventBus</span>
    eventBusC2V<span class="pl-k">.</span>register(monitor);

    <span class="pl-c">//Weather service mock prepares a good response</span>
    <span class="pl-smi">WeatherListResponse</span> responseMock <span class="pl-k">=</span> mock(<span class="pl-smi">WeatherListResponse</span><span class="pl-k">.</span>class);
    when(weatherServiceMock<span class="pl-k">.</span>getWeathers(any(<span class="pl-smi">List</span><span class="pl-k">.</span>class)))<span class="pl-k">.</span>thenReturn(responseMock);

    <span class="pl-c">//---Action---</span>
    controllerToTest<span class="pl-k">.</span>updateAllCities(<span class="pl-v">this</span>);

    <span class="pl-c">//---Verify---</span>
    <span class="pl-c">//Success event should be raised</span>
    <span class="pl-k">ArgumentCaptor&lt;<span class="pl-smi">WeatherController</span>.</span><span class="pl-smi">EventC2V</span><span class="pl-k">.</span><span class="pl-smi">OnWeathersUpdated</span><span class="pl-k">&gt;</span> eventSuccess
            <span class="pl-k">=</span> <span class="pl-smi">ArgumentCaptor</span><span class="pl-k">.</span>forClass(<span class="pl-smi">WeatherController</span><span class="pl-k">.</span><span class="pl-smi">EventC2V</span><span class="pl-k">.</span><span class="pl-smi">OnWeathersUpdated</span><span class="pl-k">.</span>class);
    verify(monitor, times(<span class="pl-c1">1</span>))<span class="pl-k">.</span>onEvent(eventSuccess<span class="pl-k">.</span>capture());
    <span class="pl-c">//Failed event should not be raised</span>
    <span class="pl-k">ArgumentCaptor&lt;<span class="pl-smi">WeatherController</span>.</span><span class="pl-smi">EventC2V</span><span class="pl-k">.</span><span class="pl-smi">OnWeathersUpdateFailed</span><span class="pl-k">&gt;</span> eventFailure
            <span class="pl-k">=</span> <span class="pl-smi">ArgumentCaptor</span><span class="pl-k">.</span>forClass(<span class="pl-smi">WeatherController</span><span class="pl-k">.</span><span class="pl-smi">EventC2V</span><span class="pl-k">.</span><span class="pl-smi">OnWeathersUpdateFailed</span><span class="pl-k">.</span>class);
    verify(monitor, times(<span class="pl-c1">0</span>))<span class="pl-k">.</span>onEvent(eventFailure<span class="pl-k">.</span>capture());
}</pre></div>

<h5>
<a id="6-test-if-weathercontroller-sends-failed-event-with-bad-http-response" class="anchor" href="#6-test-if-weathercontroller-sends-failed-event-with-bad-http-response" aria-hidden="true"><span class="octicon octicon-link"></span></a>6. <strong>Test if WeatherController sends failed event with bad http response</strong>
</h5>

<p>What to mock
1. Http Service to provide bad response
2. Event monitor to subscribe to the failed event
So when WeatherController#updateAllCities(Object) is called, we can verify whether the mocked monitor receives the failed event.</p>

<div class="highlight highlight-java"><pre>@<span class="pl-smi">Test</span>
<span class="pl-k">public</span> <span class="pl-k">void</span> shouldRaiseFailEventForNetworkErrorToUpdateWeathers() throws <span class="pl-smi">IOException</span> {
    <span class="pl-c">//---Arrange---</span>
    <span class="pl-c">//Define a subscriber class</span>
    <span class="pl-k">class</span> <span class="pl-en">Monitor</span> {
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onEvent</span>(<span class="pl-smi">WeatherController</span>.<span class="pl-smi">EventC2V</span>.<span class="pl-smi">OnWeathersUpdated</span> <span class="pl-v">event</span>) {
        }
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onEvent</span>(<span class="pl-smi">WeatherController</span>.<span class="pl-smi">EventC2V</span>.<span class="pl-smi">OnWeathersUpdateFailed</span> <span class="pl-v">event</span>) {
        }
    }
    <span class="pl-smi">Monitor</span> monitor <span class="pl-k">=</span> mock(<span class="pl-smi">Monitor</span><span class="pl-k">.</span>class);
    <span class="pl-c">//Subscribe to eventBus</span>
    eventBusC2V<span class="pl-k">.</span>register(monitor);

    <span class="pl-c">//Weather service mock prepares a bad response</span>
    <span class="pl-c">//by throwing an exception when getting the weather data</span>
    when(weatherServiceMock<span class="pl-k">.</span>getWeathers(any(<span class="pl-smi">List</span><span class="pl-k">.</span>class)))<span class="pl-k">.</span>thenThrow(<span class="pl-k">new</span> <span class="pl-smi">IOException</span>());

    <span class="pl-c">//---Action---</span>
    controllerToTest<span class="pl-k">.</span>updateAllCities(<span class="pl-v">this</span>);

    <span class="pl-c">//---Verify---</span>
    <span class="pl-c">//Success event should not be raised</span>
    <span class="pl-k">ArgumentCaptor&lt;<span class="pl-smi">WeatherController</span>.</span><span class="pl-smi">EventC2V</span><span class="pl-k">.</span><span class="pl-smi">OnWeathersUpdated</span><span class="pl-k">&gt;</span> eventSuccess
            <span class="pl-k">=</span> <span class="pl-smi">ArgumentCaptor</span><span class="pl-k">.</span>forClass(<span class="pl-smi">WeatherController</span><span class="pl-k">.</span><span class="pl-smi">EventC2V</span><span class="pl-k">.</span><span class="pl-smi">OnWeathersUpdated</span><span class="pl-k">.</span>class);
    verify(monitor, times(<span class="pl-c1">0</span>))<span class="pl-k">.</span>onEvent(eventSuccess<span class="pl-k">.</span>capture());
    <span class="pl-c">//Failed event must be raised</span>
    <span class="pl-k">ArgumentCaptor&lt;<span class="pl-smi">WeatherController</span>.</span><span class="pl-smi">EventC2V</span><span class="pl-k">.</span><span class="pl-smi">OnWeathersUpdateFailed</span><span class="pl-k">&gt;</span> eventFailure
            <span class="pl-k">=</span> <span class="pl-smi">ArgumentCaptor</span><span class="pl-k">.</span>forClass(<span class="pl-smi">WeatherController</span><span class="pl-k">.</span><span class="pl-smi">EventC2V</span><span class="pl-k">.</span><span class="pl-smi">OnWeathersUpdateFailed</span><span class="pl-k">.</span>class);
    verify(monitor, times(<span class="pl-c1">1</span>))<span class="pl-k">.</span>onEvent(eventFailure<span class="pl-k">.</span>capture());
}</pre></div>

<h3>
<a id="3-custom-mechanism-to-automatically-saverestore-models-of-controllers" class="anchor" href="#3-custom-mechanism-to-automatically-saverestore-models-of-controllers" aria-hidden="true"><span class="octicon octicon-link"></span></a>3. Custom mechanism to automatically save/restore models of controllers</h3>

<p>By default, AndroidMvc uses GSON to serialize and deserialize models of controllers automatically. In general uses the performance is acceptable. For example, on rotation, as long as the models are not very large, the frozen time of the rotation would be between 200ms and 300ms.</p>

<p>If we need to provide more optimized mechanism to do so in case there are large models taking long to be serialized and deserialized by GSON, custom StateKeeper can be set to provide alternative save/restore implementation. For Android, Parcelable is the best performed mechanism to save/restore state but it is not fun and error prone. Fortunately, there a handy library <a href="https://github.com/johncarl81/parceler">Parceler</a> from another developer does this automatically. In the example below, we tried this library to implement custom StateKeeper to save/restore state by Parcelables automatically. The best place to set the custom StateKeeper is the Application#onCreate().</p>

<p>Check out more details in the sample code - Note</p>

<div class="highlight highlight-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">NoteApp</span> <span class="pl-k">extends</span> <span class="pl-e">Application</span> {
    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onCreate</span>() {
        <span class="pl-v">super</span><span class="pl-k">.</span>onCreate();

        <span class="pl-smi">AndroidMvc</span><span class="pl-k">.</span>setCustomStateKeeper(<span class="pl-k">new</span> <span class="pl-smi">AndroidStateKeeper</span>() {
            <span class="pl-k">@SuppressWarnings</span>(<span class="pl-s"><span class="pl-pds">"</span>unchecked<span class="pl-pds">"</span></span>)
            <span class="pl-k">@Override</span>
            <span class="pl-k">public</span> <span class="pl-smi">Parcelable</span> <span class="pl-en">saveState</span>(<span class="pl-smi">Object</span> <span class="pl-v">state</span>, <span class="pl-smi">Class</span> <span class="pl-v">type</span>) {
                <span class="pl-c">/**</span>
<span class="pl-c">                 * Use parcelable to save all states.</span>
<span class="pl-c">                 */</span>
                <span class="pl-k">return</span> <span class="pl-smi">Parcels</span><span class="pl-k">.</span>wrap(state);
                <span class="pl-c">//type of the state can be used as a filter to handle some state specially</span>
                <span class="pl-c">//if (type == BlaBlaType) {</span>
                <span class="pl-c">//    special logic to save state</span>
                <span class="pl-c">//}</span>
            }

            <span class="pl-k">@SuppressWarnings</span>(<span class="pl-s"><span class="pl-pds">"</span>unchecked<span class="pl-pds">"</span></span>)
            <span class="pl-k">@Override</span>
            <span class="pl-k">public</span> <span class="pl-smi">Object</span> <span class="pl-en">getState</span>(<span class="pl-smi">Parcelable</span> <span class="pl-v">parceledState</span>, <span class="pl-smi">Class</span> <span class="pl-v">type</span>) {
                <span class="pl-c">/**</span>
<span class="pl-c">                 * Use parcelable to restore all states.</span>
<span class="pl-c">                 */</span>
                <span class="pl-k">return</span> <span class="pl-smi">Parcels</span><span class="pl-k">.</span>unwrap(parceledState);

                <span class="pl-c">//type of the state can be used as a filter to handle some state specially</span>
                <span class="pl-c">//if (type == BlaBlaType) {</span>
                <span class="pl-c">//    special logic to restore state</span>
                <span class="pl-c">//}</span>
            }
        });
    }
}</pre></div>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Android Mvc Framework maintained by <a href="https://github.com/kejunxia">kejunxia</a></p>
        <p>Published with <a href="https://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-21820164-19");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>


  </body>
</html>
