<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Android Mvc Framework by kejunxia</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Android Mvc Framework</h1>
      <h2 class="project-tagline">Android, Design Pattern, MVC, MVVM, Unit Test, Single Activity, EventBus, Android MVC Framework</h2>
      <a href="https://github.com/kejunxia/AndroidMvc" class="btn">View on GitHub</a>
      <a href="https://github.com/kejunxia/AndroidMvc/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/kejunxia/AndroidMvc/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="androidmvc-framework" class="anchor" href="#androidmvc-framework" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>AndroidMvc Framework</h1>

<p>Android Mvc framework helps Android developers implement Android projects simpler and cleaner with MVC/MVP/MVVM patterns and make them testable.</p>

<h2>
<a id="features" class="anchor" href="#features" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Features</h2>

<ul>
<li>
<a href="#Implement-MVC/MVP/MVVM-pattern">Easy to implement MVC/MVP/MVVM pattern</a> for Android development</li>
<li>
<a href="#Fragment-Life-cycles">Enhanced Android life cycles</a> - e.g. when view needs to refresh when being brought back to foreground but not on rotation, onResume() is not specific to differentiate the two scenarios. Android mvc framework provides more granular life cycles</li>
<li>
<a href="#FragmentController-Life-cycles">All fragment life cycles are mapped into FragmentController</a> thus more business logic can be moved into controllers including the ones in life cycles. Apps are more testable on JVM!</li>
<li>
<a href="#Navigation">Easy and clean navigation</a>. Navigation is done in controllers instead of views. Thus navigation can be unit tested on JVM</li>
<li>
<a href="#Run-AsyncTask-in-controller">Run async tasks in controllers</a> and easy mocking of http requests</li>
<li>
<a href="#Easy-Unit-Test">Easy unit test on JVM</a> since controllers don't depend on any Android APIs</li>
<li>
<a href="#Event-Bus">Built in Event Bus</a>. Event bus also automatically guarantees post event view events on the UI thread</li>
<li>
<a href="#Instance-State-Management">Automatically save and restore instance state</a>. You don't have to touch onSaveInstance and onCreate(savedInstanceState) with countless key-value pairs, it's all managed by the framework.</li>
<li><a href="#Dependency-injection-(Poke)">Built in simple dependency injection</a></li>
<li>Well tested - non-Android components are tested as the test coverage status <a href="https://coveralls.io/r/kejunxia/AndroidMvc"><img src="https://coveralls.io/repos/kejunxia/AndroidMvc/badge.svg" alt="Coverage Status"></a>. For Android dependent module "android-mvc", it's tested by real emulator with <a href="https://github.com/kejunxia/AndroidMvc/tree/master/library/android-mvc-test">this UI test module</a>. <strong>It's also tested with "Don't Keep Activities" turned on in dev options</strong> to guarantee your app doesn't crash due to loss of instance state after it's killed by OS in the background!</li>
</ul>

<h2>
<a id="implement-mvcmvpmvvm-pattern" class="anchor" href="#implement-mvcmvpmvvm-pattern" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Implement MVC/MVP/MVVM pattern</h2>

<p>As we know MVP and MVVM patterns are just simply derivatives of MVC pattern. All of them are targeting the same goal - Separation. </p>

<p>Separating Views and Controllers allows moving more business logic away from views into controllers. This makes code cleaner and, more importantly, it makes code more testable since most logical components are not depending on specific views. In the sense of Android, it means more fuctions can be written without depending on Android API therefore not have to be tested on emulators.</p>

<p>Since MVC, MVP and MVVM are similar, in this framework we call both <strong>Prestener</strong> in MVP and <strong>ViewModel</strong> in MVVM just as traditionally <strong>Controller</strong>. </p>

<ul>
<li>
<p><strong>Controller</strong>: A controller is a delegate for business logic of a view. Thus controllers and views have <strong>one-to-one</strong> relationship. A controller provides methods to be invoked by the view to receive user's interactions such as click and long press. Once user's input is processed in controller, the state of view would be changed. And the controller needs to notify the view the change. When the controller needs to update view, it can be done differently in MVP and MVVM pattern</p>

<ul>
<li>In <strong>MVP</strong>: controller calls the method view.update() of the view it holds to update the entire view. If the needed, the view can define more granular methods to update just a part of the entire view. For example, view.showProgressBar() or view.hideProgressBar().</li>
<li>In <strong>MVVM</strong>: controller post an event to view. View uses methods onEvent([EventClassType] event) to mointore the posted event. In the mothods the view update the UI accordingly.</li>
</ul>
</li>
<li>
<p><strong>View</strong>: A view is an Android component that can be either Fragments, Services, Notification, Activity and etc. Every view has a controller to manage its business logic. As metioned, controllers and views have <strong>one-to-one</strong> relationship. Views should not process business logic but delegate all business processes to their corespondingcontrollers.</p>

<ul>
<li>Note that, AndroidMvc is use a single Activity to host multiple fragments. Navgation is at fragment level and in the same activity.</li>
</ul>
</li>
<li>
<strong>Model</strong>: A model represents the state of view and managed by controller. It can be accessed by controller.getModel(). The model should be reflected to Android UI in views and modified by controllers. <strong>The model will be automatically searialized and restored in onSaveInstanceState by the framework</strong>. So you don't need to use messy key-value pairs to save and restore view state.</li>
<li>
<strong>Managers</strong>: Managers are not necessary in MVC/MVP/MVVM model. However as metioned above, views and controllers are one-to-one mapped, when multiple views as well as their controllers share same data or logic managers are a good fit. Shared logic and data of controllers can be broken out into a manager. For example, managing logged in user is common feature of a lot apps. To have a UserManager is a perfect solution that can modify and read current users. The the manager can be used by LoginController and other controllers after login screen.</li>
<li>
<strong>Services</strong>: We are not taling about <a href="https://developer.android.com/guide/components/services.html">Android Services</a>. Services here are providing a layer between controller controllers and external data such as http apis, database, files, sharedPreferences and etc. Services can be injected into controllers as well as managers since managers can be thought as partial controllers.
Services abstract out data access logic so that they can be replaced by different implementations. e.g. Use database to replace sharedPreference when the data structure become complex and query is required. In addition, the controllers can use mocked data provided by mocked services for <strong>unit tests</strong>.</li>
</ul>

<p>See the diagram illustrating the relation between components above</p>

<p><img src="http://i.imgur.com/dfW8TLM.png" alt="AndroidMvc Layers"></p>

<h4>
<a id="sample-code-to-implement-mvp" class="anchor" href="#sample-code-to-implement-mvp" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Sample code to implement MVP</h4>

<ul>
<li>
<p>This sample shosw how a simple view just simply binds the model to the view</p>

<div class="highlight highlight-source-java"><pre><span class="pl-c">//Base view interface defined in AndroidMvc framework</span>
<span class="pl-k">public</span> <span class="pl-k">interface</span> <span class="pl-en">UiView</span> {
    <span class="pl-k">void</span> <span class="pl-en">update</span>();
}

<span class="pl-c">//Base controller defined in AndroidMvc framework</span>
<span class="pl-k">public</span> <span class="pl-k">abstract</span> <span class="pl-k">class</span> <span class="pl-en">Controller</span>&lt;MODEL, VIEW <span class="pl-k">extends</span> <span class="pl-e">UiView</span>&gt; extends <span class="pl-e">Bean&lt;<span class="pl-smi">MODEL</span>&gt;</span> {
    <span class="pl-k">protected</span> <span class="pl-c1">VIEW</span> view;
    <span class="pl-c1">....</span>
}

<span class="pl-c">//A concrete controller extending Controller</span>
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">SomeController</span> <span class="pl-k">extends</span> <span class="pl-e">Controller&lt;<span class="pl-smi">SomeController</span>.Model</span>, <span class="pl-e">UiView</span>&gt; {
    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-smi">Class</span> <span class="pl-en">modelType</span>() {
        <span class="pl-k">return</span> <span class="pl-smi">SomeController</span><span class="pl-k">.</span>class;
    }

    <span class="pl-c">//The model of the controller that represents the state of the view</span>
    <span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-k">class</span> <span class="pl-en">Model</span> {
        <span class="pl-smi">String</span> title;
        <span class="pl-k">public</span> <span class="pl-smi">String</span> <span class="pl-en">getTitle</span>() {
            <span class="pl-k">return</span> title;
        }
    }

    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">updateTitle</span>(<span class="pl-smi">String</span> <span class="pl-v">text</span>) {
        <span class="pl-c">//Model is updated</span>
        getModel()<span class="pl-k">.</span>title <span class="pl-k">=</span> text;
        <span class="pl-c">//Notify the view. The implementation of method update() in </span>
        <span class="pl-c">//concrete view, the view reads the model of the controller </span>
        <span class="pl-c">//and reflect the model to UI</span>
        view<span class="pl-k">.</span>update();
    }
}

<span class="pl-c">//View paired with the controller </span>
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">SomeView</span> <span class="pl-k">implements</span> <span class="pl-e">UiView</span> {
    <span class="pl-k">private</span> <span class="pl-smi">TextView</span> title;

    <span class="pl-k">@Inject</span>
    <span class="pl-k">private</span> <span class="pl-smi">SomeController</span> someController;

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">update</span>() {
        <span class="pl-c">//Read the controller's model and bind it to text</span>
        title<span class="pl-k">.</span>setText(someController<span class="pl-k">.</span>getModel()<span class="pl-k">.</span>getTitle());
    }
}</pre></div>
</li>
<li>
<p>This sample shosw how a more complicated view defines extract methods to update view partially. However, this can also be done only with binding model appoach. For example, define a flag in the model, when the flag changes the controller call view.update() which show loading UI according to the flag.</p>

<div class="highlight highlight-source-java"><pre><span class="pl-c">//Extend UiView to define granular methods to update view partially instead of binding</span>
<span class="pl-c">//entire model to the view</span>
<span class="pl-k">public</span> <span class="pl-k">interface</span> <span class="pl-en">AsyncView</span> <span class="pl-k">extends</span> <span class="pl-e">UiView</span> {
    <span class="pl-k">void</span> <span class="pl-en">showLoadingStatus</span>();
    <span class="pl-k">void</span> <span class="pl-en">hideLoadingStatus</span>();
}

<span class="pl-c">//A screen view that extends MvcFragment</span>
<span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-k">class</span> <span class="pl-en">LoginScreen</span> <span class="pl-k">extends</span> <span class="pl-e">MvcFragment&lt;<span class="pl-smi">LoginController</span>&gt;</span> <span class="pl-k">implements</span> <span class="pl-e">AsyncView</span>{
    <span class="pl-k">private</span> <span class="pl-smi">EditText</span> username;
    <span class="pl-k">private</span> <span class="pl-smi">EditText</span> password;
    <span class="pl-k">private</span> <span class="pl-smi">Button</span> button;

    <span class="pl-c">//Specify the class type of the paired controller</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">protected</span> <span class="pl-k">Class&lt;<span class="pl-smi">LoginController</span>&gt;</span> <span class="pl-en">getControllerClass</span>() {
        <span class="pl-k">return</span> <span class="pl-smi">LoginController</span><span class="pl-k">.</span>class;
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">protected</span> <span class="pl-k">int</span> <span class="pl-en">getLayoutResId</span>() {
        <span class="pl-k">return</span> <span class="pl-smi">R</span><span class="pl-k">.</span>id<span class="pl-k">.</span>screen_login;
    }

    <span class="pl-c">//Called when the view is ready. Similar to onViewCreated but this</span>
    <span class="pl-c">//callback guaranteed all injectable instances depended by this view are ready</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onViewReady</span>(<span class="pl-smi">View</span> <span class="pl-v">view</span>, <span class="pl-smi">Bundle</span> <span class="pl-v">savedInstanceState</span>, <span class="pl-smi">Reason</span> <span class="pl-v">reason</span>) {
        <span class="pl-v">super</span><span class="pl-k">.</span>onViewReady(view, savedInstanceState, reason);

        <span class="pl-c">//assign view by findViewById</span>
        <span class="pl-c">//...</span>
        button<span class="pl-k">.</span>setOnClickListener(<span class="pl-k">new</span> <span class="pl-smi">View</span>.<span class="pl-smi">OnClickListener</span>() {
            <span class="pl-k">@Override</span>
            <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onClick</span>(<span class="pl-smi">View</span> <span class="pl-v">view</span>) {
                controller<span class="pl-k">.</span>login(username<span class="pl-k">.</span>getText()<span class="pl-k">.</span>toString(),
                        password<span class="pl-k">.</span>getText()<span class="pl-k">.</span>toString());
            }
        });
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">showLoadingStatus</span>() {
        <span class="pl-c">//Show progress dialog or progress bar</span>
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">hideLoadingStatus</span>() {
        <span class="pl-c">//Hide progress dialog or progress bar</span>
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">update</span>() {
        <span class="pl-c">//Bind model here</span>
    }

}

<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">LoginController</span> <span class="pl-k">extends</span> <span class="pl-e">FragmentController&lt;<span class="pl-smi">Void</span>, <span class="pl-smi">AsyncView</span>&gt;</span> {
    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">Class&lt;<span class="pl-smi">Void</span>&gt;</span> <span class="pl-en">modelType</span>() {
        <span class="pl-k">return</span> <span class="pl-c1">null</span>;
    }

    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">login</span>(<span class="pl-smi">String</span> <span class="pl-v">username</span>, <span class="pl-smi">String</span> <span class="pl-v">password</span>) {
        runTask(<span class="pl-k">new</span> <span class="pl-k">Task&lt;<span class="pl-smi">Void</span>&gt;</span>() {
            <span class="pl-k">@Override</span>
            <span class="pl-k">public</span> <span class="pl-smi">Void</span> <span class="pl-en">execute</span>(<span class="pl-k">Monitor&lt;<span class="pl-smi">Void</span>&gt;</span> <span class="pl-v">monitor</span>) <span class="pl-k">throws</span> <span class="pl-smi">Exception</span> {
                <span class="pl-c">//Task.execute methods runs on non-UI thread, so we need to</span>
                <span class="pl-c">//post the view update logic back to UI thread</span>
                uiThreadRunner<span class="pl-k">.</span>post(<span class="pl-k">new</span> <span class="pl-smi">Runnable</span>() {
                    <span class="pl-k">@Override</span>
                    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">run</span>() {
                        view<span class="pl-k">.</span>showLoadingStatus();
                    }
                });

                <span class="pl-c">//Send a http request to login</span>
                <span class="pl-c">//...</span>
                <span class="pl-c">//Request returns successfully</span>

                <span class="pl-c">//Task.execute methods runs on non-UI thread, so we need to</span>
                <span class="pl-c">//post the view update logic back to UI thread</span>
                uiThreadRunner<span class="pl-k">.</span>post(<span class="pl-k">new</span> <span class="pl-smi">Runnable</span>() {
                    <span class="pl-k">@Override</span>
                    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">run</span>() {
                        view<span class="pl-k">.</span>hideLoadingStatus();
                    }
                });
                <span class="pl-k">return</span> <span class="pl-c1">null</span>;
            }
        }, <span class="pl-k">new</span> <span class="pl-smi">Task</span>.<span class="pl-k">Callback&lt;<span class="pl-smi">Void</span>&gt;</span>() {
            <span class="pl-k">@Override</span>
            <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onException</span>(<span class="pl-smi">Exception</span> <span class="pl-v">e</span>) <span class="pl-k">throws</span> <span class="pl-smi">Exception</span> {
                <span class="pl-c">//Call back is guaranteed to run on UI thread by the framework</span>
                <span class="pl-c">//No need to use uiThreadRunner to post action</span>
                view<span class="pl-k">.</span>hideLoadingStatus();
            }
        });
    }
}</pre></div>

<h4>
<a id="sample-code-to-implement-mvvm" class="anchor" href="#sample-code-to-implement-mvvm" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Sample code to implement MVVM</h4>

<div class="highlight highlight-source-java"><pre><span class="pl-c">//A concrete controller as a ViewModel</span>
    <span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-k">class</span> <span class="pl-en">SomeController</span> <span class="pl-k">extends</span> <span class="pl-e">Controller&lt;<span class="pl-smi">SomeController</span>.Model</span>, <span class="pl-e">UiView</span>&gt; {
        <span class="pl-k">interface</span> <span class="pl-en">Event</span> {
            <span class="pl-k">class</span> <span class="pl-en">OnModelUpdated</span> {
            }

            <span class="pl-k">class</span> <span class="pl-en">OnTitleChanged</span> {
                <span class="pl-k">private</span> <span class="pl-k">final</span> <span class="pl-smi">String</span> title;

                <span class="pl-k">public</span> <span class="pl-en">OnTitleChanged</span>(<span class="pl-smi">String</span> <span class="pl-v">title</span>) {
                    <span class="pl-v">this</span><span class="pl-k">.</span>title <span class="pl-k">=</span> title;
                }

                <span class="pl-k">public</span> <span class="pl-smi">String</span> <span class="pl-en">getTitle</span>() {
                    <span class="pl-k">return</span> title;
                }
            }
        }

        <span class="pl-k">@Override</span>
        <span class="pl-k">public</span> <span class="pl-smi">Class</span> <span class="pl-en">modelType</span>() {
            <span class="pl-k">return</span> <span class="pl-smi">SomeController</span><span class="pl-k">.</span>class;
        }

        <span class="pl-c">//The model of the controller that represents the state of the view</span>
        <span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">Model</span> {
            <span class="pl-k">private</span> <span class="pl-smi">String</span> title;

            <span class="pl-c">//Update model properties will fire events</span>
            <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">setTitle</span>(<span class="pl-smi">String</span> <span class="pl-v">title</span>) {
                <span class="pl-v">this</span><span class="pl-k">.</span>title <span class="pl-k">=</span> title;

                <span class="pl-c">//Post an event</span>
                <span class="pl-c">//Note postEvent method guarantees the event will be posted to UI thread!!!</span>
                postEvent(<span class="pl-k">new</span> <span class="pl-smi">Event</span>.<span class="pl-smi">OnTitleChanged</span>(getModel()<span class="pl-k">.</span>getTitle()));
            }

            <span class="pl-k">public</span> <span class="pl-smi">String</span> <span class="pl-en">getTitle</span>() {
                <span class="pl-k">return</span> title;
            }
        }

        <span class="pl-c">//Expose to view to update title</span>
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">updateTitle</span>(<span class="pl-smi">String</span> <span class="pl-v">text</span>) {
            <span class="pl-c">//Model is updated</span>
            getModel()<span class="pl-k">.</span>setTitle(text);
        }

        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">rebindModel</span>() {
            <span class="pl-c">//...</span>
            <span class="pl-c">//code to update model</span>
            <span class="pl-c">//</span>

            postEvent(<span class="pl-k">new</span> <span class="pl-smi">Event</span>.<span class="pl-smi">OnModelUpdated</span>());
        }
    }

    <span class="pl-c">//View paired with the controller</span>
    <span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">SomeView</span> <span class="pl-k">extends</span> <span class="pl-e">View</span> {
        <span class="pl-k">private</span> <span class="pl-smi">TextView</span> title;

        <span class="pl-k">@Inject</span>
        <span class="pl-k">private</span> <span class="pl-smi">SomeController</span> controller;

        <span class="pl-k">@Inject</span>
        <span class="pl-k">@EventBusV</span> <span class="pl-c">//Event bus for subscribers as views</span>
        <span class="pl-k">private</span> <span class="pl-smi">EventBus</span> eventBus;

        <span class="pl-k">public</span> <span class="pl-en">SomeView</span>(<span class="pl-smi">Context</span> <span class="pl-v">context</span>) {
            <span class="pl-v">super</span>(context);

            <span class="pl-c">//Register this view to the event bus for views</span>
            <span class="pl-c">//Since here, when an even in type of SomeController.Event.OnTitleChanged</span>
            <span class="pl-c">//is posted, method onEvent(SomeController.Event.OnTitleChanged event)</span>
            <span class="pl-c">//will be called</span>
            eventBus<span class="pl-k">.</span>register(<span class="pl-v">this</span>);
        }

        <span class="pl-k">@Override</span>
        <span class="pl-k">protected</span> <span class="pl-k">void</span> <span class="pl-en">onAttachedToWindow</span>() {
            <span class="pl-v">super</span><span class="pl-k">.</span>onAttachedToWindow();

            <span class="pl-c">//Unregister the view from the event bus.</span>
            <span class="pl-c">//This is working but not ideal because the event bus will be unregistered until</span>
            <span class="pl-c">//the view is removed from the window not it's parent</span>
            <span class="pl-c">//You can consider viewGroup.setOnHierarchyChangeListener</span>

            <span class="pl-c">//but make sub view in fragments extending MvcFragment is recommended since </span>
            <span class="pl-c">//MvcFragment register and unregister event bus in onCreate and onDestroy </span>
            <span class="pl-c">//lifecycle call backs. </span>
            <span class="pl-c">// </span>
            <span class="pl-c">//This is just an example of using eventBus manually.</span>
            eventBus<span class="pl-k">.</span>unregister(<span class="pl-v">this</span>);
        }

        <span class="pl-c">//Monitor event SomeController.Event.OnTitleChanged</span>
        <span class="pl-c">//All event subscriber methods should be called onEvent with one argument of the</span>
        <span class="pl-c">//event's class type</span>
        <span class="pl-k">private</span> <span class="pl-k">void</span> <span class="pl-en">onEvent</span>(<span class="pl-smi">SomeController</span>.<span class="pl-smi">Event</span>.<span class="pl-smi">OnTitleChanged</span> <span class="pl-v">event</span>) {
            title<span class="pl-k">.</span>setText(event<span class="pl-k">.</span>getTitle());
        }

        <span class="pl-c">//Monitor event SomeController.Event.OnModelUpdated</span>
        <span class="pl-k">private</span> <span class="pl-k">void</span> <span class="pl-en">onEvent</span>(<span class="pl-smi">SomeController</span>.<span class="pl-smi">Event</span>.<span class="pl-smi">OnModelUpdated</span> <span class="pl-v">event</span>) {
            title<span class="pl-k">.</span>setText(controller<span class="pl-k">.</span>getModel()<span class="pl-k">.</span>getTitle());

            <span class="pl-c">//other views to bind to the controller/ViewModel's model</span>
            <span class="pl-c">//...</span>
        }
    }</pre></div>
</li>
</ul>

<h2>
<a id="fragment-life-cycles" class="anchor" href="#fragment-life-cycles" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Fragment Life cycles</h2>

<p>Since AndroidMvc framwork is designed to implement apps with a single Activity in most cases. Fragments are playing an important role. In the framework, fragments can be used as a screen which is the what an activity does traditionally. Also it can be used as sub view as well.</p>

<p>Below are life cycle callback of MvcFragment provided by AndroidMvc framework</p>

<ul>
<li>
<strong>onCreateView</strong> is final and <strong>SEALED</strong>, use onViewReady described below</li>
<li>
<strong>onViewCreated</strong> is final and <strong>SEALED</strong>, use onViewReady described below</li>
<li>
<strong>onViewReady</strong>(View, Bundle, <strong>Reason</strong>) is called when the fragement is ready to bind Android widgets by findViewById and <strong>use controllers</strong>. The argument "Reason" indicates why the view is created or recreated. For example, view is created

<ul>
<li>first time</li>
<li>on restoration</li>
<li>rotation.</li>
</ul>
</li>
<li>
<strong>onReturnForeground</strong> called when the app is brought to the front after being pushed to background. It complements onResume since onResume doesn't differentiate foregrounding app, rotation, creation and etc.</li>
<li>
<strong>onPushToBackStack</strong> called when the fragment is about to be pushed to back stack typically on navigation. It complements onPause since onPause doesn't differentiate pushing to back stack, removing fragment, rotation and etc.</li>
<li>
<strong>onPoppedOutToFront</strong> called when the fragment is popping out from the fragment backstack to present as the top most fragment.</li>
<li>
<strong>onPopAway</strong> called when the fragment was the top most presenting fragment but will be popped away and replaced by the fragment will pop out under it.</li>
<li>
<strong>onPreNavigationTransaction(FragmentTransaction transaction, MvcFragment nextFragment)</strong> called before the fragment transaction is about to commit that will replace current fragment by the next. It's main providing the transaction being committed to configure transaction animation. e.g adding SharedElements</li>
<li>
<strong>onOrientationChanged</strong> called when orientation changed.</li>
</ul>

<h2>
<a id="fragmentcontroller-life-cycles" class="anchor" href="#fragmentcontroller-life-cycles" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>FragmentController Life cycles</h2>

<p>All fragment life cycles are mapped into <a href="https://github.com/kejunxia/AndroidMvc/blob/master/library/android-mvc-core/src/main/java/com/shipdream/lib/android/mvc/FragmentController.java">FragmentController</a>. So fragments are further liberated from handling business logic. For example, if you need to do some stuff in Framgent.onViewReady, you can do it in FragmentController.onViewReady.</p>

<p>Here are the life cycles</p>

<ul>
<li>
<strong>onCreate</strong> when the controller is injected into the corresponding fragment</li>
<li>
<strong>onViewReady(Reason)</strong> is called when the fragement is ready to show. The argument "Reason" indicates why the view is created or recreated. For example, view is created

<ul>
<li>first time</li>
<li>on restoration</li>
<li>rotation.</li>
</ul>
</li>
<li>
<strong>onResume</strong> callced when the fragment is calling its own onResume</li>
<li>
<strong>onPasue</strong> called when the fragment is calling its own onPuase</li>
<li>
<strong>onDestroy</strong> called when the controller is released from being used by the corresponding fragment and not referenced by anything it was injected to.</li>
<li>
<strong>onBackButtonPressed()</strong> called when the phycical back button is pressed</li>
<li>
<strong>onReturnForeground</strong> samed as the corresponding life cycle callback in fragment</li>
<li>
<strong>onPushToBackStack</strong> samed as the corresponding life cycle callback in fragment</li>
<li>
<strong>onPoppedOutToFront</strong> samed as the corresponding life cycle callback in fragment</li>
<li>
<strong>onPopAway</strong> samed as the corresponding life cycle callback in fragment</li>
<li>
<strong>onOrientationChanged</strong> called when orientation changed.</li>
</ul>

<h2>
<a id="navigation" class="anchor" href="#navigation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Navigation</h2>

<p>As metioned earlier, AndroidMvc framework uses single activity to create Android apps. Therefore navigation in AndroidMvc is to swap full screen fragments. Though fragment transactions involve complexity primarily because they may be committed asynchronously, AndroidMvc aims to wrap all the tricks up. This is another reason why onCreateView and onViewCreated life cycle call back are sealed and replaced by onViewReady() metioned in <a href="#FragmentController-Life-cycles">FragmentController Life cycles</a> section. </p>

<p>The navigation functions are tested in instrumentation test cases. If you are interested you can check out the in <a href="https://github.com/kejunxia/AndroidMvc/tree/master/library/android-mvc-test">instrumentation test project</a>.</p>

<h4>
<a id="mapping-between-mvcfragment-and-fragmentcontroller" class="anchor" href="#mapping-between-mvcfragment-and-fragmentcontroller" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Mapping between <a href="https://github.com/kejunxia/AndroidMvc/blob/master/library/android-mvc/src/main/java/com/shipdream/lib/android/mvc/MvcFragment.java">MvcFragment</a> and <a href="https://github.com/kejunxia/AndroidMvc/blob/master/library/android-mvc-core/src/main/java/com/shipdream/lib/android/mvc/FragmentController.java">FragmentController</a>
</h4>

<ul>
<li>
<a href="https://github.com/kejunxia/AndroidMvc/blob/master/library/android-mvc/src/main/java/com/shipdream/lib/android/mvc/MvcFragment.java">MvcFragment</a> should be extended by fragments in AndroidMvc. It can represents a screen or just a sub view. 

<ul>
<li>It can represent a full screen</li>
<li>It also can be used for just a sub view</li>
<li>Class extending <a href="https://github.com/kejunxia/AndroidMvc/blob/master/library/android-mvc/src/main/java/com/shipdream/lib/android/mvc/MvcFragment.java">MvcFragment</a> needs to abstract method <strong>MvcFragment#getResouceId()</strong> to provide the layout resouce id that will be automatically inflated as the root view of the fragment.</li>
<li>Class extending <a href="https://github.com/kejunxia/AndroidMvc/blob/master/library/android-mvc/src/main/java/com/shipdream/lib/android/mvc/MvcFragment.java">MvcFragment</a> needs to implement the abstract method <strong>MvcFragment#getControllerClass()</strong> to provide the class type of a concrete <a href="https://github.com/kejunxia/AndroidMvc/blob/master/library/android-mvc-core/src/main/java/com/shipdream/lib/android/mvc/FragmentController.java">FragmentController</a>. The MvcFragment will automatically create inject the instance of the controller. You don't need to create it, just use MvcFragment.controller straight away. 

<ul>
<li>Note that, null is allow to returned if the fragment doesn't need a controller or you want to inject your own controller by <a href="https://github.com/Inject" class="user-mention">@Inject</a> manually for a reason. However, beware of that in this case MvcFragment.controller will be <strong>NULL</strong>.</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="https://github.com/kejunxia/AndroidMvc/blob/master/library/android-mvc-core/src/main/java/com/shipdream/lib/android/mvc/FragmentController.java">FragmentController</a> should be extended by a concrete controller for a <a href="https://github.com/kejunxia/AndroidMvc/blob/master/library/android-mvc/src/main/java/com/shipdream/lib/android/mvc/MvcFragment.java">MvcFragment</a>. 

<ul>
<li>It can be used by <a href="https://github.com/kejunxia/AndroidMvc/blob/master/library/android-mvc-core/src/main/java/com/shipdream/lib/android/mvc/NavigationManager.java">NavigationManager</a> to navigate to its corresponding MvcFragment. In this case, the corresponding MvcFragment will be treated as a full screen page. See the code snippet in <a href="https://github.com/kejunxia/AndroidMvc/blob/master/samples/simple-mvp/core/src/main/java/com/shipdream/lib/android/mvc/samples/simple/mvp/controller/CounterMasterController.java">sample code</a> as below
<code>java
public void goToDetailScreen(Object sender) {
    navigationManager.navigate(sender).to(CounterDetailController.class);
}
</code>
</li>
</ul>
</li>
</ul>

<h4>
<a id="routing" class="anchor" href="#routing" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Routing</h4>

<p>Routing rules can be defined in you main activity extending <a href="https://github.com/kejunxia/AndroidMvc/blob/master/library/android-mvc/src/main/java/com/shipdream/lib/android/mvc/MvcActivity.java">MvcActivity</a>. Implement method <strong>MvcActivity#mapControllerFragment()</strong> to map which fragment will be launched as a full screen page for the corresponding controller class type. </p>

<p>A typical routing rule is as the code below. </p>

<div class="highlight highlight-source-java"><pre>@<span class="pl-smi">Override</span>
<span class="pl-k">protected</span> <span class="pl-k">Class&lt;? extends <span class="pl-smi">MvcFragment</span>&gt;</span> mapFragmentRouting(
        <span class="pl-k">Class&lt;? extends <span class="pl-smi">Controller</span>&gt;</span> controllerClass) {
    <span class="pl-k">if</span> (controllerClass <span class="pl-k">==</span> <span class="pl-smi">CounterMasterController</span><span class="pl-k">.</span>class) {
        <span class="pl-k">return</span> <span class="pl-smi">CounterMasterScreen</span><span class="pl-k">.</span>class;
    } <span class="pl-k">else</span> <span class="pl-k">if</span> (controllerClass <span class="pl-k">==</span> <span class="pl-smi">CounterDetailController</span><span class="pl-k">.</span>class) {
        <span class="pl-k">return</span> <span class="pl-smi">CounterDetailScreen</span><span class="pl-k">.</span>class;
    } <span class="pl-k">else</span> {
        <span class="pl-k">return</span> <span class="pl-c1">null</span>;
    }
}</pre></div>

<p>If you want more automation, you can choose your own package structure file name pattern to apply a generic routing rule to locate concrete MvcFragment classes like below. See the code in the <a href="https://github.com/kejunxia/AndroidMvc/blob/master/samples/simple-mvp/app/src/main/java/com/shipdream/lib/android/mvc/samples/simple/mvp/MainActivity.java">sample project</a></p>

<div class="highlight highlight-source-java"><pre>@<span class="pl-smi">Override</span>
<span class="pl-k">protected</span> <span class="pl-k">Class&lt;? extends <span class="pl-smi">MvcFragment</span>&gt;</span> mapFragmentRouting(
        <span class="pl-k">Class&lt;? extends <span class="pl-smi">FragmentController</span>&gt;</span> controllerClass) {
    <span class="pl-smi">String</span> controllerPackage <span class="pl-k">=</span> controllerClass<span class="pl-k">.</span>getPackage()<span class="pl-k">.</span>getName();

    <span class="pl-c">//Find the classes of fragment under package .view and named in form of xxxScreen</span>
    <span class="pl-c">//For example</span>

    <span class="pl-c">//a.b.c.CounterMasterController -&gt; a.b.c.view.CounterMasterScreen</span>

    <span class="pl-smi">String</span> viewPkgName <span class="pl-k">=</span> controllerPackage<span class="pl-k">.</span>substring(<span class="pl-c1">0</span>, controllerPackage<span class="pl-k">.</span>lastIndexOf(<span class="pl-s"><span class="pl-pds">"</span>.<span class="pl-pds">"</span></span>)) <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span>.view<span class="pl-pds">"</span></span>;
    <span class="pl-smi">String</span> fragmentClassName <span class="pl-k">=</span> viewPkgName <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span>.<span class="pl-pds">"</span></span>
            <span class="pl-k">+</span> controllerClass<span class="pl-k">.</span>getSimpleName()<span class="pl-k">.</span>replace(<span class="pl-s"><span class="pl-pds">"</span>Controller<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Screen<span class="pl-pds">"</span></span>);

    <span class="pl-k">try</span> {
        <span class="pl-k">return</span> (<span class="pl-k">Class&lt;? extends <span class="pl-smi">MvcFragment</span>&gt;</span>) <span class="pl-smi">Class</span><span class="pl-k">.</span>forName(fragmentClassName);
    } <span class="pl-k">catch</span> (<span class="pl-smi">ClassNotFoundException</span> e) {
        <span class="pl-smi">String</span> msg <span class="pl-k">=</span> <span class="pl-smi">String</span><span class="pl-k">.</span>format(<span class="pl-s"><span class="pl-pds">"</span>Fragment class(%s) for controller(%s) can not be found<span class="pl-pds">"</span></span>,
                fragmentClassName, controllerClass<span class="pl-k">.</span>getName());
        <span class="pl-k">throw</span> <span class="pl-k">new</span> <span class="pl-smi">RuntimeException</span>(msg, e);
    }
}</pre></div>

<h4>
<a id="continuity-between-screens" class="anchor" href="#continuity-between-screens" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Continuity between screens</h4>

<p>AndroidMvc has 3 different ways to ensure continuity between two consequent screens on navigation transition</p>

<ol>
<li>Shared injectable instances will be retained through the navigation transition. For example, when 2 controllers have the same type of manager injected the same instance of the manager from the first screen's controller will be retained for the second screen's controller. You can check out the <a href="https://github.com/kejunxia/AndroidMvc/tree/master/samples/simple-mvp">sample code</a>, in the <a href="https://github.com/kejunxia/AndroidMvc/blob/master/samples/simple-mvp/core/src/main/java/com/shipdream/lib/android/mvc/samples/simple/mvp/controller/CounterMasterController.java">CounterMasterController</a> there is an injected field called counterManager which is injected into <a href="https://github.com/kejunxia/AndroidMvc/blob/master/samples/simple-mvp/core/src/main/java/com/shipdream/lib/android/mvc/samples/simple/mvp/controller/CounterDetailController.java">CounterDetailController</a> as well. So when master controller navigate to detail controller, the state of the manager retains.</li>
<li>
<p>Just prepare the controller of the next screen just before navigation is taking place. In this case, the controller prepared will be injected into the next screen framgment.</p>

<div class="highlight highlight-source-java"><pre>navigationManager<span class="pl-k">.</span>navigate(<span class="pl-v">this</span>)<span class="pl-k">.</span>with(<span class="pl-smi">CounterDetailController</span><span class="pl-k">.</span>class, 
            <span class="pl-k">new</span> <span class="pl-k">Preparer&lt;<span class="pl-smi">CounterDetailController</span>&gt;</span>() {
        <span class="pl-k">@Override</span>
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">prepare</span>(<span class="pl-smi">CounterDetailController</span> <span class="pl-v">detailController</span>) {
            <span class="pl-c">//Set the initial state for the controller of the next screen</span>
            detailController<span class="pl-k">.</span>setCount(<span class="pl-c1">123</span>);
        }
    })<span class="pl-k">.</span>to(<span class="pl-smi">CounterDetailController</span><span class="pl-k">.</span>class);</pre></div>
</li>
<li>Hold an injected instance of the manager depending on the next screen in the controller held by the delegateFragment. DelegateFragment is a long life fragment in the single activity containing all other fragments, so its controller will referenced during the entire lifespan of the app UI comopnent. So the inject managers held by the controller remain during the whole app session. For example, AndroidMvc has already had an internal controller for the delegateFragment holding NavigationManager, so the navigationManager is singleton globally and live through the entire app life span. Another example is, you can have an AccountManager held by delegateFragment's controller so accountManager will span the entire app session to manage the logged in user.</li>
</ol>

<h4>
<a id="navigation-tool-bar" class="anchor" href="#navigation-tool-bar" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Navigation tool bar</h4>

<p>The screen fragment doesn't have to take the entire screen. For example, all screens can share the same toolbar just like the tranditional ActionBar.</p>

<p>More details can be found in the <a href="https://github.com/kejunxia/AndroidMvc/tree/master/samples/simple-mvp">Sample Code</a></p>

<h2>
<a id="run-asynctask-in-controller" class="anchor" href="#run-asynctask-in-controller" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Run AsyncTask in controller</h2>

<p>When a http request need to be sent or other long running actions need to be performed, they need to be run off the UI thread. To run an asyncTask in controllers, simply call </p>

<div class="highlight highlight-source-java"><pre><span class="pl-c">//In any controller method you can use below code to run async task</span>

<span class="pl-smi">Task</span><span class="pl-k">.</span><span class="pl-k">Monitor&lt;<span class="pl-smi">Void</span>&gt;</span> monitor <span class="pl-k">=</span> runTask(<span class="pl-k">new</span> <span class="pl-k">Task&lt;<span class="pl-smi">Void</span>&gt;</span>() {
    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-smi">Void</span> <span class="pl-en">execute</span>(<span class="pl-k">Monitor&lt;<span class="pl-smi">Void</span>&gt;</span> <span class="pl-v">monitor</span>) <span class="pl-k">throws</span> <span class="pl-smi">Exception</span> {
        <span class="pl-c">//Execute on Non-UI thread</span>
        <span class="pl-c">//When the view need to be updated here, you need use</span>
        <span class="pl-c">//uiThreadRunner to post it back to UI thread</span>

        <span class="pl-k">return</span> <span class="pl-c1">null</span>;
    }
}, <span class="pl-k">new</span> <span class="pl-smi">Task</span>.<span class="pl-k">Callback&lt;<span class="pl-smi">Void</span>&gt;</span>() {
    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onException</span>(<span class="pl-smi">Exception</span> <span class="pl-v">e</span>) <span class="pl-k">throws</span> <span class="pl-smi">Exception</span> {
        <span class="pl-c">//Handle exception</span>
        <span class="pl-c">//All callback methods are executed on UI thread</span>
    }
});

<span class="pl-c">//If you need to cancel unscheduled or executing task, call</span>
<span class="pl-c">//cancel against its monitor</span>
<span class="pl-k">boolean</span> canInterrupt <span class="pl-k">=</span> <span class="pl-c1">true</span>;
monitor<span class="pl-k">.</span>cancel(canInterrupt);</pre></div>

<p>As you see, runTask will give you a monitor which can be used to query the state of the task or cancel it if it has not started or interupt the currently executing task for example a downloading task.</p>

<p><strong>Tips</strong>:</p>

<ul>
<li>Only run async task in controllers to avoid blocking UI thread. All methods in managers or services should simply be synchrounous. Since managers and services are supposed to be consumed by controllers, when they are in use, controllers can choose invoke methods of managers and services on non-UI thread or not.</li>
<li>In the scope the Task.execute() every line is running in sequence. The callback.onScucess will be called until all lines in Task.execute() execute successfully otherwise, callback.onException is called.</li>
<li>
<p>You can run multiple long running methods in the same Task.execute() method. It's useful if you need to send some consequent http requests each is depending the previous response. So any one of the requests fails, it fails the entire task. See example:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-smi">Task</span><span class="pl-k">.</span><span class="pl-k">Monitor&lt;<span class="pl-smi">Void</span>&gt;</span> monitor <span class="pl-k">=</span> runTask(<span class="pl-k">new</span> <span class="pl-k">Task&lt;<span class="pl-smi">Void</span>&gt;</span>() {
    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-smi">Void</span> <span class="pl-en">execute</span>(<span class="pl-k">Monitor&lt;<span class="pl-smi">Void</span>&gt;</span> <span class="pl-v">monitor</span>) <span class="pl-k">throws</span> <span class="pl-smi">Exception</span> {
        <span class="pl-c">//Send login http request</span>
        <span class="pl-smi">Login</span> loginResponse <span class="pl-k">=</span> loginHttpService<span class="pl-k">.</span>login(username, password);

        <span class="pl-c">//use the token contained in loginResponse to send another http</span>
        <span class="pl-c">//request to register device to push notification services</span>
        <span class="pl-smi">Status</span> status <span class="pl-k">=</span> pushNotificationHttpService<span class="pl-k">.</span>register(deviceId, loginResponse<span class="pl-k">.</span>token());
        <span class="pl-k">return</span> <span class="pl-c1">null</span>;
    }
});</pre></div>
</li>
</ul>

<h2>
<a id="easy-unit-test" class="anchor" href="#easy-unit-test" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Easy Unit Test</h2>

<p>So far, you should have already got some ideas how much business logic can be written in controllers with AndroidMvc. <a href="https://github.com/kejunxia/AndroidMvc/tree/master/samples/simple-mvp/core/src/test/java/com/shipdream/lib/android/mvc/samples/simple/mvp/controller/internal">See sample unit tests here</a></p>

<h4>
<a id="mock-dependencies" class="anchor" href="#mock-dependencies" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Mock dependencies</h4>

<p>As most codes are wrapped in controllers without Android API dependencies. You can just simply test everything on JVM. Because in app, there are dependencies implemented with Android API which are lacking in the sole controller module, those dependencies' implementations need to be replaced by mocked instances. For example, every controller has an injected field - ExecutorService to run a aysncTask by 
controller.runTask(Task task). In unit test, this ExecutorService can be mocked and run task immediately on the same thread to mimic a http response with mocked data.</p>

<p>To override providers to replace injectable classes, 
1. create a MvcComponent say overridingComponent
2. register your providers to provider mocking objects
3. attach the overridingComponent to Mvc.graph().getRootComponent() with the </p>

<p>See the code sample below</p>

<div class="highlight highlight-source-java"><pre><span class="pl-c">//Mock executor service so that all async tasks run on non-UI thread in app will</span>
<span class="pl-c">//run on the testing thread (main thread for testing) to avoid multithreading headache</span>
executorService <span class="pl-k">=</span> mock(<span class="pl-smi">ExecutorService</span><span class="pl-k">.</span>class);

doAnswer(<span class="pl-k">new</span> <span class="pl-smi">Answer</span>() {
    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-smi">Object</span> <span class="pl-en">answer</span>(<span class="pl-smi">InvocationOnMock</span> <span class="pl-v">invocation</span>) <span class="pl-k">throws</span> <span class="pl-smi">Throwable</span> {
        <span class="pl-smi">Callable</span> runnable <span class="pl-k">=</span> (<span class="pl-smi">Callable</span>) invocation<span class="pl-k">.</span>getArguments()[<span class="pl-c1">0</span>];
        runnable<span class="pl-k">.</span>call();
        <span class="pl-smi">Future</span> future <span class="pl-k">=</span> mock(<span class="pl-smi">Future</span><span class="pl-k">.</span>class);
        when(future<span class="pl-k">.</span>isDone())<span class="pl-k">.</span>thenReturn(<span class="pl-c1">true</span>); <span class="pl-c">//by default execute immediately succeed.</span>
        when(future<span class="pl-k">.</span>isCancelled())<span class="pl-k">.</span>thenReturn(<span class="pl-c1">false</span>);
        <span class="pl-k">return</span> future;
    }
})<span class="pl-k">.</span>when(executorService)<span class="pl-k">.</span>submit(any(<span class="pl-smi">Callable</span><span class="pl-k">.</span>class));

overridingComponent <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">MvcComponent</span>(<span class="pl-s"><span class="pl-pds">"</span>TestOverridingComponent<span class="pl-pds">"</span></span>);
overridingComponent<span class="pl-k">.</span>register(<span class="pl-k">new</span> <span class="pl-smi">Object</span>(){
    <span class="pl-k">@Provides</span>
    <span class="pl-k">public</span> <span class="pl-smi">ExecutorService</span> <span class="pl-en">createExecutorService</span>() {
        <span class="pl-k">return</span> executorService;
    }
});

<span class="pl-c">//For base test class, allow sub test cases to register overriding providers</span>
prepareGraph(overridingComponent);

<span class="pl-smi">Component</span> rootComponent <span class="pl-k">=</span> <span class="pl-smi">Mvc</span><span class="pl-k">.</span>graph()<span class="pl-k">.</span>getRootComponent();

<span class="pl-c">//overriding indicates providers of this component attached to the root component will override </span>
<span class="pl-c">//existing providers managing to provide instances with the same type and qualifier.</span>
<span class="pl-k">boolean</span> overriding <span class="pl-k">=</span> <span class="pl-c1">true</span>;
rootComponent<span class="pl-k">.</span>attach(overridingComponent, overriding);</pre></div>

<h4>
<a id="mock-http-response" class="anchor" href="#mock-http-response" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Mock http response</h4>

<p>Below are some code snippets of mocking http traffic. More code can be found in the  <a href="https://github.com/kejunxia/AndroidMvc/tree/master/samples/simple-mvp">sample</a> in the project. The sample is using Retrofit for http resources.</p>

<ul>
<li>
<p><strong>Mock Successful http response</strong></p>

<div class="highlight highlight-source-java"><pre>@<span class="pl-smi">Test</span>
<span class="pl-k">public</span> <span class="pl-k">void</span> should_update_view_with_correct_ip_and_show_and_dismiss_progress_bar() throws <span class="pl-smi">Exception</span> {
    <span class="pl-c">//Prepare</span>
    <span class="pl-c">//Prepare a good http response</span>
    <span class="pl-k">final</span> <span class="pl-smi">String</span> fakeIpResult <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>abc.123.456.xyz<span class="pl-pds">"</span></span>;

    <span class="pl-smi">IpPayload</span> payload <span class="pl-k">=</span> mock(<span class="pl-smi">IpPayload</span><span class="pl-k">.</span>class);
    when(payload<span class="pl-k">.</span>getIp())<span class="pl-k">.</span>thenReturn(fakeIpResult);
    when(ipServiceCallMock<span class="pl-k">.</span>execute())<span class="pl-k">.</span>thenReturn(<span class="pl-smi">Response</span><span class="pl-k">.</span>success(payload));

    <span class="pl-c">//Action</span>
    controller<span class="pl-k">.</span>refreshIp();

    <span class="pl-c">//Verify</span>
    <span class="pl-c">//Showed loading progress</span>
    verify(view)<span class="pl-k">.</span>showProgress();
    <span class="pl-c">//Dismissed loading progress</span>
    verify(view)<span class="pl-k">.</span>hideProgress();
    <span class="pl-c">//Updated view's text view by the given fake ip result</span>
    verify(view)<span class="pl-k">.</span>updateIpValue(fakeIpResult);
    <span class="pl-c">//Should not show error message</span>
    verify(view, times(<span class="pl-c1">0</span>))<span class="pl-k">.</span>showHttpError(anyInt(), anyString());
    <span class="pl-c">//Should not show network error message</span>
    verify(view, times(<span class="pl-c1">0</span>))<span class="pl-k">.</span>showNetworkError(any(<span class="pl-smi">IOException</span><span class="pl-k">.</span>class));
}</pre></div>
</li>
<li>
<p><strong>Mock erred http response</strong></p>

<div class="highlight highlight-source-java"><pre>@<span class="pl-smi">Test</span>
<span class="pl-k">public</span> <span class="pl-k">void</span> should_show_error_message_on_HttpError_and_show_and_dismiss_progress_bar() throws <span class="pl-smi">Exception</span> {
    <span class="pl-c">//Prepare</span>
    <span class="pl-c">//Return 401 in the http response</span>
    <span class="pl-k">int</span> errorStatusCode <span class="pl-k">=</span> <span class="pl-c1">401</span>;
    <span class="pl-smi">ResponseBody</span> responseBody <span class="pl-k">=</span> mock(<span class="pl-smi">ResponseBody</span><span class="pl-k">.</span>class);
    when(ipServiceCallMock<span class="pl-k">.</span>execute())<span class="pl-k">.</span>thenReturn(
            <span class="pl-smi">Response</span><span class="pl-k">.</span><span class="pl-k">&lt;</span><span class="pl-smi">IpPayload</span><span class="pl-k">&gt;</span>error(errorStatusCode, responseBody));

    <span class="pl-c">//Action</span>
    controller<span class="pl-k">.</span>refreshIp();

    <span class="pl-c">//Verify</span>
    <span class="pl-c">//Showed loading progress</span>
    verify(view)<span class="pl-k">.</span>showProgress();
    <span class="pl-c">//Dismissed loading progress</span>
    verify(view)<span class="pl-k">.</span>hideProgress();
    <span class="pl-c">//View's ip address text view should not be updated</span>
    verify(view, times(<span class="pl-c1">0</span>))<span class="pl-k">.</span>updateIpValue(anyString());
    <span class="pl-c">//Should show http error message with given mocking data</span>
    verify(view, times(<span class="pl-c1">1</span>))<span class="pl-k">.</span>showHttpError(errorStatusCode, <span class="pl-c1">null</span>);
    <span class="pl-c">//Should not show network error message</span>
    verify(view, times(<span class="pl-c1">0</span>))<span class="pl-k">.</span>showNetworkError(any(<span class="pl-smi">IOException</span><span class="pl-k">.</span>class));
}</pre></div>
</li>
<li>
<p><strong>Mock network error</strong></p>

<div class="highlight highlight-source-java"><pre>@<span class="pl-smi">Test</span>
<span class="pl-k">public</span> <span class="pl-k">void</span> should_show_error_message_on_NetworkError_and_show_and_dismiss_progress_bar() throws <span class="pl-smi">Exception</span> {
    <span class="pl-c">//Prepare</span>
    <span class="pl-c">//Throw an IOException to simulate an network error</span>
    <span class="pl-smi">IOException</span> ioExceptionMock <span class="pl-k">=</span> mock(<span class="pl-smi">IOException</span><span class="pl-k">.</span>class);
    when(ipServiceCallMock<span class="pl-k">.</span>execute())<span class="pl-k">.</span>thenThrow(ioExceptionMock);

    <span class="pl-c">//Action</span>
    controller<span class="pl-k">.</span>refreshIp();

    <span class="pl-c">//Verify</span>
    <span class="pl-c">//Showed loading progress</span>
    verify(view)<span class="pl-k">.</span>showProgress();
    <span class="pl-c">//Dismissed loading progress</span>
    verify(view)<span class="pl-k">.</span>hideProgress();
    <span class="pl-c">//View's ip address text view should not be updated</span>
    verify(view, times(<span class="pl-c1">0</span>))<span class="pl-k">.</span>updateIpValue(anyString());
    <span class="pl-c">//Should not show http error message</span>
    verify(view, times(<span class="pl-c1">0</span>))<span class="pl-k">.</span>showHttpError(anyInt(), anyString());
    <span class="pl-c">//Should show network error message with the given mocking exception</span>
    verify(view, times(<span class="pl-c1">1</span>))<span class="pl-k">.</span>showNetworkError(ioExceptionMock);
}</pre></div>
</li>
</ul>

<h2>
<a id="event-bus" class="anchor" href="#event-bus" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Event Bus</h2>

<p>There are event buses built in the framework can be used straight away. </p>

<ul>
<li><strong>Event bus object can be injected by <a href="https://github.com/Inject" class="user-mention">@Inject</a> as a field of a class.</strong></li>
<li>
<strong>There are two event buses in the framework. Both event buses are singleton app wide.</strong>

<ul>
<li>
<strong>EventBusC</strong>: Routes events to non-view objects. Events on this bus usually come from non-Android module(see <a href="https://github.com/kejunxia/AndroidMvc/tree/master/samples/simple-mvp">core module in the the sample</a>). Events on the bus will be <strong>observed on the same thread</strong> that the invoker is running. </li>
<li>
<strong>EventBusV</strong>: Routes events to view/android objects such as activity, fragment, services and etc. Events on the bus will be guaranteed to be <strong>observed on the UI thread</strong> automatically by the framework.<br>
</li>
</ul>
</li>
<li>
<p><strong>Event buses above can be injected with qualifiers.</strong></p>

<div class="highlight highlight-source-java"><pre>@<span class="pl-smi">Inject</span>
@<span class="pl-smi">EventBusC</span>
<span class="pl-k">private</span> <span class="pl-smi">EventBus</span> eventBusC;

@<span class="pl-smi">Inject</span>
@<span class="pl-smi">EventBusV</span>
<span class="pl-k">private</span> <span class="pl-smi">EventBus</span> eventBusV;</pre></div>
</li>
<li>
<p><strong>Events are defined by a class type.</strong> It's recommended to define it as enclosed class if it's closely related to the class. As a result, the observer knows what events are for what. For example, </p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">UserManager</span> {
    <span class="pl-k">interface</span> <span class="pl-en">Event</span> {
        <span class="pl-k">class</span> <span class="pl-en">OnUserLoggedIn</span>{
        }
    }

    <span class="pl-c">//...</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">func</span>() {
        eventBus<span class="pl-k">.</span>post(<span class="pl-k">new</span> <span class="pl-smi">Event</span>.<span class="pl-smi">OnUserLoggedIn</span>());
    }
}</pre></div>
</li>
<li>
<strong>Events can have their own arguments.</strong> For example,
<code>java
class OnUserLoggedIn {
    private final User user;
    public OnUserLoggedIn(User user) {
        this.user = user;
    }
    public User getUser() {
        return user;
    }
}
</code>
</li>
<li>
<p><strong>Sender as an argument in an event is a good practice.</strong> To define a sender argument in an event is useful to distiguish who initiate the request results in this event. For example, when refreshing a list view, you may need different logic to handle the requests caused by </p>

<ul>
<li>User interaction. e.g. pull to refresh</li>
<li>Some internal state change. e.g. a polling every 3 seconds</li>
</ul>

<p>In this case, define a sender argument in the event class. Then when observers receive the event they know who initially request the refresh and handle differently.</p>
</li>
<li>
<strong>Events are observed by methods with naming convention.</strong> To subscribe an event by declaring a method called <strong>onEvent</strong> with <strong>one argument</strong> in the class type of the event. The name of the event doesn't matter. For example
<code>java
public class OneView {
    //Observe event OnListViewRefreshed.
    private void onEvent(OnListViewRefreshed event) {
        //handle event
    }
}
</code>
</li>
<li>
<p><strong>Event bus needs to be registered to observe event</strong> by calling EventBus.register(Object observer). However, these pre-defined Mvc objects register by themselves so you don't need to worry about to registering by using them. Just define your onEvent methods to subscribe. These objects are:</p>

<ul>
<li>
<strong>MvcActivity</strong> registers to <strong>EventBusV</strong> when created</li>
<li>
<strong>MvcFragment</strong> registers to <strong>EventBusV</strong> when created</li>
<li>
<strong>MvcService</strong> registers to <strong>EventBusV</strong> when created</li>
<li>
<strong>Controller</strong> registers to <strong>EventBusC</strong> when injected for the first time</li>
<li>
<strong>Manager</strong> registers to <strong>EventBusC</strong> when injected for the first time</li>
</ul>

<p>If you have your own objects need to observe a event bus, just call EventBus.register(Object observer) when they are created. Also it's better to unregister them when the obsever is not used any more. This can be done in onDestroy life cycle.</p>
</li>
</ul>

<p>Below is a code snippet. Note that the code is not complete to run but just for demostrating how to use event bus</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">OneView</span> {
    <span class="pl-k">@Inject</span>
    <span class="pl-k">private</span> <span class="pl-smi">OneController</span> onController;

    <span class="pl-k">private</span> <span class="pl-smi">Button</span> refreshButton;

    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onCreated</span>() {
        eventBusV<span class="pl-k">.</span>register(<span class="pl-v">this</span>);

        refreshButton<span class="pl-k">.</span>setOnClickListener(<span class="pl-k">new</span> <span class="pl-smi">View</span>.<span class="pl-smi">OnClickListener</span>() {
            <span class="pl-k">@Override</span>
            <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onClick</span>(<span class="pl-smi">View</span> <span class="pl-v">refreshButton</span>) {
                onController<span class="pl-k">.</span>refresh(refreshButton);
            }
        });
    }

    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onDestroy</span>() {
        eventBusV<span class="pl-k">.</span>unregister(<span class="pl-v">this</span>);
    }

    <span class="pl-c">//Observe event OnListViewRefreshed from OneController</span>
    <span class="pl-c">//It runs on UI thread automatically</span>
    <span class="pl-k">private</span> <span class="pl-k">void</span> <span class="pl-en">onEvent</span>(<span class="pl-smi">OneController</span>.<span class="pl-smi">Event</span>.<span class="pl-smi">OnListViewRefreshed</span> <span class="pl-v">event</span>) {
        <span class="pl-k">if</span> (event<span class="pl-k">.</span>getSender() <span class="pl-k">==</span> refreshButton) {
            <span class="pl-c">//refreshed by user interaction of pressing the refresh button</span>
            <span class="pl-c">//so if erred, it's better to show error message</span>
        } <span class="pl-k">else</span> {
            <span class="pl-c">//should by something else, e.g. controller wants to refresh for some </span>
            <span class="pl-c">//reason</span>
            <span class="pl-c">//In this case, error message may not have to be shown</span>
        }

        <span class="pl-c">//refresh the list view</span>
    }
}

<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">OneController</span> <span class="pl-k">extends</span> <span class="pl-e">Controller</span>{
    <span class="pl-k">interface</span> <span class="pl-en">Event</span> {
        <span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">OnListViewRefreshed</span> {
            <span class="pl-k">private</span> <span class="pl-k">final</span> <span class="pl-smi">Object</span> sender;
            <span class="pl-k">public</span> <span class="pl-en">OnListViewRefreshed</span>(<span class="pl-smi">Object</span> <span class="pl-v">sender</span>) {
                <span class="pl-v">this</span><span class="pl-k">.</span>sender <span class="pl-k">=</span> sender;
            }

            <span class="pl-k">public</span> <span class="pl-smi">Object</span> <span class="pl-en">getSender</span>() {
                <span class="pl-k">return</span> sender;
            }
        }
    }

    <span class="pl-k">@Inject</span>
    <span class="pl-k">private</span> <span class="pl-smi">NavigationManager</span> navigateManager;

    <span class="pl-k">@Inject</span>
    <span class="pl-k">@EventBusV</span>
    <span class="pl-k">private</span> <span class="pl-smi">EventBus</span> eventBusV; <span class="pl-c">//Framework guarantees the event will be posted to UI thread</span>

    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">refresh</span>(<span class="pl-k">final</span> <span class="pl-smi">Object</span> <span class="pl-v">sender</span>) {
        runTask(<span class="pl-k">new</span> <span class="pl-smi">Task</span>() {
            <span class="pl-k">@Override</span>
            <span class="pl-k">public</span> <span class="pl-smi">Object</span> <span class="pl-en">execute</span>(<span class="pl-smi">Monitor</span> <span class="pl-v">monitor</span>) <span class="pl-k">throws</span> <span class="pl-smi">Exception</span> {
                <span class="pl-c">//Pull data from http server</span>
                <span class="pl-c">//...</span>
                <span class="pl-c">//</span>

                <span class="pl-c">//successful and post event</span>
                <span class="pl-c">//Though execute method is run on non-Ui thread,</span>
                <span class="pl-c">//eventBusV will guarantee the observer will receive the event onto</span>
                <span class="pl-c">//UI thread</span>
                eventBusV<span class="pl-k">.</span>post(<span class="pl-k">new</span> <span class="pl-smi">Event</span>.<span class="pl-smi">OnListViewRefreshed</span>(sender));
                <span class="pl-k">return</span> <span class="pl-c1">null</span>;
            }
        });
    }

    <span class="pl-c">//Observe logged on event from UserManager</span>
    <span class="pl-k">private</span> <span class="pl-k">void</span> <span class="pl-en">onEvent</span>(<span class="pl-smi">UserManager</span>.<span class="pl-smi">Event</span>.<span class="pl-smi">OnLoggedOut</span> <span class="pl-v">event</span>) {
        <span class="pl-c">//...</span>
        <span class="pl-c">//User logged out</span>

        navigateManager<span class="pl-k">.</span>navigate(<span class="pl-v">this</span>)<span class="pl-k">.</span>to(<span class="pl-smi">LoginController</span><span class="pl-k">.</span>class, <span class="pl-k">new</span> <span class="pl-smi">Forwarder</span>()<span class="pl-k">.</span>clearAll());
    }
}

<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">UserManager</span> {
    <span class="pl-k">interface</span> <span class="pl-en">Event</span> {
        <span class="pl-k">class</span> <span class="pl-en">OnLoggedOut</span>{
            <span class="pl-k">private</span> <span class="pl-k">final</span> <span class="pl-smi">Object</span> sender;
            <span class="pl-k">public</span> <span class="pl-en">OnLoggedOut</span>(<span class="pl-smi">Object</span> <span class="pl-v">sender</span>) {
                <span class="pl-v">this</span><span class="pl-k">.</span>sender <span class="pl-k">=</span> sender;
            }

            <span class="pl-k">public</span> <span class="pl-smi">Object</span> <span class="pl-en">getSender</span>() {
                <span class="pl-k">return</span> sender;
            }
        }
    }

    <span class="pl-k">@Inject</span>
    <span class="pl-k">@EventBusC</span>
    <span class="pl-k">private</span> <span class="pl-smi">EventBus</span> eventBusC; 

    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">setCurrentUser</span>(<span class="pl-smi">Object</span> <span class="pl-v">sender</span>, <span class="pl-smi">User</span> <span class="pl-v">user</span>) {
        <span class="pl-c">//... </span>

        <span class="pl-c">//EventBusC post event to the thread that the invoker calling setCurrentUser </span>
        <span class="pl-c">//is running on</span>
        eventBusC<span class="pl-k">.</span>post(<span class="pl-k">new</span> <span class="pl-smi">Event</span>.<span class="pl-smi">OnLoggedOut</span>(sender));
    }
}</pre></div>

<h2>
<a id="instance-state-management" class="anchor" href="#instance-state-management" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Instance State Management</h2>

<p>Instance state management in standard Android SDK is painful. It requires defining countless key-value pairs. No mention to create Paracelable needs to write a lot of boilerplate code and it's error prone.</p>

<p>AndroidMvc framework manages the state automatically. Since a controller represents a view in abstraction so it has a property called model to contain the state of its view. AndroidMvc just getModel() and serialise it when the app is pushed to background and deserialise the model and bind it to the controller and view automatically. This is why you just need to bind the view in UiView.update() method and then no matter the view is newly created or restored, it's always reflecting the latest state of the model managed by the view's controller. Review <a href="#-Implement-MVC/MVP/MVVM-pattern">Implement MVC/MVP/MVVM pattern</a> to check the patterns.</p>

<p>Also not just controllers manage their state automatically, managers, services and any injected objects extending Bean(#<a href="https://github.com/kejunxia/AndroidMvc/blob/master/library/android-mvc-core/src/main/java/com/shipdream/lib/android/mvc/Bean.java">https://github.com/kejunxia/AndroidMvc/blob/master/library/android-mvc-core/src/main/java/com/shipdream/lib/android/mvc/Bean.java</a>) and returns non-null class type in its method modelType() will be automatically managed. See more details about Bean.java and injection in section <a href="#Dependency-injection-(Poke)">Dependency injection</a></p>

<h2>
<a id="dependency-injection-poke" class="anchor" href="#dependency-injection-poke" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Dependency injection (Poke)</h2>

<p>The framework has a built in dependency injection called <strong>Poke</strong>. 
Why reinvent the wheel?</p>

<ul>
<li>The main reason is to incorporate with <a href="http://kejunxia.github.io/AndroidMvc/">AndroidMvc</a> framework, it needs to do <strong>reference count</strong>. Since <a href="http://kejunxia.github.io/AndroidMvc/">AndroidMvc</a> automatically saves and restores state of controllers, when a controller is not used its state won't need to be managed any more. So <a href="http://kejunxia.github.io/AndroidMvc/">AndroidMvc</a> needs to know when a controller is not referenced.</li>
<li>Another reason: In Dagger, a lot of boiler plate code still needs to be done. This definitely minimizes run time overhead for injection but there are just two much codes. And you need to remember to declare you injection. It's almost like writting a setter or inject method for each injectable class and then we need to manually set or inject objects.</li>
</ul>

<p>To find the balance between simpler code and runtime performance, <strong>Poke</strong> can use naming convention to automatically locate implementations. So we don't need to repeatedly declare implementations by writing in <strong>real</strong> application with. However, <strong>Poke</strong> also allows registering implementation manually. This is helpful either for dynamical replacement of implementations or mocking injectable dependencies in unit tests.</p>

<ul>
<li><a href="https://github.com/kejunxia/AndroidMvc/tree/master/samples/poke-sample">See sample here</a></li>
<li><a href="https://github.com/kejunxia/AndroidMvc/tree/master/samples/benchmark">See the benchmark app</a></li>
</ul>

<h4>
<a id="bean" class="anchor" href="#bean" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Bean</h4>

<p>Classes and interfaces can be injected with the their instances. There are some classes can be injected with some special behaviours. These classes are called beans. A <a href="https://github.com/kejunxia/AndroidMvc/blob/master/library/android-mvc-core/src/main/java/com/shipdream/lib/android/mvc/Bean.java">Bean</a> is an object 
1. has life cycles. When a bean is created by the first injection, its method <strong>onCreated</strong> will be called. When a bean is released by the last object it was injected into, it method <strong>onDestroy</strong> will be called. 
2. has a model. A model contains the state of the bean that can be serialised and deserialised. So the bean's state can be saved and restored during the Android's activity and fragment's life cycles.</p>

<p>In AndroidMvc framework there are a couple of pre-defined beans</p>

<ul>
<li><a href="https://github.com/kejunxia/AndroidMvc/blob/master/library/android-mvc-core/src/main/java/com/shipdream/lib/android/mvc/Controller.java">Controllers</a></li>
<li>
<a href="https://github.com/kejunxia/AndroidMvc/blob/master/library/android-mvc-core/src/main/java/com/shipdream/lib/android/mvc/Manager.java">Managers</a>
So controllers and managers(can be thought as partial controller that are shared by controllers) will have their life cycle and be automatically saved and restored. And you can define you own beans without any restrictions. Just simply make the class extend the Bean class. </li>
</ul>

<p>If you want to use an interface as a bean, just extend bean class in its implementation.</p>

<h4>
<a id="architecture" class="anchor" href="#architecture" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Architecture</h4>

<p>Below are the main parts to inject objects</p>

<ul>
<li>
<strong>Providers</strong> provide instances. Providers can be registered to component.</li>
<li>
<p><strong>Components</strong> contain providers. Components can also the attached to other components to form a component tree. </p>

<ul>
<li>
<strong>Scope</strong> A component has a cache to cache instances provided by providers held by the component. So providers are <strong>singleton</strong> in the scope of a component. You can set the cache of a component to be null. Then the providers in this component will always create new instances. </li>
<li>By default, a component tree can only have unique provider providing instances with a specific class type and qualifier. Registering a provider to a component tree with duplicate to provide instance of type and qualifier already existing will throw exceptions.</li>
<li>
<p>But you can explicitly declare you want to register a provider overriding the existing providers with the same class type and qualifier in the component tree. Last overriding provider registered wins.</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">boolean</span> overriding <span class="pl-k">=</span> <span class="pl-c1">true</span>;
rootComponent<span class="pl-k">.</span>attach(overridingComponent, overriding);</pre></div>
</li>
</ul>
</li>
<li>
<strong>Graph</strong> A graph is used to inject instances into target objects. A graph has a root component with providers or its child components providers to provide instances to be injected. Usually an application should have only one graph. So by default, providers registered to the root component of the graph is Singleton globally. To have different scope, simply manage your own components and attach/detach them to/from the root components of the graph. Providers of these components will be singleton until the components are detached from the graph.</li>
</ul>

<h4>
<a id="how-to-inject" class="anchor" href="#how-to-inject" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>How to inject</h4>

<p>With poke and AndroidMvc, to inject an instance is easy. It doesn't need to declare  what needs to don't need to  Below we will explore how to inject in different scenarios.</p>

<ul>
<li>
<p>Inject an instance of a concrete class</p>

<p>AndroidMvc automatically inject concrete classes that have an empty default constructors.</p>

<div class="highlight highlight-source-java"><pre>  <span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">Break</span> {
      <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">slow</span>(<span class="pl-smi">Car</span> <span class="pl-v">car</span>) {
          car<span class="pl-k">.</span>setSpeed(car<span class="pl-k">.</span>getSpeed() <span class="pl-k">-</span> <span class="pl-c1">1</span>);
      }
  }
  <span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">Car</span> {
      <span class="pl-k">@Inject</span>
      <span class="pl-k">private</span> <span class="pl-smi">Break</span> aBreak;
      <span class="pl-k">private</span> <span class="pl-k">float</span> speed;
      <span class="pl-k">public</span> <span class="pl-k">float</span> <span class="pl-en">getSpeed</span>() {
          <span class="pl-k">return</span> speed;
      }
      <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">setSpeed</span>(<span class="pl-k">float</span> <span class="pl-v">speed</span>) {
          <span class="pl-v">this</span><span class="pl-k">.</span>speed <span class="pl-k">=</span> speed;
      }
      <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">decelerate</span>() {
          aBreak<span class="pl-k">.</span>slow(<span class="pl-v">this</span>);
      }
  }
  @<span class="pl-smi">Test</span>
  <span class="pl-k">public</span> <span class="pl-k">void</span> run_car_with_default_components() {
      <span class="pl-smi">Car</span> car <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">Car</span>();
      <span class="pl-smi">Mvc</span><span class="pl-k">.</span>graph()<span class="pl-k">.</span>inject(car);
      car<span class="pl-k">.</span>decelerate();
  }</pre></div>
</li>
<li>
<p>Inject an instance of an interface or abstract class</p>

<p>By default, AndroidMvc will look for implementation class of interface or abstract class in the sub package <strong>"internal"</strong> at the same level of the package of the interface or abstract class. The implementation class should have the same name of the interface or abstract class but with a suffix <strong>"impl"</strong>. And the rest steps to inject an instance of an interface or an abstract class is exactly the same as injecting a concrete class as above.
For example, when we have an interface called Engine under package com.xyz. To let AndroidMvc find its implementation automatically, the concrete class should call Engine<strong>Impl</strong> and resides under com.xyz.<strong>internal</strong>*. See the file structure below</p>

<pre><code>  --com
    --xyz
      Engine.java
      --internal
        EngineImpl.java
</code></pre>
</li>
<li>
<p>Customise providers</p>

<p>You can also register a provider to a component attached to the graph. Or register an object with methods annotated by <a href="https://github.com/Provides" class="user-mention">@Provides</a> to provide instance.</p>

<div class="highlight highlight-source-java"><pre>  <span class="pl-smi">MvcComponent</span> testComponent <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">MvcComponent</span>(<span class="pl-s"><span class="pl-pds">"</span>TestComponent<span class="pl-pds">"</span></span>);

  <span class="pl-c">//Register new providers with better v8 engine and racing break</span>
  testComponent<span class="pl-k">.</span>register(<span class="pl-k">new</span> <span class="pl-smi">Object</span>(){
      <span class="pl-k">@Provides</span>
      <span class="pl-k">public</span> <span class="pl-smi">Engine</span> <span class="pl-en">v8Engine</span>() {
          <span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-smi">Engine</span>() {
              <span class="pl-k">@Override</span>
              <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">push</span>(<span class="pl-smi">Car</span> <span class="pl-v">car</span>) {
                  car<span class="pl-k">.</span>setSpeed(car<span class="pl-k">.</span>getSpeed() <span class="pl-k">+</span> <span class="pl-c1">3</span>);
              }
          };
      }

      <span class="pl-k">@Provides</span>
      <span class="pl-k">public</span> <span class="pl-smi">Break</span> <span class="pl-en">racingBreak</span>() {
          <span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-smi">Break</span>() {
              <span class="pl-k">@Override</span>
              <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">slow</span>(<span class="pl-smi">Car</span> <span class="pl-v">car</span>) {
                  car<span class="pl-k">.</span>setSpeed(car<span class="pl-k">.</span>getSpeed() <span class="pl-k">-</span> <span class="pl-c1">2.5f</span>);
              }
          };
      }
  });</pre></div>
</li>
<li>
<p>Override existing providers</p>

<p>Registering providers providing classes for same signature of class (same class type and qualifier) will result in throwing out exceptions since AndroidMvc won't be able to figure out which provider should be used. But the you can implicitly inform AndroidMvc you want to override providers with code like below</p>

<div class="highlight highlight-source-java"><pre>  <span class="pl-c">//Attach the component to the graph's root component to override default providers</span>
  <span class="pl-k">boolean</span> overrideExistingProviders <span class="pl-k">=</span> <span class="pl-c1">true</span>;
  <span class="pl-smi">Mvc</span><span class="pl-k">.</span>graph()<span class="pl-k">.</span>getRootComponent()<span class="pl-k">.</span>attach(testComponent, overrideExistingProviders);</pre></div>
</li>
</ul>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/kejunxia/AndroidMvc">Android Mvc Framework</a> is maintained by <a href="https://github.com/kejunxia">kejunxia</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

            <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-21820164-19");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
